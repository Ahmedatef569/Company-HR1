<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Management System - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Tailwind gray-50 */
        }
        /* Style for active sidebar link */
        .sidebar-link.active {
            background-color: #e0f2fe; /* Tailwind sky-100 */
            color: #0ea5e9; /* Tailwind sky-500 */
            font-weight: 600;
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Custom styling for Flatpickr */
        .flatpickr-calendar {
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
        }
        /* Custom table styling */
        thead th {
            background-color: #f1f5f9; /* Tailwind slate-100 */
            position: sticky;
            top: 0;
            z-index: 10;
        }
        /* Ensure table container allows scrolling */
        .table-container {
            max-height: none; /* Allow tables to be as tall as needed */
            overflow: auto; /* Enable both horizontal and vertical scrolling */
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
        }

        /* Make table headers sticky */
        .table-container thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #2563eb !important;
            color: white !important;
        }

        /* Ensure table cells don't wrap and have proper padding */
        .table-container td,
        .table-container th {
            white-space: nowrap;
            padding: 0.75rem 1rem;
        }
         /* Center login form */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e5e7eb; /* Tailwind gray-200 */
        }
        /* Fixed height for chart containers */
        .chart-container {
            height: 18rem; /* Approx h-72 */
            position: relative; /* Needed for Chart.js responsiveness */
            width: 100%;
            margin-bottom: 1rem;
        }

        /* Ensure charts are visible */
        canvas {
            max-width: 100%;
            max-height: 100%;
        }

        /* Simplified Time Selection Styles */
        .clock-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }

        .clock-modal-content {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 350px;
            max-width: 90vw;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .clock-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .clock-modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .clock-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .clock-modal-close:hover {
            color: #4f46e5;
        }

        .hour-button {
            background-color: #f3f4f6;
            color: #1f2937;
            border: none;
            border-radius: 8px;
            padding: 10px 0;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .hour-button:hover {
            background-color: #e5e7eb;
            transform: translateY(-2px);
        }

        .hour-button.selected {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3);
        }

        .hour-button:active {
            transform: translateY(0);
        }
    </style>
</head>
<body class="overflow-hidden"> <div id="login-screen" class="login-container">
        <div class="bg-white p-8 md:p-12 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-center items-center mb-8">
                <div class="bg-indigo-600 p-3 rounded-lg shadow-lg">
                    <i class="fas fa-users text-white text-4xl"></i>
                </div>
                <div class="ml-3">
                    <h1 class="text-2xl font-bold text-indigo-600">HR System</h1>
                    <p class="text-sm text-gray-500">Employee Management</p>
                </div>
            </div>
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">HR System Login</h2>
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="username" name="username" required
                           class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Enter username">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" name="password" required
                           class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Enter password">
                </div>
                <div id="login-error" class="text-red-500 text-sm mb-4 text-center hidden">
                    Invalid username or password.
                </div>
                <button type="submit"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-md shadow transition duration-150">
                    Login
                </button>
            </form>
             <p class="text-xs text-center text-gray-500 mt-6">
                <strong>Admin account:</strong> username: admin / password: admin123
                <br>
                <strong>Employee accounts:</strong> username: [employee email] / password: user123
                <br>
                <strong class="text-red-600">Note: This login is for demonstration only and is not secure.</strong>
            </p>
        </div>
    </div>

    <div id="app-container" class="flex h-screen overflow-hidden hidden">
        <!-- Mobile menu button -->
        <div class="fixed top-4 left-4 z-20 md:hidden">
            <button id="mobile-menu-button" class="bg-white p-2 rounded-md shadow-md text-gray-700 hover:bg-gray-100">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </div>

        <div class="flex w-full h-full">
            <aside id="sidebar" class="w-64 bg-white shadow-md flex flex-col no-scrollbar overflow-y-auto fixed md:sticky top-0 h-full z-10 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
                <div class="p-6 text-2xl font-bold text-gray-700 border-b flex justify-between items-center">
                    <span>Company HR</span>
                    <button id="close-sidebar" class="md:hidden text-gray-500 hover:text-gray-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <nav class="mt-6 flex-1">
                    <ul>
                        <li>
                            <a href="#" id="nav-dashboard" class="sidebar-link active flex items-center px-6 py-3 text-gray-600 hover:bg-gray-100 transition duration-150" onclick="showSection('dashboard')">
                                <i class="fas fa-tachometer-alt w-5 mr-3"></i> Dashboard
                            </a>
                        </li>
                        <li>
                            <a href="#" id="nav-database" class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-100 transition duration-150" onclick="showSection('database')">
                                <i class="fas fa-users w-5 mr-3"></i> Employee Database
                            </a>
                        </li>
                        <li>
                            <a href="#" id="nav-leaves" class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-100 transition duration-150" onclick="showSection('leaves')">
                                <i class="fas fa-calendar-alt w-5 mr-3"></i> Employee Leaves
                            </a>
                        </li>
                        <li>
                            <a href="#" id="nav-excuses" class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-100 transition duration-150" onclick="showSection('excuses')">
                                <i class="fas fa-clock w-5 mr-3"></i> Employee Excuses
                            </a>
                        </li>
                        <li>
                            <a href="#" id="nav-overtime" class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-100 transition duration-150" onclick="showSection('overtime')">
                                <i class="fas fa-business-time w-5 mr-3"></i> Employee Overtime
                            </a>
                        </li>
                        <li>
                            <a href="#" id="nav-penalties" class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-100 transition duration-150" onclick="showSection('penalties')">
                                <i class="fas fa-exclamation-triangle w-5 mr-3"></i> Employee Penalties
                            </a>
                        </li>
                        <li>
                            <a href="#" id="nav-salary" class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-100 transition duration-150" onclick="showSection('salary')">
                                <i class="fas fa-dollar-sign w-5 mr-3"></i> Salary Details
                            </a>
                        </li>
                        <li>
                            <a href="#" id="nav-payroll" class="sidebar-link flex items-center px-6 py-3 bg-yellow-100 text-red-600 font-bold hover:bg-gray-100 transition duration-150" onclick="showSection('payroll')">
                                <i class="fas fa-money-bill-wave w-5 mr-3"></i> Payroll
                            </a>
                        </li>
                        <li>
                            <a href="#" id="nav-settings" class="sidebar-link flex items-center px-6 py-3 text-gray-600 hover:bg-gray-100 transition duration-150" onclick="showSection('settings')">
                                <i class="fas fa-cog w-5 mr-3"></i> Settings
                            </a>
                        </li>
                    </ul>
                </nav>
                <div class="p-6 border-t">
                    <button onclick="logout()" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </button>
                </div>
            </aside>

            <main class="flex-1 overflow-y-auto p-4 md:p-8 bg-gray-50 relative">
                <!-- Notification Bell -->
                <div class="absolute top-4 right-4 z-20">
                    <div class="relative">
                        <button id="notification-bell" class="bg-white p-2 rounded-full shadow-md text-gray-700 hover:bg-gray-100 focus:outline-none">
                            <i class="fas fa-bell text-xl"></i>
                            <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                        </button>
                        <div id="notification-dropdown" class="absolute right-0 mt-2 w-80 bg-white rounded-md shadow-lg overflow-hidden z-20 hidden">
                            <div class="py-2 px-3 bg-indigo-600 text-white font-semibold flex justify-between items-center">
                                <span>Notifications</span>
                                <button id="mark-all-read" class="text-xs bg-indigo-700 hover:bg-indigo-800 px-2 py-1 rounded">
                                    Mark all as read
                                </button>
                            </div>
                            <div id="notification-list" class="max-h-96 overflow-y-auto">
                                <!-- Notifications will be populated here -->
                                <div class="py-8 text-center text-gray-500">
                                    <i class="fas fa-bell-slash text-2xl mb-2"></i>
                                    <p>No notifications</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            <section id="dashboard" class="space-y-8">
                <h1 class="text-3xl font-bold text-gray-800">Dashboard</h1>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label for="dept-filter-dash" class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                        <select id="dept-filter-dash" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="all">All Departments</option>
                            </select>
                    </div>
                    <div>
                        <label for="pos-filter-dash" class="block text-sm font-medium text-gray-700 mb-1">Position</label>
                        <select id="pos-filter-dash" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="all">All Positions</option>
                             </select>
                    </div>
                    <div>
                        <label for="status-filter-dash" class="block text-sm font-medium text-gray-700 mb-1">Employment Status</label>
                        <select id="status-filter-dash" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="all">All Statuses</option>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="dashboard-filter-btn" onclick="handleDashboardFilter(this);" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                            <i class="fas fa-filter mr-1"></i> Apply Filters
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition duration-150">
                        <h3 class="text-sm font-medium text-gray-500">Total Employees</h3>
                        <p id="stat-total-employees" class="mt-1 text-3xl font-semibold text-gray-900">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition duration-150">
                        <h3 class="text-sm font-medium text-gray-500">Active Employees</h3>
                        <p id="stat-active-employees" class="mt-1 text-3xl font-semibold text-green-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition duration-150">
                        <h3 class="text-sm font-medium text-gray-500">Avg. Leaves/Dept</h3>
                        <p id="stat-avg-leaves" class="mt-1 text-3xl font-semibold text-blue-600">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition duration-150">
                        <h3 class="text-sm font-medium text-gray-500">Turnover Rate</h3>
                        <p id="stat-turnover" class="mt-1 text-3xl font-semibold text-red-600">0%</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Employees per Department</h3>
                        <div class="chart-container">
                             <canvas id="deptChart"></canvas>
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Gender Distribution</h3>
                         <div class="chart-container">
                            <canvas id="genderChart"></canvas>
                         </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Employee Level Distribution</h3>
                         <div class="chart-container">
                            <canvas id="levelChart"></canvas>
                         </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Leaves per Department</h3>
                         <div class="chart-container">
                            <canvas id="leavesDeptChart"></canvas>
                         </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Age Distribution</h3>
                         <div class="chart-container">
                            <canvas id="ageChart"></canvas>
                         </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">YTD Hires vs Resigns (Monthly)</h3>
                         <div class="chart-container">
                            <canvas id="monthlyHiringChart"></canvas>
                         </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow lg:col-span-2">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Hiring vs Resigns Trends</h3>
                         <div class="chart-container">
                            <canvas id="hiringChart"></canvas>
                         </div>
                    </div>
                </div>
            </section>

            <section id="database" class="hidden space-y-6">
                <h1 class="text-3xl font-bold text-gray-800">Employee Database</h1>

                <div class="bg-white p-4 rounded-lg shadow flex flex-wrap gap-4 items-end">
                    <div class="flex-grow">
                        <label for="search-db" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                        <input type="text" id="search-db" placeholder="Search by name, code, position..." class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="dept-filter-db" class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                        <select id="dept-filter-db" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="all">All</option>
                            </select>
                    </div>
                    <div>
                        <label for="status-filter-db" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="status-filter-db" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="all">All</option>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                    <button id="employee-filter-btn" onclick="handleEmployeeFilter(this);" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-filter mr-1"></i> Filter
                    </button>
                    <button onclick="exportTableToExcel('employeeTable', 'employee-data')" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-file-excel mr-1"></i> Export to Excel
                    </button>
                    <button onclick="openAddEmployeeModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-plus mr-1"></i> Add Employee
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="table-container">
                        <table id="employeeTable" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Code</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">
                                        Full Name <i class="fas fa-info-circle text-blue-200 ml-1" title="Click on name to view employee details"></i>
                                    </th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Gender</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Hiring Date</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Position</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Department</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">DOB</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Phone</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Email</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Address</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">ID Number</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Social Ins.</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Status</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Military</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Level</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Direct Manager</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Resign Date</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Marital Status</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Faculty</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Grad. Year</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Leave Balance</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider bg-blue-600 font-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="employeeTableBody" class="bg-white divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="leaves" class="hidden space-y-6">
                <h1 class="text-3xl font-bold text-gray-800">Employee Leaves</h1>

                <!-- Add Leave Button -->
                <div class="flex justify-end">
                    <button id="add-leave-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-plus mr-1"></i> Add Leave
                    </button>
                </div>

                <!-- Leave Request Form - Hidden by default -->
                <div id="leave-form-container" class="hidden">
                    <div class="bg-white p-6 rounded-lg shadow mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Submit Leave Request</h2>
                        <form id="leave-form" class="space-y-4">
                            <div>
                                <label for="leave-employee-code" class="block text-sm font-medium text-gray-700 mb-1">Employee Code*</label>
                                <input type="text" id="leave-employee-code" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter employee code">
                            </div>
                            <div>
                                <label for="leave-employee-name" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                                <input type="text" id="leave-employee-name" readonly class="w-full p-2 border bg-gray-100 border-gray-300 rounded-md shadow-sm">
                                <input type="hidden" id="leave-employee" value="">
                            </div>
                            <div>
                                <label for="leave-balance" class="block text-sm font-medium text-gray-700 mb-1">Current Annual Balance</label>
                                <input type="number" id="leave-balance" readonly class="w-full p-2 border bg-gray-100 border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="leave-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                <input type="text" id="leave-start-date" required placeholder="Select start date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm flatpickr-input">
                            </div>
                            <div>
                                <label for="leave-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                <input type="text" id="leave-end-date" required placeholder="Select end date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm flatpickr-input">
                            </div>
                            <div>
                                <label for="leave-days" class="block text-sm font-medium text-gray-700 mb-1">Number of Days</label>
                                <select id="leave-days" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="0.5">Half Day</option>
                                    <option value="1">1 Day</option>
                                    <option value="2">2 Days</option>
                                    <option value="3">3 Days</option>
                                    <option value="4">4 Days</option>
                                    <option value="5">5 Days</option>
                                </select>
                            </div>
                            <div>
                                <label for="leave-type" class="block text-sm font-medium text-gray-700 mb-1">Leave Type</label>
                                <select id="leave-type" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="annual">Annual Leave</option>
                                    <option value="sick">Sick Leave</option>
                                    <option value="unpaid">Unpaid Leave</option>
                                    <option value="compensatory">Compensatory Leave</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label for="leave-reason" class="block text-sm font-medium text-gray-700 mb-1">Reason (Optional)</label>
                                <textarea id="leave-reason" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                Submit Leave
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Leave Records - Full width when form is hidden -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Leave Records</h2>

                    <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="leave-filter-employee-code" class="block text-sm font-medium text-gray-700 mb-1">Filter by Employee Code</label>
                            <div class="flex space-x-2">
                                <input type="text" id="leave-filter-employee-code" placeholder="Enter employee code" class="flex-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <input type="hidden" id="leave-filter-employee" value="all">
                            </div>
                        </div>
                        <div>
                            <label for="leave-filter-employee-name" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                            <input type="text" id="leave-filter-employee-name" readonly class="w-full p-2 border bg-gray-100 border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="leave-filter-month" class="block text-sm font-medium text-gray-700 mb-1">Filter by Month (Current Year)</label>
                            <select id="leave-filter-month" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="all">All Months</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="apply-leave-filters" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                <i class="fas fa-filter mr-1"></i> Apply Filters
                            </button>
                        </div>
                    </div>

                    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-medium text-gray-800 mb-2">Leave Summary</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Total Leave Days (Current Year):</p>
                                <p id="total-leave-days" class="text-xl font-semibold text-blue-600">0</p>
                                <p class="text-xs text-gray-400 mt-1">Includes ALL leave types for current year only</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Remaining Leave Balance:</p>
                                <p id="remaining-leave-balance" class="text-xl font-semibold text-green-600">0</p>
                                <p class="text-xs text-gray-400 mt-1">Annual allowance minus used annual leave days</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Used Leave Percentage:</p>
                                <p id="used-leave-percentage" class="text-xl font-semibold text-orange-600">0%</p>
                                <p class="text-xs text-gray-400 mt-1">Percentage of annual leave used</p>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="leaveTable" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-600">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Employee</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Start Date</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">End Date</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Days</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Type</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Status</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="leaveTableBody" class="bg-white divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="excuses" class="hidden space-y-6">
                <h1 class="text-3xl font-bold text-gray-800">Employee Excuses</h1>

                <!-- Add Excuse Button -->
                <div class="flex justify-end">
                    <button id="add-excuse-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-plus mr-1"></i> Add Excuse
                    </button>
                </div>

                <!-- Excuse Request Form - Hidden by default -->
                <div id="excuse-form-container" class="hidden">
                    <div class="bg-white p-6 rounded-lg shadow mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Submit Excuse Request</h2>
                        <form id="excuse-form" class="space-y-4">
                            <div>
                                <label for="excuse-employee-code" class="block text-sm font-medium text-gray-700 mb-1">Employee Code*</label>
                                <input type="text" id="excuse-employee-code" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter employee code">
                            </div>
                            <div>
                                <label for="excuse-employee-name" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                                <input type="text" id="excuse-employee-name" readonly class="w-full p-2 border bg-gray-100 border-gray-300 rounded-md shadow-sm">
                                <input type="hidden" id="excuse-employee" value="">
                            </div>
                            <div>
                                <label for="excuse-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="text" id="excuse-date" required placeholder="Select date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm flatpickr-input">
                            </div>
                            <div>
                                <label for="excuse-type" class="block text-sm font-medium text-gray-700 mb-1">Excuse Type</label>
                                <select id="excuse-type" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="early-checkout">Early Check-out</option>
                                    <option value="late-checkin">Late Check-in</option>
                                    <option value="outdoor-task">Outdoor Task</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="excuse-start-time-display" class="block text-sm font-medium text-gray-700 mb-1">Start Time (From)</label>
                                    <div class="relative">
                                        <input type="text" id="excuse-start-time-display" readonly required class="w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 cursor-pointer" placeholder="Click to select time">
                                        <input type="hidden" id="excuse-start-time" required>
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <i class="fas fa-clock text-gray-400"></i>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label for="excuse-end-time-display" class="block text-sm font-medium text-gray-700 mb-1">End Time (To)</label>
                                    <div class="relative">
                                        <input type="text" id="excuse-end-time-display" readonly required class="w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 cursor-pointer" placeholder="Click to select time">
                                        <input type="hidden" id="excuse-end-time" required>
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                            <i class="fas fa-clock text-gray-400"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label for="excuse-reason" class="block text-sm font-medium text-gray-700 mb-1">Reason (Optional)</label>
                                <textarea id="excuse-reason" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                Submit Excuse
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Excuse Records - Full width when form is hidden -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Excuse Records</h2>

                    <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="excuse-filter-employee-code" class="block text-sm font-medium text-gray-700 mb-1">Filter by Employee Code</label>
                            <div class="flex space-x-2">
                                <input type="text" id="excuse-filter-employee-code" placeholder="Enter employee code" class="flex-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <input type="hidden" id="excuse-filter-employee" value="all">
                            </div>
                        </div>
                        <div>
                            <label for="excuse-filter-employee-name" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                            <input type="text" id="excuse-filter-employee-name" readonly class="w-full p-2 border bg-gray-100 border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="excuse-filter-month" class="block text-sm font-medium text-gray-700 mb-1">Filter by Month (Current Year)</label>
                            <select id="excuse-filter-month" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="all">All Months</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="excuse-filter-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                <i class="fas fa-filter mr-1"></i> Apply Filters
                            </button>
                        </div>
                    </div>

                    <!-- Excuse Summary -->
                    <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-blue-800 mb-2">Current Month Excuses</h3>
                            <div class="flex items-center">
                                <div class="text-3xl font-bold text-blue-700" id="total-excuses-month">0</div>
                                <div class="ml-2 text-sm text-blue-600">excuses</div>
                            </div>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-indigo-800 mb-2">Year-to-Date Excuses</h3>
                            <div class="flex items-center">
                                <div class="text-3xl font-bold text-indigo-700" id="total-excuses-year">0</div>
                                <div class="ml-2 text-sm text-indigo-600">excuses</div>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="excuseTable" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-600">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Employee</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Date</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Type</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Time</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Reason</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Status</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="excuseTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="overtime" class="hidden space-y-6">
                <h1 class="text-3xl font-bold text-gray-800">Employee Overtime</h1>

                <!-- Add Overtime Button -->
                <div class="flex justify-end">
                    <button id="add-overtime-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-plus mr-1"></i> Add Overtime
                    </button>
                </div>

                <!-- Overtime Request Form - Hidden by default -->
                <div id="overtime-form-container" class="hidden">
                    <div class="bg-white p-6 rounded-lg shadow mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Submit Overtime Request</h2>
                        <form id="overtime-form" class="space-y-4">
                            <div>
                                <label for="overtime-employee-code" class="block text-sm font-medium text-gray-700 mb-1">Employee Code*</label>
                                <input type="text" id="overtime-employee-code" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter employee code">
                            </div>
                            <div>
                                <label for="overtime-employee-name" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                                <input type="text" id="overtime-employee-name" readonly class="w-full p-2 border bg-gray-100 border-gray-300 rounded-md shadow-sm">
                                <input type="hidden" id="overtime-employee" value="">
                            </div>
                            <div>
                                <label for="overtime-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="text" id="overtime-date" required placeholder="Select date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm flatpickr-input">
                            </div>
                            <div>
                                <label for="overtime-start-time" class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                                <div class="flex space-x-2">
                                    <input type="hidden" id="overtime-start-time">
                                    <input type="text" id="overtime-start-time-display" readonly required placeholder="Select start time" class="w-full p-2 border border-gray-300 rounded-md shadow-sm cursor-pointer">
                                    <button type="button" onclick="openClockModal('overtime-start-time')" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-md">
                                        <i class="fas fa-clock"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="overtime-end-time" class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
                                <div class="flex space-x-2">
                                    <input type="hidden" id="overtime-end-time">
                                    <input type="text" id="overtime-end-time-display" readonly required placeholder="Select end time" class="w-full p-2 border border-gray-300 rounded-md shadow-sm cursor-pointer">
                                    <button type="button" onclick="openClockModal('overtime-end-time')" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-md">
                                        <i class="fas fa-clock"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="overtime-reason" class="block text-sm font-medium text-gray-700 mb-1">Reason (Optional)</label>
                                <textarea id="overtime-reason" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                Submit Overtime Request
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Overtime Records - Full width when form is hidden -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Overtime Records</h2>

                    <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="overtime-filter-employee-code" class="block text-sm font-medium text-gray-700 mb-1">Filter by Employee Code</label>
                            <div class="flex space-x-2">
                                <input type="text" id="overtime-filter-employee-code" placeholder="Enter employee code" class="flex-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <input type="hidden" id="overtime-filter-employee" value="all">
                            </div>
                        </div>
                        <div>
                            <label for="overtime-filter-employee-name" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                            <input type="text" id="overtime-filter-employee-name" readonly class="w-full p-2 border bg-gray-100 border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="overtime-filter-month" class="block text-sm font-medium text-gray-700 mb-1">Filter by Month (Current Year)</label>
                            <select id="overtime-filter-month" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="all">All Months</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="overtime-filter-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                <i class="fas fa-filter mr-1"></i> Apply Filters
                            </button>
                        </div>
                    </div>

                    <!-- Overtime Summary -->
                    <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-green-800 mb-2">Current Month Overtime</h3>
                            <div class="flex items-center">
                                <div class="text-3xl font-bold text-green-700" id="total-overtime-hours-month">0</div>
                                <div class="ml-2 text-sm text-green-600">hours</div>
                            </div>
                        </div>
                        <div class="bg-teal-50 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-teal-800 mb-2">Year-to-Date Overtime</h3>
                            <div class="flex items-center">
                                <div class="text-3xl font-bold text-teal-700" id="total-overtime-hours-year">0</div>
                                <div class="ml-2 text-sm text-teal-600">hours</div>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="overtimeTable" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-600">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Employee</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Date</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Time</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Hours</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Reason</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Status</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="overtimeTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="penalties" class="hidden space-y-6">
                <h1 class="text-3xl font-bold text-gray-800">Employee Penalties</h1>

                <!-- Add Penalty Button -->
                <div class="flex justify-end">
                    <button id="add-penalty-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-plus mr-1"></i> Add Penalty
                    </button>
                </div>

                <!-- Penalty Form - Hidden by default -->
                <div id="penalty-form-container" class="hidden">
                    <div class="bg-white p-6 rounded-lg shadow mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Add Penalty</h2>
                        <form id="penalty-form" class="space-y-4">
                            <div>
                                <label for="penalty-employee-code" class="block text-sm font-medium text-gray-700 mb-1">Employee Code*</label>
                                <input type="text" id="penalty-employee-code" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter employee code">
                            </div>
                            <div>
                                <label for="penalty-employee-name" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                                <input type="text" id="penalty-employee-name" readonly class="w-full p-2 border bg-gray-100 border-gray-300 rounded-md shadow-sm">
                                <input type="hidden" id="penalty-employee" value="">
                            </div>
                            <div>
                                <label for="penalty-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                <input type="text" id="penalty-date" required placeholder="Select date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm flatpickr-input">
                            </div>
                            <div>
                                <label for="penalty-days" class="block text-sm font-medium text-gray-700 mb-1">Penalty Days</label>
                                <input type="number" id="penalty-days" required min="0.25" step="0.25" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter penalty days (0.25, 0.5, 0.75, etc.)">
                                <p class="text-xs text-gray-500 mt-1">Values will be auto-corrected to nearest 0.25 increment</p>
                            </div>
                            <div>
                                <label for="penalty-reason" class="block text-sm font-medium text-gray-700 mb-1">Reason*</label>
                                <textarea id="penalty-reason" required rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                Add Penalty
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Penalty Records - Full width when form is hidden -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Penalty Records</h2>

                    <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="penalty-filter-employee-code" class="block text-sm font-medium text-gray-700 mb-1">Filter by Employee Code</label>
                            <div class="flex space-x-2">
                                <input type="text" id="penalty-filter-employee-code" placeholder="Enter employee code" class="flex-1 p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <input type="hidden" id="penalty-filter-employee" value="all">
                            </div>
                        </div>
                        <div>
                            <label for="penalty-filter-employee-name" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                            <input type="text" id="penalty-filter-employee-name" readonly class="w-full p-2 border bg-gray-100 border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="penalty-filter-month" class="block text-sm font-medium text-gray-700 mb-1">Filter by Month (Current Year)</label>
                            <select id="penalty-filter-month" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="all">All Months</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button id="penalty-filter-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                <i class="fas fa-filter mr-1"></i> Apply Filters
                            </button>
                        </div>
                    </div>

                    <!-- Penalty Summary -->
                    <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-red-800 mb-2">Current Month Penalties</h3>
                            <div class="flex items-center">
                                <div class="text-3xl font-bold text-red-700" id="total-penalty-days-month">0</div>
                                <div class="ml-2 text-sm text-red-600">days</div>
                            </div>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-orange-800 mb-2">Year-to-Date Penalties</h3>
                            <div class="flex items-center">
                                <div class="text-3xl font-bold text-orange-700" id="total-penalty-days-year">0</div>
                                <div class="ml-2 text-sm text-orange-600">days</div>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="penaltyTable" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-600">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Employee</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Date</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Days</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Reason</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Status</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="penaltyTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="salary" class="hidden space-y-6">
                <h1 class="text-3xl font-bold text-gray-800">Salary Details</h1>

                <!-- Filters and Add Salary Button -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
                    <!-- Filters -->
                    <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center space-x-2">
                            <label for="salary-filter-employee-code" class="text-sm font-medium text-gray-700">Employee:</label>
                            <input type="text" id="salary-filter-employee-code" placeholder="Enter code" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <input type="text" id="salary-filter-employee-name" readonly class="bg-gray-100 border border-gray-300 rounded-md px-3 py-1 text-sm w-40">
                            <input type="hidden" id="salary-filter-employee" value="all">
                        </div>
                        <button id="salary-filter-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-4 rounded-md shadow transition duration-150">
                            <i class="fas fa-filter mr-1"></i> Apply Filters
                        </button>
                    </div>

                    <!-- Add Salary Button -->
                    <button id="add-salary-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-plus mr-1"></i> Add Salary Details
                    </button>
                </div>

                <!-- Salary Form Container (Hidden by default) -->
                <div id="salary-form-container" class="bg-white p-6 rounded-lg shadow hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Add/Edit Salary Details</h2>
                    <form id="salary-form" class="space-y-4">
                        <!-- Employee Selection -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="salary-employee-code" class="block text-sm font-medium text-gray-700 mb-1">Employee Code</label>
                                <input type="text" id="salary-employee-code" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter employee code" required>
                                <input type="hidden" id="salary-employee" value="">
                            </div>
                            <div>
                                <label for="salary-employee-name" class="block text-sm font-medium text-gray-700 mb-1">Employee Name</label>
                                <input type="text" id="salary-employee-name" class="w-full bg-gray-100 border border-gray-300 rounded-md px-3 py-2" readonly>
                            </div>
                        </div>

                        <!-- Salary Details -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label for="salary-total" class="block text-sm font-medium text-gray-700 mb-1">Total Salary</label>
                                <input type="number" id="salary-total" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0.00" step="0.01" min="0" required>
                            </div>
                            <div>
                                <label for="salary-basic" class="block text-sm font-medium text-gray-700 mb-1">Basic Salary</label>
                                <input type="number" id="salary-basic" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0.00" step="0.01" min="0" required>
                            </div>
                            <div>
                                <label for="salary-allowance" class="block text-sm font-medium text-gray-700 mb-1">Fixed Allowance</label>
                                <input type="number" id="salary-allowance" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0.00" step="0.01" min="0">
                            </div>
                            <div>
                                <label for="salary-deduction" class="block text-sm font-medium text-gray-700 mb-1">Fixed Deduction</label>
                                <input type="number" id="salary-deduction" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="0.00" step="0.01" min="0">
                            </div>
                        </div>

                        <!-- Bank Details -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="salary-bank" class="block text-sm font-medium text-gray-700 mb-1">Bank Name</label>
                                <input type="text" id="salary-bank" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter bank name">
                            </div>
                            <div>
                                <label for="salary-account" class="block text-sm font-medium text-gray-700 mb-1">Account Number</label>
                                <input type="text" id="salary-account" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter account number">
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex justify-end">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-md shadow transition duration-150">
                                Save Salary Details
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Salary Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="table-container">
                        <table id="salaryTable" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-600">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Code</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Employee Name</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Total Salary</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Basic Salary</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Fixed Allowance</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Fixed Deduction</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Bank Name</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Account No.</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="salaryTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="payroll" class="hidden space-y-6">
                <h1 class="text-3xl font-bold text-gray-800">Payroll</h1>

                <!-- Payroll Controls -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0">
                    <!-- Month Selection -->
                    <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 bg-white p-4 rounded-lg shadow">
                        <div class="flex items-center space-x-2">
                            <label for="payroll-month" class="text-sm font-medium text-gray-700">Month:</label>
                            <select id="payroll-month" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="payroll-year" class="text-sm font-medium text-gray-700">Year:</label>
                            <select id="payroll-year" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <!-- Will be populated by JS -->
                            </select>
                        </div>
                    </div>

                    <!-- Payroll Buttons -->
                    <div class="flex space-x-2">
                        <button id="run-payroll-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                            <i class="fas fa-calculator mr-1"></i> Run Current Month Payroll
                        </button>
                        <button id="export-payroll-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                            <i class="fas fa-file-excel mr-1"></i> Export to Excel
                        </button>
                    </div>
                </div>

                <!-- Payroll Form Container (Hidden by default) -->
                <div id="payroll-form-container" class="bg-white p-6 rounded-lg shadow hidden">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Payroll Calculation</h2>
                    <p class="text-sm text-gray-600 mb-4">Please enter the manual values for the payroll calculation. The system will automatically calculate the rest based on employee records.</p>

                    <div class="overflow-x-auto">
                        <table id="payrollCalculationTable" class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr class="bg-blue-600">
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Code</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Name</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Basic Salary</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Fixed Allowance</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Fuel Allowance</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Reward (EGP)</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Overtime</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Fixed Deduction</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Penalties/Days</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Penalties (EGP)</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Other Deductions</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold bg-blue-600">Net Salary</th>
                                </tr>
                            </thead>
                            <tbody id="payrollCalculationTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Will be populated by JS -->
                            </tbody>
                            <tfoot class="bg-gray-100 font-bold">
                                <tr id="payrollTotalsRow">
                                    <td colspan="2" class="px-4 py-3 text-right">Totals:</td>
                                    <td class="px-4 py-3" id="total-basic-salary">0.00</td>
                                    <td class="px-4 py-3" id="total-fixed-allowance">0.00</td>
                                    <td class="px-4 py-3" id="total-fuel-allowance">0.00</td>
                                    <td class="px-4 py-3" id="total-reward">0.00</td>
                                    <td class="px-4 py-3" id="total-overtime">0.00</td>
                                    <td class="px-4 py-3" id="total-fixed-deduction">0.00</td>
                                    <td class="px-4 py-3" id="total-penalties-days">0.00</td>
                                    <td class="px-4 py-3" id="total-penalties-egp">0.00</td>
                                    <td class="px-4 py-3" id="total-other-deductions">0.00</td>
                                    <td class="px-4 py-3" id="total-net-salary">0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="flex justify-end mt-6 space-x-4">
                        <button id="cancel-payroll-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                            Cancel
                        </button>
                        <button id="save-payroll-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                            Save Payroll
                        </button>
                    </div>
                </div>

                <!-- Payroll Records -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Payroll Records</h2>

                    <!-- Payroll History Filters -->
                    <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="flex items-center space-x-2">
                            <label for="payroll-history-month" class="text-sm font-medium text-gray-700">Month:</label>
                            <select id="payroll-history-month" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="all">All Months</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="payroll-history-year" class="text-sm font-medium text-gray-700">Year:</label>
                            <select id="payroll-history-year" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="all">All Years</option>
                                <!-- Will be populated by JS -->
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="payroll-history-filter-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-1 px-4 rounded-md shadow transition duration-150">
                                <i class="fas fa-filter mr-1"></i> <span id="filter-btn-text">Apply Filters</span>
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table id="payrollHistoryTable" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-600">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Month/Year</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Code</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Name</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Basic Salary</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Total Allowances</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Total Deductions</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Net Salary</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider font-bold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="payrollHistoryTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Will be populated by JS -->
                                <tr>
                                    <td colspan="8" class="text-center py-4 text-gray-500">No payroll records found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="settings" class="hidden space-y-6">
                <h1 class="text-3xl font-bold text-gray-800">Settings</h1>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Change Password</h2>
                        <form id="password-form" class="space-y-4">
                            <div>
                                <label for="current-password" class="block text-sm font-medium text-gray-700 mb-1">Current Password</label>
                                <input type="password" id="current-password" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                                <input type="password" id="new-password" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                                <input type="password" id="confirm-password" required class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                Change Password
                            </button>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Appearance</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Theme</label>
                                <div class="flex space-x-4">
                                    <button id="light-mode-btn" class="flex-1 bg-white border border-gray-300 rounded-md py-2 px-4 font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <i class="fas fa-sun mr-2"></i> Light
                                    </button>
                                    <button id="dark-mode-btn" class="flex-1 bg-gray-800 text-white border border-gray-700 rounded-md py-2 px-4 font-medium hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <i class="fas fa-moon mr-2"></i> Dark
                                    </button>
                                </div>
                            </div>
                            <div class="pt-4 border-t space-y-4">
                                <button id="reset-btn" onclick="clearLocalStorageAndReload()" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                    <i class="fas fa-sync mr-2"></i> Reset Data
                                </button>
                                <button id="logout-btn" onclick="logout()" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <div id="employeeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center border-b pb-3 mb-5">
                    <h3 id="modalTitle" class="text-2xl font-semibold text-gray-800">Add New Employee</h3>
                    <button onclick="closeEmployeeModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                </div>
                <form id="employeeForm" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                    <input type="hidden" id="employeeId" value=""> <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="empCode" class="block text-sm font-medium text-gray-700">Employee Code*</label>
                            <input type="text" id="empCode" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name*</label>
                            <input type="text" id="fullName" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                         <div> <label for="gender" class="block text-sm font-medium text-gray-700">Gender*</label>
                            <select id="gender" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        <div>
                            <label for="hiringDate" class="block text-sm font-medium text-gray-700">Hiring Date*</label>
                            <div class="grid grid-cols-3 gap-2">
                                <select id="hiringDay" class="p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="">Day</option>
                                    <!-- Days will be populated by JS -->
                                </select>
                                <select id="hiringMonth" class="p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="">Month</option>
                                    <!-- Months will be populated by JS -->
                                </select>
                                <select id="hiringYear" class="p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="">Year</option>
                                    <!-- Years will be populated by JS -->
                                </select>
                            </div>
                            <input type="hidden" id="hiringDate" required>
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number*</label>
                            <input type="tel" id="phone" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email Address*</label>
                            <input type="email" id="email" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="md:col-span-2">
                            <label for="address" class="block text-sm font-medium text-gray-700">Address*</label>
                            <input type="text" id="address" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="position" class="block text-sm font-medium text-gray-700">Position*</label>
                            <div class="relative">
                                <input type="text" id="position" list="positionList" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <datalist id="positionList">
                                    <!-- Will be populated by JS -->
                                </datalist>
                                <div class="text-xs text-gray-500 mt-1">Select from list or type a new position</div>
                            </div>
                        </div>
                         <div>
                            <label for="department" class="block text-sm font-medium text-gray-700">Department*</label>
                            <div class="relative">
                                <input type="text" id="department" list="departmentList" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <datalist id="departmentList">
                                    <!-- Will be populated by JS -->
                                </datalist>
                                <div class="text-xs text-gray-500 mt-1">Select from list or type a new department</div>
                            </div>
                        </div>
                         <div>
                            <label for="dob" class="block text-sm font-medium text-gray-700">Date of Birth*</label>
                            <div class="grid grid-cols-3 gap-2">
                                <select id="dobDay" class="p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="">Day</option>
                                    <!-- Days will be populated by JS -->
                                </select>
                                <select id="dobMonth" class="p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="">Month</option>
                                    <!-- Months will be populated by JS -->
                                </select>
                                <select id="dobYear" class="p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="">Year</option>
                                    <!-- Years will be populated by JS -->
                                </select>
                            </div>
                            <input type="hidden" id="dob" required>
                        </div>
                         <div>
                            <label for="idNumber" class="block text-sm font-medium text-gray-700">ID Number*</label>
                            <input type="text" id="idNumber" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                         <div>
                            <label for="socialInsurance" class="block text-sm font-medium text-gray-700">Social Insurance Number</label>
                            <input type="text" id="socialInsurance" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                         <div>
                            <label for="status" class="block text-sm font-medium text-gray-700">Status*</label>
                            <select id="status" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                         <div>
                            <label for="militaryStatus" class="block text-sm font-medium text-gray-700">Military Status</label>
                            <select id="militaryStatus" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="">N/A</option>
                                <option value="Completed">Completed</option>
                                <option value="Exempted">Exempted</option>
                                <option value="Postponed">Postponed</option>
                            </select>
                        </div>
                         <div>
                            <label for="level" class="block text-sm font-medium text-gray-700">Level*</label>
                            <select id="level" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="Non-manager">Non-manager</option>
                                <option value="Manager">Manager</option>
                            </select>
                        </div>
                         <div>
                            <label for="directManager" class="block text-sm font-medium text-gray-700">Direct Manager</label>
                            <select id="directManager" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="">Select Manager</option>
                                </select>
                        </div>
                         <div>
                            <label for="resignDate" class="block text-sm font-medium text-gray-700">Resign Date</label>
                            <div class="grid grid-cols-3 gap-2">
                                <select id="resignDay" class="p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="">Day</option>
                                    <!-- Days will be populated by JS -->
                                </select>
                                <select id="resignMonth" class="p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="">Month</option>
                                    <!-- Months will be populated by JS -->
                                </select>
                                <select id="resignYear" class="p-2 border border-gray-300 rounded-md shadow-sm">
                                    <option value="">Year</option>
                                    <!-- Years will be populated by JS -->
                                </select>
                            </div>
                            <input type="hidden" id="resignDate">
                        </div>
                        <div>
                            <label for="maritalStatus" class="block text-sm font-medium text-gray-700">Marital Status</label>
                            <select id="maritalStatus" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="">Select Status</option>
                                <option value="Single">Single</option>
                                <option value="Married">Married</option>
                                <option value="Divorced">Divorced</option>
                                <option value="Widowed">Widowed</option>
                            </select>
                        </div>
                         <div>
                            <label for="faculty" class="block text-sm font-medium text-gray-700">Faculty/Institute</label>
                            <input type="text" id="faculty" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="gradYear" class="block text-sm font-medium text-gray-700">Graduation Year</label>
                            <input type="number" id="gradYear" min="1950" max="2050" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="leaveBalance" class="block text-sm font-medium text-gray-700">Annual Leave Balance</label>
                            <input type="number" id="leaveBalance" min="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <p class="text-xs text-gray-500 mt-1">Leave blank if employee has no balance. This will be manually managed by admin.</p>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="closeEmployeeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md shadow transition duration-150">Cancel</button>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">Save Employee</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="messageBox" class="fixed bottom-5 right-5 bg-green-500 text-white p-4 rounded-lg shadow-lg hidden z-50 transition-opacity duration-300">
            <span id="messageText"></span>
        </div>

        <!-- Simplified Hour Selection Modal -->
        <div id="clockModal" class="clock-modal hidden">
            <div class="clock-modal-content">
                <div class="clock-modal-header">
                    <h3 class="clock-modal-title" id="clock-modal-title">Select Time</h3>
                    <button id="close-clock-modal" class="clock-modal-close">&times;</button>
                </div>

                <!-- AM Hours -->
                <div class="mb-4">
                    <h4 class="text-center font-semibold text-gray-700 mb-2">AM</h4>
                    <div class="grid grid-cols-4 gap-2" id="am-hours-container">
                        <!-- AM hours will be added by JS -->
                    </div>
                </div>

                <!-- PM Hours -->
                <div class="mb-4">
                    <h4 class="text-center font-semibold text-gray-700 mb-2">PM</h4>
                    <div class="grid grid-cols-4 gap-2" id="pm-hours-container">
                        <!-- PM hours will be added by JS -->
                    </div>
                </div>

                <div class="clock-time-display text-center font-bold text-xl text-indigo-600 my-3" id="clock-time-display">
                    Selected: <span id="selected-time-text">Not selected</span>
                </div>

                <div class="flex justify-end mt-4">
                    <button id="clock-confirm" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-150">
                        Confirm
                    </button>
                </div>
            </div>
        </div>

        <!-- Employee Card Modal -->
        <div id="employeeCardModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
            <div class="relative mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 class="text-2xl font-semibold text-gray-800">Employee Details</h3>
                    <button onclick="closeEmployeeCardModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                </div>
                <div id="employeeCardContent" class="space-y-4">
                    <!-- Content will be dynamically populated -->
                    <div class="flex items-center justify-center p-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3 pt-4 border-t">
                    <button onclick="openEditEmployeeModalFromCard()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow transition duration-150">
                        <i class="fas fa-edit mr-2"></i> Edit
                    </button>
                    <button onclick="closeEmployeeCardModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md shadow transition duration-150">Close</button>
                </div>
            </div>
        </div>
    </div> <script>
        // --- Mock Data (Added Gender) ---
        let employees = [
            { id: 'EMP001', fullName: 'Alice Wonderland', gender: 'Female', hiringDate: '2022-01-15', position: 'Software Developer', department: 'IT', dob: '1995-05-20', idNumber: '12345678901234', socialInsurance: 'SI12345', status: 'Active', militaryStatus: 'N/A', level: 'Non-manager', directManager: 'Bob The Builder', resignDate: null, maritalStatus: 'Single', faculty: 'Computer Science', gradYear: 2018, annualLeaveBalance: 21 },
            { id: 'EMP002', fullName: 'Bob The Builder', gender: 'Male', hiringDate: '2021-03-10', position: 'IT Manager', department: 'IT', dob: '1988-11-02', idNumber: '98765432109876', socialInsurance: 'SI67890', status: 'Active', militaryStatus: 'Exempted', level: 'Manager', directManager: null, resignDate: null, maritalStatus: 'Married', faculty: 'Engineering', gradYear: 2010, annualLeaveBalance: 21 },
            { id: 'EMP003', fullName: 'Charlie Chaplin', gender: 'Male', hiringDate: '2023-07-01', position: 'HR Specialist', department: 'HR', dob: '1992-09-15', idNumber: '11223344556677', socialInsurance: 'SI11223', status: 'Active', militaryStatus: 'Completed', level: 'Non-manager', directManager: 'Diana Prince', resignDate: null, maritalStatus: 'Single', faculty: 'Business Administration', gradYear: 2015, annualLeaveBalance: 15 },
            { id: 'EMP004', fullName: 'Diana Prince', gender: 'Female', hiringDate: '2020-05-20', position: 'HR Manager', department: 'HR', dob: '1985-03-08', idNumber: '22446688001122', socialInsurance: 'SI22446', status: 'Active', militaryStatus: 'N/A', level: 'Manager', directManager: null, resignDate: null, maritalStatus: 'Married', faculty: 'Psychology', gradYear: 2008, annualLeaveBalance: 21 },
            { id: 'EMP005', fullName: 'Ethan Hunt', gender: 'Male', hiringDate: '2022-11-01', position: 'Marketing Analyst', department: 'Marketing', dob: '1996-12-25', idNumber: '33557799112233', socialInsurance: 'SI33557', status: 'Active', militaryStatus: 'Postponed', level: 'Non-manager', directManager: 'Felicity Smoak', resignDate: null, maritalStatus: 'Single', faculty: 'Marketing', gradYear: 2019, annualLeaveBalance: 18 },
            { id: 'EMP006', fullName: 'Felicity Smoak', gender: 'Female', hiringDate: '2019-08-15', position: 'Marketing Manager', department: 'Marketing', dob: '1990-07-19', idNumber: '44668800223344', socialInsurance: 'SI44668', status: 'Active', militaryStatus: 'N/A', level: 'Manager', directManager: null, resignDate: null, maritalStatus: 'Single', faculty: 'Communications', gradYear: 2012, annualLeaveBalance: 21 },
            { id: 'EMP007', fullName: 'Grace Hopper', gender: 'Female', hiringDate: '2024-01-10', position: 'Accountant', department: 'Finance', dob: '1998-02-14', idNumber: '55779911334455', socialInsurance: 'SI55779', status: 'Active', militaryStatus: 'N/A', level: 'Non-manager', directManager: 'Harold Finch', resignDate: null, maritalStatus: 'Single', faculty: 'Accounting', gradYear: 2021, annualLeaveBalance: 21 },
             { id: 'EMP008', fullName: 'Harold Finch', gender: 'Male', hiringDate: '2018-06-01', position: 'Finance Manager', department: 'Finance', dob: '1982-04-30', idNumber: '66880022445566', socialInsurance: 'SI66880', status: 'Active', militaryStatus: 'Exempted', level: 'Manager', directManager: null, resignDate: null, maritalStatus: 'Married', faculty: 'Economics', gradYear: 2005, annualLeaveBalance: 21 },
             { id: 'EMP009', fullName: 'Inactive Ian', gender: 'Male', hiringDate: '2020-02-02', position: 'Operations Assistant', department: 'Operations', dob: '1993-01-01', idNumber: '77991133556677', socialInsurance: 'SI77991', status: 'Inactive', militaryStatus: 'Completed', level: 'Non-manager', directManager: 'Jane Doe', resignDate: '2023-12-31', maritalStatus: 'Divorced', faculty: 'Logistics', gradYear: 2016, annualLeaveBalance: 0 },
             { id: 'EMP010', fullName: 'Jane Doe', gender: 'Female', hiringDate: '2019-01-15', position: 'Operations Manager', department: 'Operations', dob: '1987-06-10', idNumber: '88002244667788', socialInsurance: 'SI88002', status: 'Active', militaryStatus: 'N/A', level: 'Manager', directManager: null, resignDate: null, maritalStatus: 'Married', faculty: 'Supply Chain Management', gradYear: 2009, annualLeaveBalance: 21 },
        ];

        let leaveRecords = [
            { id: 1, employeeId: 'EMP001', employeeName: 'Alice Wonderland', startDate: '2024-03-01', endDate: '2024-03-05', days: 5, type: 'Annual Leave', status: 'Approved' },
            { id: 2, employeeId: 'EMP003', employeeName: 'Charlie Chaplin', startDate: '2024-04-10', endDate: '2024-04-11', days: 2, type: 'Sick Leave', status: 'Approved' },
            { id: 3, employeeId: 'EMP005', employeeName: 'Ethan Hunt', startDate: '2024-05-01', endDate: '2024-05-03', days: 3, type: 'Annual Leave', status: 'Pending' },
            { id: 4, employeeId: 'EMP007', employeeName: 'Grace Hopper', startDate: '2024-02-15', endDate: '2024-02-16', days: 2, type: 'Annual Leave', status: 'Approved' },
            { id: 5, employeeId: 'EMP002', employeeName: 'Bob The Builder', startDate: '2024-06-10', endDate: '2024-06-10', days: 0.5, type: 'Annual Leave', status: 'Approved' },
            { id: 6, employeeId: 'EMP001', employeeName: 'Alice Wonderland', startDate: '2024-07-01', endDate: '2024-07-03', days: 3, type: 'Annual Leave', status: 'Approved' },
        ];

        // --- Global Variables ---
        let departments = [];
        let positions = [];
        let managers = [];
        let currentUserRole = ''; // Will be set to 'admin' or 'employee' during login
        let currentUserId = ''; // Will store the current user's ID (employee ID or 'admin')
        let userAccounts = []; // Will store user account information
        let deptChartInstance, levelChartInstance, hiringChartInstance, leavesDeptChartInstance, genderChartInstance, ageChartInstance, monthlyHiringChartInstance;

        // --- Utility Functions ---
        function formatDate(dateString) {
            if (!dateString) return '';
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        function calculateLeaveDays(start, end) {
            // If start and end dates are the same, allow for half-day option
            if (start === end) {
                // Check if half-day is selected in the dropdown
                const selectedDays = parseFloat(document.getElementById('leave-days').value);
                if (selectedDays === 0.5) {
                    return 0.5; // Return 0.5 for half-day when dates are the same
                }
            }

            const startDate = new Date(start);
            const endDate = new Date(end);
            if (isNaN(startDate) || isNaN(endDate) || endDate < startDate) return 0;
            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            return diffDays;
        }

        function showMessage(text, type = 'success') {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            messageText.textContent = text;

            messageBox.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'opacity-0');
            messageBox.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500', 'opacity-100');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                 setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 3000);
        }

        // --- Login/Logout ---
        function handleLogin(event) {
            event.preventDefault();
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const errorDiv = document.getElementById('login-error');
            const username = usernameInput.value.trim();
            const password = passwordInput.value;

            // Load data first to ensure we have the latest user accounts
            const savedEmployees = localStorage.getItem('hrSystemEmployees');
            if (savedEmployees) {
                employees = JSON.parse(savedEmployees);
            }

            const savedUserAccounts = localStorage.getItem('hrSystemUserAccounts');
            if (savedUserAccounts) {
                userAccounts = JSON.parse(savedUserAccounts);
            } else {
                // Generate user accounts if none exist
                generateUserAccounts();
            }

            // Find the user account
            const userAccount = userAccounts.find(account => account.username === username && account.password === password);

            if (userAccount) {
                // Set the current user role and ID
                currentUserRole = userAccount.role;
                currentUserId = userAccount.role === 'admin' ? 'admin' : userAccount.employeeId;

                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                document.body.classList.add('flex', 'h-screen');
                errorDiv.classList.add('hidden');
                initializeAppUI();

                if (currentUserRole === 'admin') {
                    // Show a message indicating admin mode
                    showMessage('Logged in as Administrator. All submissions will be auto-approved.');
                } else {
                    // Find the employee
                    const employee = employees.find(emp => emp.id === currentUserId);
                    if (employee) {
                        showMessage(`Welcome, ${employee.fullName}! You are logged in as an employee.`);
                    } else {
                        showMessage('Welcome! You are logged in as an employee.');
                    }
                }
            } else {
                errorDiv.classList.remove('hidden');
                passwordInput.value = '';
            }
        }

        function logout() {
             // Reset the user role and ID
             currentUserRole = '';
             currentUserId = '';

             document.getElementById('login-form').reset();
             document.getElementById('login-error').classList.add('hidden');
             document.getElementById('app-container').classList.add('hidden');
             document.getElementById('login-screen').classList.remove('hidden');
             document.body.classList.remove('flex', 'h-screen');

             // Destroy all chart instances
             if (deptChartInstance) deptChartInstance.destroy();
             if (levelChartInstance) levelChartInstance.destroy();
             if (hiringChartInstance) hiringChartInstance.destroy();
             if (leavesDeptChartInstance) leavesDeptChartInstance.destroy();
             if (genderChartInstance) genderChartInstance.destroy();
             if (ageChartInstance) ageChartInstance.destroy();
             if (monthlyHiringChartInstance) monthlyHiringChartInstance.destroy();
             deptChartInstance = levelChartInstance = hiringChartInstance = leavesDeptChartInstance = genderChartInstance = ageChartInstance = monthlyHiringChartInstance = null;

             console.log("User logged out");
        }


        // Function to clear localStorage and reload the page
        function clearLocalStorageAndReload() {
            localStorage.removeItem('hrSystemLeaves');
            localStorage.removeItem('hrSystemEmployees');
            localStorage.removeItem('hrSystemExcuses');
            localStorage.removeItem('hrSystemOvertime');
            localStorage.removeItem('hrSystemPenalties');
            localStorage.removeItem('hrSystemSalary');
            localStorage.removeItem('hrSystemPayroll');
            localStorage.removeItem('hrSystemUserAccounts');
            location.reload();
        }

        // --- Application UI Initialization (Called after successful login) ---
        function initializeAppUI() {
             console.log("Initializing application UI...");

             // Load saved data from localStorage
             loadSavedData();

             // Initial population of dynamic data lists
             updateDynamicDataLists();

             // Populate dashboard filters first
             populateDashboardFilterDropdowns();

             // Calculate and update all employee leave balances
             updateAllEmployeeLeaveBalances();

             // Initial setup for the main app
             showSection('dashboard'); // Show dashboard by default
             populateFilterDropdowns(); // Populate DB filters and modal dropdowns
             populateEmployeeTable(); // Populate DB table with all employees initially
             populateLeaveTable();
             populateExcuseTable();
             populateOvertimeTable();
             populatePenaltyTable();
             populateSalaryTable();
             populatePayrollYearDropdowns(); // Initialize payroll year dropdowns
             populatePayrollHistoryTable(); // Initialize payroll history table
             updateExcuseSummary();
             updateOvertimeSummary();
             updatePenaltySummary();

             // Initialize analog clock
             initializeAnalogClock();

             // Set up leave filter employee code validation
             setupLeaveFilterEmployeeCodeValidation();

             // Set up overtime employee code validation
             setupOvertimeEmployeeCodeValidation();

             // Set up overtime filter employee code validation
             setupOvertimeFilterEmployeeCodeValidation();

             // Set up excuse filter employee code validation
             setupExcuseFilterEmployeeCodeValidation();

             // Set up penalty filter employee code validation
             setupPenaltyFilterEmployeeCodeValidation();

             // Set up salary filter employee code validation
             setupSalaryFilterEmployeeCodeValidation();

             // Set up salary employee code validation
             setupSalaryEmployeeCodeValidation();

             // Add filter buttons to excuse and penalty sections
             addFilterButtonsToExcuseAndPenalty();

             // Update month filter labels to show current year
             updateMonthFilterLabels();

             // Add event listener for overtime form submission
             document.getElementById('overtime-form').addEventListener('submit', handleOvertimeFormSubmit);

             // Initial dashboard update (stats and charts) with all data
             updateDashboard();

             // Update dashboard notifications
             updateDashboardNotifications();

             // Add form submit listeners (ensure they are added only once)
             const employeeForm = document.getElementById('employeeForm');
             const leaveForm = document.getElementById('leave-form');
             const excuseForm = document.getElementById('excuse-form');
             const penaltyForm = document.getElementById('penalty-form');
             const salaryForm = document.getElementById('salary-form');

             employeeForm.removeEventListener('submit', handleEmployeeFormSubmit);
             leaveForm.removeEventListener('submit', handleLeaveFormSubmit);
             excuseForm.removeEventListener('submit', handleExcuseFormSubmit);
             penaltyForm.removeEventListener('submit', handlePenaltyFormSubmit);
             salaryForm.removeEventListener('submit', handleSalaryFormSubmit);

             employeeForm.addEventListener('submit', handleEmployeeFormSubmit);
             leaveForm.addEventListener('submit', handleLeaveFormSubmit);
             excuseForm.addEventListener('submit', handleExcuseFormSubmit);
             penaltyForm.addEventListener('submit', handlePenaltyFormSubmit);
             salaryForm.addEventListener('submit', handleSalaryFormSubmit);

             // Add validation to leave form
             document.getElementById('leave-form').addEventListener('submit', function(event) {
                 if (!validateLeaveDays()) {
                     event.preventDefault();
                     return false;
                 }
             });

             // Add button functionality for all sections
             document.getElementById('add-leave-btn').addEventListener('click', function() {
                 document.getElementById('leave-form-container').classList.remove('hidden');
             });

             document.getElementById('add-excuse-btn').addEventListener('click', function() {
                 document.getElementById('excuse-form-container').classList.remove('hidden');
             });

             document.getElementById('add-overtime-btn').addEventListener('click', function() {
                 document.getElementById('overtime-form-container').classList.remove('hidden');
             });

             document.getElementById('add-penalty-btn').addEventListener('click', function() {
                 document.getElementById('penalty-form-container').classList.remove('hidden');
             });

             document.getElementById('add-salary-btn').addEventListener('click', function() {
                 document.getElementById('salary-form-container').classList.remove('hidden');
             });

             // Add event listener for penalty days input to auto-correct on blur
             const penaltyDaysInput = document.getElementById('penalty-days');
             if (penaltyDaysInput) {
                 penaltyDaysInput.addEventListener('blur', function() {
                     const correctedValue = validatePenaltyDays(this.value);
                     this.value = correctedValue;
                 });
             }

             // Add listener for database search input
             document.getElementById('search-db').addEventListener('input', filterEmployeeTable);

             // Setup theme toggle
             document.getElementById('light-mode-btn').addEventListener('click', () => setTheme('light'));
             document.getElementById('dark-mode-btn').addEventListener('click', () => setTheme('dark'));

             // Setup mobile menu toggle
             document.getElementById('mobile-menu-button').addEventListener('click', function() {
                 const sidebar = document.getElementById('sidebar');
                 sidebar.classList.toggle('-translate-x-full');
             });

             document.getElementById('close-sidebar').addEventListener('click', function() {
                 const sidebar = document.getElementById('sidebar');
                 sidebar.classList.add('-translate-x-full');
             });

             console.log("HR System Application UI Initialized");
        }

        // Load saved data from localStorage
        function loadSavedData() {
            const savedEmployees = localStorage.getItem('hrSystemEmployees');
            if (savedEmployees) {
                employees = JSON.parse(savedEmployees);
                console.log(`Loaded ${employees.length} employees from localStorage`);
            }

            const savedLeaves = localStorage.getItem('hrSystemLeaves');
            if (savedLeaves) {
                leaveRecords = JSON.parse(savedLeaves);
                console.log(`Loaded ${leaveRecords.length} leave records from localStorage`);
            }

            const savedExcuses = localStorage.getItem('hrSystemExcuses');
            if (savedExcuses) {
                excuseRecords = JSON.parse(savedExcuses);
                console.log(`Loaded ${excuseRecords.length} excuse records from localStorage`);
            }

            const savedOvertime = localStorage.getItem('hrSystemOvertime');
            if (savedOvertime) {
                overtimeRecords = JSON.parse(savedOvertime);
                console.log(`Loaded ${overtimeRecords.length} overtime records from localStorage`);
            }

            const savedPenalties = localStorage.getItem('hrSystemPenalties');
            if (savedPenalties) {
                penaltyRecords = JSON.parse(savedPenalties);
                console.log(`Loaded ${penaltyRecords.length} penalty records from localStorage`);
            }

            const savedSalary = localStorage.getItem('hrSystemSalary');
            if (savedSalary) {
                try {
                    salaryRecords = JSON.parse(savedSalary);
                    console.log(`Loaded ${salaryRecords.length} salary records from localStorage:`, salaryRecords);
                } catch (error) {
                    console.error('Error parsing salary records from localStorage:', error);
                    console.log('Raw salary data:', savedSalary);
                    // Initialize with empty array if there's an error
                    salaryRecords = [];
                }
            } else {
                console.log('No salary records found in localStorage, using default data');
            }

            const savedPayroll = localStorage.getItem('hrSystemPayroll');
            if (savedPayroll) {
                try {
                    payrollRecords = JSON.parse(savedPayroll);
                    console.log(`Loaded ${payrollRecords.length} payroll records from localStorage`);
                } catch (error) {
                    console.error('Error parsing payroll records from localStorage:', error);
                    // Initialize with empty array if there's an error
                    payrollRecords = [];
                }
            }

            const savedUserAccounts = localStorage.getItem('hrSystemUserAccounts');
            if (savedUserAccounts) {
                userAccounts = JSON.parse(savedUserAccounts);
                console.log(`Loaded ${userAccounts.length} user accounts from localStorage`);
            } else {
                // Generate user accounts for all employees if none exist
                generateUserAccounts();
            }
        }

        // Generate user accounts for all employees
        function generateUserAccounts() {
            // Create admin account
            userAccounts = [{
                username: 'admin',
                password: 'admin123',
                role: 'admin',
                employeeId: null
            }];

            // Create accounts for all employees
            employees.forEach(employee => {
                if (employee.email) {
                    // Check if account already exists
                    const existingAccount = userAccounts.find(account =>
                        account.employeeId === employee.id || account.username === employee.email
                    );

                    if (!existingAccount) {
                        userAccounts.push({
                            username: employee.email,
                            password: 'user123',
                            role: 'employee',
                            employeeId: employee.id
                        });
                    }
                }
            });

            // Save to localStorage
            localStorage.setItem('hrSystemUserAccounts', JSON.stringify(userAccounts));
            console.log(`Generated ${userAccounts.length} user accounts (including admin)`);
        }

        // Set theme (light/dark)
        function setTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                localStorage.setItem('hrSystemTheme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('hrSystemTheme', 'light');
            }
        }

        // --- Update dynamic data lists (departments, positions, managers) ---
        function updateDynamicDataLists() {
            departments = [...new Set(employees.map(e => e.department))].sort();
            positions = [...new Set(employees.map(e => e.position))].sort();
            managers = employees.filter(e => e.level === 'Manager');
        }

        // --- Navigation ---
        function showSection(sectionId) {
            document.querySelectorAll('#app-container main section').forEach(section => {
                section.classList.add('hidden');
            });
            const sectionToShow = document.getElementById(sectionId);
            if (sectionToShow) {
                 sectionToShow.classList.remove('hidden');
            }

            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
            const activeLink = document.getElementById(`nav-${sectionId}`);
             if(activeLink) {
                activeLink.classList.add('active');
             }

            // Re-initialize charts only if switching TO the dashboard
            if (sectionId === 'dashboard') {
                updateDashboard(); // Update dashboard with current filter state
            }
        }

        // Function to reset dashboard filters
        function resetDashboardFilters() {
            // Reset all filter dropdowns to default values
            document.getElementById('dept-filter-dash').value = 'all';
            document.getElementById('pos-filter-dash').value = 'all';
            document.getElementById('status-filter-dash').value = 'all';

            // Update dashboard with all data
            updateDashboard();
        }

        // Handle dashboard filter button click
        function handleDashboardFilter(button) {
            // Toggle the button color and check if we need to reset
            const wasActive = toggleFilterButtonColor(button, resetDashboardFilters);

            // Only apply filters if we're not resetting
            if (!wasActive) {
                updateDashboard();
            }
        }

        // --- Dashboard Update Logic (Handles Filters) ---
        function updateDashboard() {
            const selectedDept = document.getElementById('dept-filter-dash').value;
            const selectedPos = document.getElementById('pos-filter-dash').value;
            const selectedStatus = document.getElementById('status-filter-dash').value;

            // Remove onchange event handlers from the filter selects
            // This prevents the dashboard from updating automatically when a filter is changed
            document.getElementById('dept-filter-dash').removeAttribute('onchange');
            document.getElementById('pos-filter-dash').removeAttribute('onchange');
            document.getElementById('status-filter-dash').removeAttribute('onchange');

            // Filter employees based on dashboard selections
            const filteredEmployees = employees.filter(emp => {
                const matchesDept = selectedDept === 'all' || emp.department === selectedDept;
                const matchesPos = selectedPos === 'all' || emp.position === selectedPos;
                const matchesStatus = selectedStatus === 'all' || emp.status === selectedStatus;
                return matchesDept && matchesPos && matchesStatus;
            });

            // Update stats and charts with the filtered data
            updateDashboardStats(filteredEmployees);
            initializeDashboardCharts(filteredEmployees);
        }


        // --- Dashboard Stats and Charts ---
        function updateDashboardStats(currentEmployees = employees) { // Accepts filtered list
            const totalEmployees = currentEmployees.length;
            const activeEmployees = currentEmployees.filter(e => e.status === 'Active').length;
            const inactiveEmployees = totalEmployees - activeEmployees;
            // Calculate turnover based ONLY on the currently filtered subset's inactive members
            const resignations = currentEmployees.filter(e => e.status === 'Inactive' && e.resignDate).length;
            const turnoverRate = totalEmployees > 0 ? ((resignations / totalEmployees) * 100).toFixed(1) : 0;

            // Calculate average leaves based on the departments PRESENT in the filtered list
            const currentDepartments = [...new Set(currentEmployees.map(e => e.department))];
            const leavesByDept = {};
            currentDepartments.forEach(dept => leavesByDept[dept] = { totalLeaves: 0, employeeCount: 0 });

            // Count leaves ONLY for employees in the filtered list
            leaveRecords.forEach(lr => {
                 const emp = currentEmployees.find(e => e.id === lr.employeeId); // Check against filtered list
                 if(emp && emp.department && leavesByDept[emp.department]){
                     leavesByDept[emp.department].totalLeaves += lr.days;
                 }
            });
             // Count employees per dept ONLY from the filtered list
             currentEmployees.forEach(emp => {
                 if(emp.department && leavesByDept[emp.department]){
                    leavesByDept[emp.department].employeeCount++;
                 }
             });

            let totalAvgLeaves = 0;
            let deptsWithLeaves = 0;
             Object.values(leavesByDept).forEach(deptData => {
                 if(deptData.employeeCount > 0){
                     const avg = deptData.totalLeaves / deptData.employeeCount;
                     totalAvgLeaves += avg;
                     deptsWithLeaves++;
                 }
             });
            const avgLeaves = deptsWithLeaves > 0 ? (totalAvgLeaves / deptsWithLeaves).toFixed(1) : 0;

            document.getElementById('stat-total-employees').textContent = totalEmployees;
            document.getElementById('stat-active-employees').textContent = activeEmployees;
            document.getElementById('stat-avg-leaves').textContent = avgLeaves;
            document.getElementById('stat-turnover').textContent = `${turnoverRate}%`;
        }

        function initializeDashboardCharts(currentEmployees = employees) { // Accepts filtered list
            const ctxDept = document.getElementById('deptChart')?.getContext('2d');
            const ctxLevel = document.getElementById('levelChart')?.getContext('2d');
            const ctxHiring = document.getElementById('hiringChart')?.getContext('2d');
            const ctxLeavesDept = document.getElementById('leavesDeptChart')?.getContext('2d');
            const ctxGender = document.getElementById('genderChart')?.getContext('2d');
            const ctxAge = document.getElementById('ageChart')?.getContext('2d');
            const ctxMonthlyHiring = document.getElementById('monthlyHiringChart')?.getContext('2d');

            if (!ctxDept || !ctxLevel || !ctxHiring || !ctxLeavesDept || !ctxGender || !ctxAge || !ctxMonthlyHiring) return;

            // --- Data processing based on currentEmployees ---
            const currentDepartments = [...new Set(currentEmployees.map(e => e.department))].sort();

            const deptCounts = currentDepartments.reduce((acc, dept) => {
                acc[dept] = currentEmployees.filter(e => e.department === dept).length;
                return acc;
            }, {});

            const levelCounts = currentEmployees.reduce((acc, emp) => {
                acc[emp.level] = (acc[emp.level] || 0) + 1;
                return acc;
            }, { 'Manager': 0, 'Non-manager': 0 });

             const genderCounts = currentEmployees.reduce((acc, emp) => { // Calculate gender counts
                acc[emp.gender] = (acc[emp.gender] || 0) + 1;
                return acc;
            }, { 'Male': 0, 'Female': 0 }); // Initialize to show labels even if count is 0

            const hiringTrends = currentEmployees.reduce((acc, emp) => {
                 if (emp.hiringDate) {
                    const year = new Date(emp.hiringDate).getFullYear();
                    acc[year] = (acc[year] || 0) + 1;
                 }
                return acc;
            }, {});
            const sortedYears = Object.keys(hiringTrends).sort((a, b) => a - b);
            const hiringData = sortedYears.map(year => hiringTrends[year]);

            const leavesPerDept = currentDepartments.reduce((acc, dept) => { // Use currentDepartments
                acc[dept] = leaveRecords
                    .filter(lr => currentEmployees.find(e => e.id === lr.employeeId && e.department === dept)) // Filter leaves based on currentEmployees
                    .reduce((sum, lr) => sum + lr.days, 0);
                return acc;
            }, {});

            // --- Destroy existing charts ---
            if (deptChartInstance) deptChartInstance.destroy();
            if (levelChartInstance) levelChartInstance.destroy();
            if (hiringChartInstance) hiringChartInstance.destroy();
            if (leavesDeptChartInstance) leavesDeptChartInstance.destroy();
            if (genderChartInstance) genderChartInstance.destroy();
            if (ageChartInstance) ageChartInstance.destroy();
            if (monthlyHiringChartInstance) monthlyHiringChartInstance.destroy();

            // --- Create new charts ---
            const chartOptions = {
                 responsive: true,
                 maintainAspectRatio: false, // Allow chart to fill container height
                 scales: { y: { beginAtZero: true } } // Default Y-axis options
            };
            const pieChartOptions = { responsive: true, maintainAspectRatio: false };


            deptChartInstance = new Chart(ctxDept, {
                type: 'bar',
                data: { labels: Object.keys(deptCounts), datasets: [{ label: '# of Employees', data: Object.values(deptCounts), backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, borderRadius: 5 }] },
                options: { ...chartOptions, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } // Integer steps for employee counts
            });

            levelChartInstance = new Chart(ctxLevel, {
                type: 'pie',
                data: { labels: Object.keys(levelCounts), datasets: [{ label: 'Employee Levels', data: Object.values(levelCounts), backgroundColor: ['rgba(16, 185, 129, 0.7)', 'rgba(245, 158, 11, 0.7)'], borderColor: ['rgba(16, 185, 129, 1)', 'rgba(245, 158, 11, 1)'], borderWidth: 1 }] },
                 options: pieChartOptions
            });

             // New Gender Chart
             genderChartInstance = new Chart(ctxGender, {
                type: 'pie', // Or 'doughnut'
                data: {
                    labels: Object.keys(genderCounts),
                    datasets: [{
                        label: 'Gender Distribution',
                        data: Object.values(genderCounts),
                        backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(236, 72, 153, 0.7)'], // Blue, Pink
                        borderColor: ['rgba(59, 130, 246, 1)', 'rgba(236, 72, 153, 1)'],
                        borderWidth: 1
                    }]
                },
                options: pieChartOptions
            });

            hiringChartInstance = new Chart(ctxHiring, {
                type: 'line',
                data: { labels: sortedYears, datasets: [{ label: 'New Hires per Year', data: hiringData, fill: false, borderColor: 'rgb(75, 192, 192)', tension: 0.1 }] },
                 options: { ...chartOptions, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } // Integer steps for hire counts
            });

             leavesDeptChartInstance = new Chart(ctxLeavesDept, {
                type: 'bar',
                data: { labels: Object.keys(leavesPerDept), datasets: [{ label: 'Total Leave Days', data: Object.values(leavesPerDept), backgroundColor: 'rgba(239, 68, 68, 0.7)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 1, borderRadius: 5 }] },
                options: chartOptions
            });

            // Age Distribution Chart (Doughnut)
            // Calculate age from DOB
            function calculateAge(dob) {
                const birthDate = new Date(dob);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            }

            // Define age segments
            const ageSegments = {
                'Below 20': 0,
                '20-25': 0,
                '25-30': 0,
                '30-35': 0,
                '35-40': 0,
                '40-45': 0,
                '45-50': 0,
                'Above 50': 0
            };

            // Count employees in each age segment
            currentEmployees.forEach(emp => {
                if (emp.dob) {
                    const age = calculateAge(emp.dob);
                    if (age < 20) ageSegments['Below 20']++;
                    else if (age >= 20 && age < 25) ageSegments['20-25']++;
                    else if (age >= 25 && age < 30) ageSegments['25-30']++;
                    else if (age >= 30 && age < 35) ageSegments['30-35']++;
                    else if (age >= 35 && age < 40) ageSegments['35-40']++;
                    else if (age >= 40 && age < 45) ageSegments['40-45']++;
                    else if (age >= 45 && age < 50) ageSegments['45-50']++;
                    else ageSegments['Above 50']++;
                }
            });

            // Create age distribution chart
            ageChartInstance = new Chart(ctxAge, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(ageSegments),
                    datasets: [{
                        label: 'Age Distribution',
                        data: Object.values(ageSegments),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(199, 199, 199, 0.7)',
                            'rgba(83, 102, 255, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(199, 199, 199, 1)',
                            'rgba(83, 102, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                padding: 15
                            }
                        },
                        title: {
                            display: true,
                            text: 'Employee Age Distribution',
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            });

            // Monthly Hiring vs Resigns Chart (Year to Date)
            const currentYear = new Date().getFullYear();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const currentMonth = new Date().getMonth(); // 0-11

            // Initialize monthly data arrays
            const hiresPerMonth = Array(12).fill(0);
            const resignsPerMonth = Array(12).fill(0);

            // Count hires and resigns per month for current year
            currentEmployees.forEach(emp => {
                if (emp.hiringDate) {
                    const hireDate = new Date(emp.hiringDate);
                    if (hireDate.getFullYear() === currentYear) {
                        hiresPerMonth[hireDate.getMonth()]++;
                    }
                }

                if (emp.resignDate) {
                    const resignDate = new Date(emp.resignDate);
                    if (resignDate.getFullYear() === currentYear) {
                        resignsPerMonth[resignDate.getMonth()]++;
                    }
                }
            });

            // Only include months up to the current month (YTD)
            const ytdMonthNames = monthNames.slice(0, currentMonth + 1);
            const ytdHiresData = hiresPerMonth.slice(0, currentMonth + 1);
            const ytdResignsData = resignsPerMonth.slice(0, currentMonth + 1);

            // Create monthly hiring vs resigns chart
            monthlyHiringChartInstance = new Chart(ctxMonthlyHiring, {
                type: 'bar',
                data: {
                    labels: ytdMonthNames,
                    datasets: [
                        {
                            label: 'Hires',
                            data: ytdHiresData,
                            backgroundColor: 'rgba(16, 185, 129, 0.7)', // Green
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        },
                        {
                            label: 'Resigns',
                            data: ytdResignsData,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)', // Red
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Number of Employees'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: `Months (${currentYear})`
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Year-to-Date Hires vs Resigns (${currentYear})`,
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                footer: (tooltipItems) => {
                                    const index = tooltipItems[0].dataIndex;
                                    const hires = ytdHiresData[index];
                                    const resigns = ytdResignsData[index];
                                    const netChange = hires - resigns;
                                    return `Net Change: ${netChange > 0 ? '+' : ''}${netChange}`;
                                }
                            }
                        }
                    }
                }
            });
        }


        // --- Employee Database ---
        function populateEmployeeTable(filteredEmployees = employees) {
            const tableBody = document.getElementById('employeeTableBody');
             if (!tableBody) return;
            tableBody.innerHTML = '';

            if (filteredEmployees.length === 0) {
                // Updated colspan to 18
                tableBody.innerHTML = '<tr><td colspan="18" class="text-center py-4 text-gray-500">No employees found matching criteria.</td></tr>';
                return;
            }

            filteredEmployees.forEach(emp => {
                const row = `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${emp.id}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">
                            <a href="#" onclick="openEmployeeCardModal('${emp.id}'); return false;" class="text-indigo-600 hover:text-indigo-900 hover:underline font-medium">
                                ${emp.fullName}
                            </a>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.gender || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${formatDate(emp.hiringDate)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.position}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.department}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${formatDate(emp.dob)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.phone || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.email || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.address || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.idNumber}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.socialInsurance || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${emp.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${emp.status}
                            </span>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.militaryStatus || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.level}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.directManager || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.resignDate ? formatDate(emp.resignDate) : 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.maritalStatus || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.faculty || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.gradYear || 'N/A'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${emp.annualLeaveBalance || '0'}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium space-x-2">
                            <button onclick="openEditEmployeeModal('${emp.id}')" class="text-indigo-600 hover:text-indigo-900" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteEmployee('${emp.id}')" class="text-red-600 hover:text-red-900" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        // Function to reset employee filters
        function resetEmployeeFilters() {
            // Reset all filter inputs to default values
            document.getElementById('search-db').value = '';
            document.getElementById('dept-filter-db').value = 'all';
            document.getElementById('status-filter-db').value = 'all';

            // Repopulate the table with all employees
            populateEmployeeTable();
        }

        // Handle employee filter button click
        function handleEmployeeFilter(button) {
            // Toggle the button color and check if we need to reset
            const wasActive = toggleFilterButtonColor(button, resetEmployeeFilters);

            // Only apply filters if we're not resetting
            if (!wasActive) {
                filterEmployeeTable();
            }
        }

        function filterEmployeeTable() {
            const searchTerm = document.getElementById('search-db').value.toLowerCase();
            const selectedDept = document.getElementById('dept-filter-db').value;
            const selectedStatus = document.getElementById('status-filter-db').value;

            const filtered = employees.filter(emp => {
                const nameMatch = emp.fullName.toLowerCase().includes(searchTerm);
                const codeMatch = emp.id.toLowerCase().includes(searchTerm);
                const posMatch = emp.position.toLowerCase().includes(searchTerm);
                const matchesSearch = searchTerm === '' || nameMatch || codeMatch || posMatch;

                const matchesDept = selectedDept === 'all' || emp.department === selectedDept;
                const matchesStatus = selectedStatus === 'all' || emp.status === selectedStatus;
                return matchesSearch && matchesDept && matchesStatus;
            });
            populateEmployeeTable(filtered);
        }

        function exportTableToExcel(tableID, filename = ''){
            const table = document.getElementById(tableID);
            if (!table) {
                 showMessage('Error: Could not find table to export.', 'error'); return;
            }
            // Clone table to exclude the 'Actions' column before export
            const tableClone = table.cloneNode(true);
            // Remove the last cell (Actions) from each row in the cloned table body
            const rows = tableClone.querySelectorAll('tbody tr');
            rows.forEach(row => {
                if (row.cells.length > 0) {
                     row.deleteCell(-1); // Delete the last cell
                }
            });
             // Remove the last header cell (Actions) from the cloned table head
             const headerRow = tableClone.querySelector('thead tr');
             if (headerRow && headerRow.cells.length > 0) {
                 headerRow.deleteCell(-1); // Delete the last header cell
             }


            const wb = XLSX.utils.table_to_book(tableClone, {sheet:"Employee Data"});
            filename = filename ? filename + '.xlsx' : 'employee_data.xlsx';
            XLSX.writeFile(wb, filename);
             showMessage('Table exported to Excel successfully!');
        }

        // Function to toggle filter button color and reset filters if needed
        function toggleFilterButtonColor(button, resetFunction) {
            // Check if the button is already active (red)
            const isActive = button.classList.contains('bg-red-600');

            if (isActive) {
                // If active, revert to original color
                button.classList.remove('bg-red-600', 'hover:bg-red-700');
                button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');

                // Reset all filters if a reset function was provided
                if (typeof resetFunction === 'function') {
                    resetFunction();
                }
            } else {
                // If not active, change to red
                button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                button.classList.add('bg-red-600', 'hover:bg-red-700');
            }

            return isActive; // Return whether it was active (so we know if we're resetting)
        }

        // Function to update leave summary based on filters
        function updateLeaveSummary(employeeId = 'all', month = 'all') {
            console.log('DEBUGGING LEAVE SUMMARY:');
            console.log('Employee ID:', employeeId);
            console.log('Month:', month);
            console.log('All leave records:', leaveRecords);

            const totalLeaveDaysElement = document.getElementById('total-leave-days');
            const remainingLeaveBalanceElement = document.getElementById('remaining-leave-balance');
            const usedLeavePercentageElement = document.getElementById('used-leave-percentage');

            if (!totalLeaveDaysElement || !remainingLeaveBalanceElement || !usedLeavePercentageElement) {
                console.error('Summary elements not found!');
                return;
            }

            // Get current year
            const currentYear = new Date().getFullYear();
            console.log('Current Year:', currentYear);

            // DIRECT CALCULATION: Get the filtered records based on the current filters
            let filteredRecords = [...leaveRecords];
            console.log('Initial records count:', filteredRecords.length);

            // Apply employee filter
            if (employeeId !== 'all') {
                console.log('Filtering for employee:', employeeId);
                filteredRecords = filteredRecords.filter(record => record.employeeId === employeeId);
                console.log('After employee filter, records count:', filteredRecords.length);
                console.log('Filtered records for employee:', filteredRecords);
            }

            // Apply month filter
            if (month !== 'all') {
                const monthNum = parseInt(month);
                console.log('Filtering for month:', monthNum);
                filteredRecords = filteredRecords.filter(record => {
                    const startDate = new Date(record.startDate);
                    const recordMonth = startDate.getMonth() + 1;
                    console.log(`Record ${record.id} date: ${record.startDate}, month: ${recordMonth}`);
                    return recordMonth === monthNum;
                });
                console.log('After month filter, records count:', filteredRecords.length);
            }

            // Filter for current year only
            console.log('Filtering for year:', currentYear);
            filteredRecords = filteredRecords.filter(record => {
                const startDate = new Date(record.startDate);
                const recordYear = startDate.getFullYear();
                console.log(`Record ${record.id} date: ${record.startDate}, year: ${recordYear}`);
                // Include only current year
                return recordYear === currentYear;
            });
            console.log('After year filter, records count:', filteredRecords.length);
            console.log('Final filtered records:', filteredRecords);

            // Calculate total leave days from filtered records (include ALL types, not just annual leave)
            // Only exclude rejected records
            let totalLeaveDays = 0;

            // Log all records to see what we're working with
            console.log('ALL FILTERED RECORDS:');
            filteredRecords.forEach(record => {
                console.log(`Record ID: ${record.id}, Type: ${record.type}, Status: ${record.status}, Days: ${record.days}`);
            });

            // Calculate total leave days including ALL types (annual, casual, sick, etc.)
            // IMPORTANT: Include ALL leave types, regardless of type
            filteredRecords.forEach(record => {
                if (record.status !== 'Rejected') {
                    const parsedDays = parseFloat(record.days || 0);
                    console.log(`Adding ${parsedDays} days from record ${record.id} (${record.type})`);
                    totalLeaveDays += parsedDays;
                } else {
                    console.log(`Skipping rejected record ${record.id} (${record.type})`);
                }
            });
            console.log('Calculated Total Leave Days (ALL types):', totalLeaveDays);

            // Calculate remaining leave balance
            let remainingLeaveBalance = 0;

            if (employeeId !== 'all') {
                // For a specific employee
                const employee = employees.find(e => e.id === employeeId);
                if (employee) {
                    remainingLeaveBalance = employee.annualLeaveBalance || 0;
                    console.log('Employee found:', employee.fullName);
                    console.log('Employee leave balance:', remainingLeaveBalance);
                } else {
                    console.error('Employee not found for ID:', employeeId);
                }
            } else {
                // For all employees
                let relevantEmployees = [...employees].filter(e => e.status === 'Active');
                console.log('Active employees count:', relevantEmployees.length);
                relevantEmployees.forEach(employee => {
                    if (employee.annualLeaveBalance !== null && employee.annualLeaveBalance !== undefined) {
                        remainingLeaveBalance += employee.annualLeaveBalance;
                        console.log(`Adding ${employee.annualLeaveBalance} from ${employee.fullName}`);
                    }
                });
                console.log('Total remaining balance for all employees:', remainingLeaveBalance);
            }

            // Calculate annual leave days only (for balance calculation)
            // NOTE: This is ONLY for the balance calculation, not for the total leave days
            let annualLeaveDays = 0;
            filteredRecords.forEach(record => {
                if (record.status !== 'Rejected') {
                    // Only include annual leave types for balance calculation
                    const leaveType = record.type.toLowerCase();
                    if (leaveType.includes('annual')) {
                        const parsedDays = parseFloat(record.days || 0);
                        console.log(`Adding ${parsedDays} ANNUAL days from record ${record.id} (${record.type})`);
                        annualLeaveDays += parsedDays;
                    }
                }
            });
            console.log('Annual Leave Days (for balance calculation):', annualLeaveDays);

            // Calculate total annual allowance and used percentage
            // Only use annual leave days for this calculation
            const totalAnnualAllowance = remainingLeaveBalance + annualLeaveDays;
            const usedPercentage = totalAnnualAllowance > 0 ? Math.round((annualLeaveDays / totalAnnualAllowance) * 100) : 0;
            console.log('Total Annual Allowance:', totalAnnualAllowance);
            console.log('Used Percentage:', usedPercentage);

            // Update the UI
            totalLeaveDaysElement.textContent = totalLeaveDays.toFixed(1);
            remainingLeaveBalanceElement.textContent = remainingLeaveBalance.toFixed(1);
            usedLeavePercentageElement.textContent = `${usedPercentage}%`;

            console.log('UI Updated with:');
            console.log('- Total Leave Days:', totalLeaveDays.toFixed(1));
            console.log('- Remaining Balance:', remainingLeaveBalance.toFixed(1));
            console.log('- Used Percentage:', `${usedPercentage}%`);
        }

        // Populates dropdowns in DB filters and Add/Edit modal
        function populateFilterDropdowns() {
            // Ensure lists are up-to-date
            updateDynamicDataLists();

            const deptFilterDb = document.getElementById('dept-filter-db');
            const managerSelectModal = document.getElementById('directManager');
            const leaveFilterDepartment = document.getElementById('leave-filter-department');

            // Get datalists for department and position
            const departmentList = document.getElementById('departmentList');
            const positionList = document.getElementById('positionList');

            // Clear existing options except 'All'/'Select...'
            deptFilterDb.innerHTML = '<option value="all">All</option>';
            managerSelectModal.innerHTML = '<option value="">Select Manager</option>';

            // No longer need to populate department dropdown for leave filter

            // Clear datalists
            departmentList.innerHTML = '';
            positionList.innerHTML = '';

            // Populate department datalist
            departments.forEach(dept => {
                deptFilterDb.appendChild(new Option(dept, dept));

                // Add to datalist
                const option = document.createElement('option');
                option.value = dept;
                departmentList.appendChild(option);
            });

            // Populate position datalist
            positions.forEach(pos => {
                // Add to datalist
                const option = document.createElement('option');
                option.value = pos;
                positionList.appendChild(option);
            });

            managers.forEach(manager => {
                 managerSelectModal.appendChild(new Option(`${manager.fullName} (${manager.id})`, manager.fullName));
            });
        }

        // Populates dropdowns ONLY for the dashboard filters
        function populateDashboardFilterDropdowns() {
             updateDynamicDataLists(); // Ensure lists are fresh

             const deptFilterDash = document.getElementById('dept-filter-dash');
             const posFilterDash = document.getElementById('pos-filter-dash');

             // Clear existing options except 'All'
             deptFilterDash.innerHTML = '<option value="all">All Departments</option>';
             posFilterDash.innerHTML = '<option value="all">All Positions</option>';

             departments.forEach(dept => {
                 deptFilterDash.appendChild(new Option(dept, dept));
             });
             positions.forEach(pos => {
                 posFilterDash.appendChild(new Option(pos, pos));
             });
        }

        // --- Employee Modal (Add/Edit) ---
        function openAddEmployeeModal() {
            document.getElementById('employeeForm').reset();
            document.getElementById('employeeId').value = '';
            document.getElementById('modalTitle').textContent = 'Add New Employee';
            document.getElementById('empCode').readOnly = false;
            // Repopulate department dropdown in modal in case it changed
            populateFilterDropdowns();
            document.getElementById('employeeModal').classList.remove('hidden');
            initializeModalDatePickers();
        }

         function openEditEmployeeModal(employeeId) {
            const emp = employees.find(e => e.id === employeeId);
            if (!emp) return;

            // Repopulate dropdowns before setting values
            populateFilterDropdowns();

            document.getElementById('employeeId').value = emp.id;
            document.getElementById('modalTitle').textContent = 'Edit Employee';
            document.getElementById('empCode').value = emp.id;
            document.getElementById('empCode').readOnly = true;
            document.getElementById('fullName').value = emp.fullName;
            document.getElementById('gender').value = emp.gender || ''; // Set gender
            document.getElementById('position').value = emp.position;
            document.getElementById('department').value = emp.department; // Set department
            document.getElementById('idNumber').value = emp.idNumber;
            document.getElementById('socialInsurance').value = emp.socialInsurance || '';
            document.getElementById('status').value = emp.status;
            document.getElementById('militaryStatus').value = emp.militaryStatus || '';
            document.getElementById('level').value = emp.level;
            document.getElementById('directManager').value = emp.directManager || '';
            document.getElementById('maritalStatus').value = emp.maritalStatus || '';
            document.getElementById('faculty').value = emp.faculty || '';
            document.getElementById('gradYear').value = emp.gradYear || '';

             initializeModalDatePickers();
             flatpickr("#hiringDate").setDate(emp.hiringDate, true);
             flatpickr("#dob").setDate(emp.dob, true);
             flatpickr("#resignDate").setDate(emp.resignDate || '', true);

            document.getElementById('employeeModal').classList.remove('hidden');
        }

        function closeEmployeeModal() {
            document.getElementById('employeeModal').classList.add('hidden');
        }

        // Employee Card Modal Functions
        let currentCardEmployeeId = null;

        function openEmployeeCardModal(employeeId) {
            const emp = employees.find(e => e.id === employeeId);
            if (!emp) return;

            currentCardEmployeeId = employeeId;

            // Populate the employee card content
            const cardContent = document.getElementById('employeeCardContent');

            // Create a visually appealing card with all employee details
            const cardHTML = `
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg shadow-inner">
                    <div class="flex flex-col md:flex-row md:items-start">
                        <div class="flex-shrink-0 mb-4 md:mb-0 md:mr-6">
                            <div class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-700 text-3xl font-bold border-2 border-indigo-300">
                                ${emp.fullName.split(' ').map(n => n[0]).join('')}
                            </div>
                        </div>
                        <div class="flex-grow">
                            <h2 class="text-2xl font-bold text-gray-800 mb-1">${emp.fullName}</h2>
                            <div class="flex items-center mb-3">
                                <span class="px-2 py-1 text-xs rounded-full ${emp.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} mr-2">
                                    ${emp.status}
                                </span>
                                <span class="text-gray-600">${emp.position}  ${emp.department}</span>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div class="space-y-3">
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Employee ID</h3>
                                        <p class="text-gray-800">${emp.id}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Gender</h3>
                                        <p class="text-gray-800">${emp.gender || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Date of Birth</h3>
                                        <p class="text-gray-800">${formatDate(emp.dob)}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Hiring Date</h3>
                                        <p class="text-gray-800">${formatDate(emp.hiringDate)}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Level</h3>
                                        <p class="text-gray-800">${emp.level}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Direct Manager</h3>
                                        <p class="text-gray-800">${emp.directManager || 'N/A'}</p>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Phone</h3>
                                        <p class="text-gray-800">${emp.phone || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Email</h3>
                                        <p class="text-gray-800">${emp.email || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">ID Number</h3>
                                        <p class="text-gray-800">${emp.idNumber}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Social Insurance</h3>
                                        <p class="text-gray-800">${emp.socialInsurance || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Military Status</h3>
                                        <p class="text-gray-800">${emp.militaryStatus || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Marital Status</h3>
                                        <p class="text-gray-800">${emp.maritalStatus || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Address</h3>
                                        <p class="text-gray-800">${emp.address || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Education</h3>
                                        <p class="text-gray-800">${emp.faculty ? `${emp.faculty} (${emp.gradYear || 'N/A'})` : 'N/A'}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Annual Leave Balance</h3>
                                        <p class="text-xl font-semibold text-blue-600">${emp.annualLeaveBalance || '0'} days</p>
                                    </div>
                                    ${emp.resignDate ? `
                                    <div>
                                        <h3 class="text-xs font-semibold text-gray-500 uppercase">Resignation Date</h3>
                                        <p class="text-xl font-semibold text-red-600">${formatDate(emp.resignDate)}</p>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            cardContent.innerHTML = cardHTML;

            // Show the modal
            document.getElementById('employeeCardModal').classList.remove('hidden');
        }

        function closeEmployeeCardModal() {
            document.getElementById('employeeCardModal').classList.add('hidden');
            currentCardEmployeeId = null;
        }

        function openEditEmployeeModalFromCard() {
            if (currentCardEmployeeId) {
                closeEmployeeCardModal();
                openEditEmployeeModal(currentCardEmployeeId);
            }
        }

        function handleEmployeeFormSubmit(event) {
            event.preventDefault();
            const employeeId = document.getElementById('employeeId').value;
            const isEditing = !!employeeId;
            const empCode = document.getElementById('empCode').value.trim();

            if (!empCode) { showMessage('Employee Code is required.', 'error'); return; }
            if (!isEditing && employees.some(e => e.id === empCode)) { showMessage('Employee code already exists.', 'error'); return; }
            if (!document.getElementById('gender').value) { showMessage('Gender is required.', 'error'); return; }
            if (!document.getElementById('phone').value) { showMessage('Phone number is required.', 'error'); return; }
            if (!document.getElementById('email').value) { showMessage('Email address is required.', 'error'); return; }
            if (!document.getElementById('address').value) { showMessage('Address is required.', 'error'); return; }
            // Add more validation...

            // Get department and position values
            const departmentValue = document.getElementById('department').value.trim();
            const positionValue = document.getElementById('position').value.trim();

            // Check if department and position are provided
            if (!departmentValue) { showMessage('Department is required.', 'error'); return; }
            if (!positionValue) { showMessage('Position is required.', 'error'); return; }

            const formData = {
                id: isEditing ? employeeId : empCode,
                fullName: document.getElementById('fullName').value,
                gender: document.getElementById('gender').value,
                hiringDate: document.getElementById('hiringDate').value,
                position: positionValue,
                department: departmentValue,
                dob: document.getElementById('dob').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                address: document.getElementById('address').value,
                idNumber: document.getElementById('idNumber').value,
                socialInsurance: document.getElementById('socialInsurance').value || null,
                status: document.getElementById('status').value,
                militaryStatus: document.getElementById('militaryStatus').value || null,
                level: document.getElementById('level').value,
                directManager: document.getElementById('directManager').value || null,
                resignDate: document.getElementById('resignDate').value || null,
                maritalStatus: document.getElementById('maritalStatus').value || null,
                faculty: document.getElementById('faculty').value || null,
                gradYear: document.getElementById('gradYear').value ? parseInt(document.getElementById('gradYear').value) : null,
                annualLeaveBalance: document.getElementById('leaveBalance').value ? parseInt(document.getElementById('leaveBalance').value) : null,
            };

            if (isEditing) {
                const index = employees.findIndex(e => e.id === employeeId);
                if (index !== -1) {
                    employees[index] = formData;
                    showMessage('Employee updated successfully!');
                } else {
                    showMessage('Error updating employee.', 'error');
                    return;
                }
            } else {
                employees.push(formData);
                showMessage('Employee added successfully!');
            }

            // Check if a new department was added
            if (!departments.includes(departmentValue)) {
                console.log(`New department added: ${departmentValue}`);
                showMessage(`New department "${departmentValue}" has been added.`, 'success');
            }

            // Check if a new position was added
            if (!positions.includes(positionValue)) {
                console.log(`New position added: ${positionValue}`);
                showMessage(`New position "${positionValue}" has been added.`, 'success');
            }

            // Save to localStorage to persist data
            localStorage.setItem('hrSystemEmployees', JSON.stringify(employees));

            // Create or update user account for the employee
            const email = document.getElementById('email').value.trim();
            if (email) {
                // Check if user account already exists
                const existingAccountIndex = userAccounts.findIndex(account =>
                    account.employeeId === formData.id || account.username === email
                );

                if (existingAccountIndex !== -1) {
                    // Update existing account
                    userAccounts[existingAccountIndex] = {
                        ...userAccounts[existingAccountIndex],
                        username: email,
                        employeeId: formData.id,
                        role: 'employee'
                    };
                } else {
                    // Create new account
                    userAccounts.push({
                        username: email,
                        password: 'user123',
                        role: 'employee',
                        employeeId: formData.id
                    });
                }

                // Save user accounts to localStorage
                localStorage.setItem('hrSystemUserAccounts', JSON.stringify(userAccounts));
            }

            // Refresh UI
            updateDynamicDataLists(); // Update lists like departments, positions
            populateFilterDropdowns(); // Update ALL dropdowns
            populateDashboardFilterDropdowns(); // Update dashboard dropdowns specifically
            populateEmployeeTable(); // Update DB table
            updateDashboard(); // Update dashboard stats & charts
            closeEmployeeModal();
        }

        function deleteEmployee(employeeId) {
            if (confirm(`Are you sure you want to delete employee ${employeeId}? This action cannot be undone.`)) {
                const index = employees.findIndex(e => e.id === employeeId);
                if (index !== -1) {
                    // Get the employee's email before deleting
                    const employeeEmail = employees[index].email;

                    // Delete the employee
                    employees.splice(index, 1);

                    // Delete related records
                    leaveRecords = leaveRecords.filter(lr => lr.employeeId !== employeeId);
                    excuseRecords = excuseRecords.filter(er => er.employeeId !== employeeId);
                    overtimeRecords = overtimeRecords.filter(or => or.employeeId !== employeeId);
                    penaltyRecords = penaltyRecords.filter(pr => pr.employeeId !== employeeId);

                    // Delete user account
                    if (employeeEmail) {
                        const accountIndex = userAccounts.findIndex(account =>
                            account.employeeId === employeeId || account.username === employeeEmail
                        );

                        if (accountIndex !== -1) {
                            userAccounts.splice(accountIndex, 1);
                            localStorage.setItem('hrSystemUserAccounts', JSON.stringify(userAccounts));
                        }
                    }

                    // Save to localStorage
                    localStorage.setItem('hrSystemEmployees', JSON.stringify(employees));
                    localStorage.setItem('hrSystemLeaves', JSON.stringify(leaveRecords));
                    localStorage.setItem('hrSystemExcuses', JSON.stringify(excuseRecords));
                    localStorage.setItem('hrSystemOvertime', JSON.stringify(overtimeRecords));
                    localStorage.setItem('hrSystemPenalties', JSON.stringify(penaltyRecords));

                    // Refresh UI
                    updateDynamicDataLists();
                    populateFilterDropdowns();
                    populateDashboardFilterDropdowns();
                    populateEmployeeTable();
                    populateLeaveTable();
                    populateExcuseTable();
                    populateOvertimeTable();
                    populatePenaltyTable();
                    populateSalaryTable();
                    updateDashboard(); // Update dashboard after deletion
                    showMessage(`Employee ${employeeId} deleted successfully.`);
                } else {
                    showMessage(`Error: Employee ${employeeId} not found.`, 'error');
                }
            }
        }


        // --- Employee Leaves ---
        function populateLeaveTable() {
            const tableBody = document.getElementById('leaveTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            if (leaveRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No leave records found.</td></tr>';
                return;
            }

            // Get filter values
            const employeeFilter = document.getElementById('leave-filter-employee').value;
            const monthFilter = document.getElementById('leave-filter-month').value;

            // Get current year
            const currentYear = new Date().getFullYear();

            // DIRECT CALCULATION: Get the filtered records based on the current filters
            let filteredRecords = [...leaveRecords];

            // Apply employee filter
            if (employeeFilter !== 'all') {
                filteredRecords = filteredRecords.filter(record => record.employeeId === employeeFilter);
            }

            // Apply month filter
            if (monthFilter !== 'all') {
                const monthNum = parseInt(monthFilter);
                filteredRecords = filteredRecords.filter(record => {
                    const startDate = new Date(record.startDate);
                    return startDate.getMonth() + 1 === monthNum;
                });
            }

            // IMPORTANT: For demo purposes, we'll include 2024 records as well
            // This is because our mock data has records from 2024
            filteredRecords = filteredRecords.filter(record => {
                const startDate = new Date(record.startDate);
                const recordYear = startDate.getFullYear();
                // Include both current year and 2024 (for demo data)
                return recordYear === currentYear || recordYear === 2024;
            });

            // Sort by date (newest first)
            filteredRecords.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

            // Check if we have any records after filtering
            if (filteredRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No leave records found with the selected filters.</td></tr>';

                // Make sure to update the leave summary even when no records are found
                updateLeaveSummary(employeeFilter, monthFilter);
                return;
            }

            // Populate table with filtered records
            filteredRecords.forEach(record => {
                const statusColor = record.status === 'Approved' ? 'bg-green-100 text-green-800' : (record.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800');
                const empName = employees.find(e => e.id === record.employeeId)?.fullName || record.employeeId;

                // Format days display to show "0.5" as "Half Day"
                let daysDisplay = parseFloat(record.days);
                if (daysDisplay === 0.5) {
                    daysDisplay = '<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">Half Day</span>';
                }

                // Only show action buttons for admin users
                const actionButtons = currentUserRole === 'admin' ? `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="editLeaveRecord('${record.id}')" class="text-indigo-600 hover:text-indigo-900" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteLeaveRecord('${record.id}')" class="text-red-600 hover:text-red-900" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                        ${record.status === 'Pending' ? `
                        <button onclick="approveLeaveRecord('${record.id}')" class="text-green-600 hover:text-green-900" title="Approve">
                            <i class="fas fa-check"></i>
                        </button>
                        <button onclick="rejectLeaveRecord('${record.id}')" class="text-red-600 hover:text-red-900" title="Reject">
                            <i class="fas fa-times"></i>
                        </button>
                        ` : ''}
                    </td>
                ` : `<td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">-</td>`;

                const row = `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${empName}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${formatDate(record.startDate)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${formatDate(record.endDate)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${daysDisplay}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${record.type}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${record.status}
                            </span>
                        </td>
                        ${actionButtons}
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Update leave summary based on the same filters
            updateLeaveSummary(employeeFilter, monthFilter);
        }

        function handleLeaveFormSubmit(event) {
            event.preventDefault();
            const employeeCode = document.getElementById('leave-employee-code').value.trim();
            const employeeId = document.getElementById('leave-employee').value;
            const startDate = document.getElementById('leave-start-date').value;
            const endDate = document.getElementById('leave-end-date').value;
            const leaveType = document.getElementById('leave-type').value;
            const leaveDays = parseFloat(document.getElementById('leave-days').value);
            const editId = document.getElementById('leave-edit-id')?.value;

            if (!employeeCode || !startDate || !endDate) {
                showMessage('Please enter employee code and select dates.', 'error');
                return;
            }

            if (!employeeId) {
                showMessage('Invalid employee code. Please enter a valid employee code.', 'error');
                return;
            }

            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                showMessage('Selected employee not found.', 'error');
                return;
            }

            // Validate that selected days match calendar selection
            const calculatedDays = calculateLeaveDays(startDate, endDate);
            if (calculatedDays !== leaveDays) {
                showMessage(`Selected days (${leaveDays}) don't match calendar selection (${calculatedDays} days)`, 'error');
                return;
            }

            // Set status based on current user role
            const status = currentUserRole === 'admin' ? 'Approved' : 'Pending';

            // For annual leave, check if employee has sufficient balance
            if (leaveType === 'annual') {
                console.log('Processing annual leave:', leaveType);

                // Get the employee's current leave balance
                const currentBalance = employee.annualLeaveBalance;
                console.log('Current leave balance:', currentBalance);

                // Check if employee has a leave balance set
                if (currentBalance === null || currentBalance === undefined) {
                    showMessage(`Employee has no leave balance set. Please have an admin set a leave balance first.`, 'error');
                    return;
                }

                if (currentBalance < leaveDays) {
                    showMessage(`Insufficient leave balance (${currentBalance.toFixed(1)} days). Requested: ${leaveDays} days.`, 'error');
                    return;
                }

                // For new records, deduct the leave days from the employee's balance immediately if approved
                if (!editId && status === 'Approved') {
                    console.log(`Deducting ${leaveDays} days from balance. Current: ${currentBalance}`);
                    // Deduct the leave days from the employee's balance
                    employee.annualLeaveBalance = currentBalance - leaveDays;
                    console.log(`New balance: ${employee.annualLeaveBalance}`);
                }
            }

            // Check if we're editing an existing record
            if (editId) {
                // Find the existing record
                const recordIndex = leaveRecords.findIndex(r => r.id == editId);
                if (recordIndex === -1) {
                    showMessage('Record not found.', 'error');
                    return;
                }

                // Check if we're changing the status from Approved to something else or vice versa
                const oldRecord = leaveRecords[recordIndex];
                const oldStatus = oldRecord.status;
                const newStatus = status;
                const isAnnualLeave = oldRecord.type.toLowerCase().includes('annual');

                // If changing from Approved to Rejected/Pending and it's annual leave, restore balance
                if (oldStatus === 'Approved' && newStatus !== 'Approved' && isAnnualLeave) {
                    // Restore the leave balance
                    const currentBalance = employee.annualLeaveBalance || 0;
                    employee.annualLeaveBalance = currentBalance + oldRecord.days;
                    showMessage(`Leave status changed. ${oldRecord.days} day(s) restored to ${employee.fullName}'s leave balance.`);
                }
                // If changing from Rejected/Pending to Approved and it's annual leave, deduct from balance
                else if (oldStatus !== 'Approved' && newStatus === 'Approved' && isAnnualLeave) {
                    // Check if employee has sufficient balance
                    const currentBalance = employee.annualLeaveBalance || 0;
                    if (currentBalance < leaveDays) {
                        showMessage(`Insufficient leave balance (${currentBalance.toFixed(1)} days). Requested: ${leaveDays} days.`, 'error');
                        return;
                    }

                    // Deduct from leave balance
                    employee.annualLeaveBalance = currentBalance - leaveDays;
                    showMessage(`Leave status changed. ${leaveDays} day(s) deducted from ${employee.fullName}'s leave balance.`);
                }

                // Update the record
                leaveRecords[recordIndex] = {
                    ...leaveRecords[recordIndex],
                    employeeId: employeeId,
                    employeeName: employee.fullName,
                    startDate: startDate,
                    endDate: endDate,
                    days: leaveDays,
                    type: document.getElementById('leave-type').options[document.getElementById('leave-type').selectedIndex].text,
                    status: status
                };

                // Remove the edit ID field
                document.getElementById('leave-edit-id').remove();

                // Change the submit button text back
                const submitBtn = document.querySelector('#leave-form button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Submit Leave';
                }

                // Remove the cancel button
                const cancelBtn = document.getElementById('leave-cancel-edit');
                if (cancelBtn) {
                    cancelBtn.remove();
                }

                showMessage('Leave record updated successfully!');
            } else {
                // Create a new record
                const newRecord = {
                    id: Date.now(),
                    employeeId: employeeId,
                    employeeName: employee.fullName,
                    startDate: startDate,
                    endDate: endDate,
                    days: leaveDays,
                    type: document.getElementById('leave-type').options[document.getElementById('leave-type').selectedIndex].text,
                    status: status
                };

                leaveRecords.push(newRecord);
                showMessage('Leave request submitted successfully!');
            }

            // Save to localStorage
            localStorage.setItem('hrSystemEmployees', JSON.stringify(employees));
            localStorage.setItem('hrSystemLeaves', JSON.stringify(leaveRecords));

            populateLeaveTable();
            updateDashboard(); // Update dashboard as leaves affect stats/charts

            // Update leave summary with current filters
            const employeeFilter = document.getElementById('leave-filter-employee').value;
            const monthFilter = document.getElementById('leave-filter-month').value;
            updateLeaveSummary(employeeFilter, monthFilter);

            document.getElementById('leave-form').reset();
            document.getElementById('leave-employee-name').value = '';
            document.getElementById('leave-balance').value = '';

            // Hide the leave form container after submission
            document.getElementById('leave-form-container').classList.add('hidden');
        }

        // Global variables for excuses, overtime, and penalties
        let excuseRecords = [
            { id: 1, employeeId: 'EMP001', employeeName: 'Alice Wonderland', date: '2024-03-15', type: 'Late Check-in', startTime: '10:00 AM', endTime: '11:00 AM', reason: 'Traffic jam on highway', status: 'Approved' },
            { id: 2, employeeId: 'EMP003', employeeName: 'Charlie Chaplin', date: '2024-04-05', type: 'Early Check-out', startTime: '3:00 PM', endTime: '5:00 PM', reason: 'Doctor appointment', status: 'Approved' },
            { id: 3, employeeId: 'EMP005', employeeName: 'Ethan Hunt', date: '2024-05-10', type: 'Outdoor Task', startTime: '1:00 PM', endTime: '4:00 PM', reason: 'Client meeting downtown', status: 'Pending' }
        ];

        let overtimeRecords = [
            { id: 1, employeeId: 'EMP001', employeeName: 'Alice Wonderland', date: '2024-03-20', startTime: '5:00 PM', endTime: '8:00 PM', hours: 3, reason: 'Project deadline', status: 'Approved' },
            { id: 2, employeeId: 'EMP003', employeeName: 'Charlie Chaplin', date: '2024-04-10', startTime: '6:00 PM', endTime: '9:00 PM', hours: 3, reason: 'System maintenance', status: 'Approved' },
            { id: 3, employeeId: 'EMP005', employeeName: 'Ethan Hunt', date: '2024-05-15', startTime: '5:00 PM', endTime: '7:00 PM', hours: 2, reason: 'Client emergency', status: 'Pending' }
        ];

        let penaltyRecords = [
            { id: 1, employeeId: 'EMP007', employeeName: 'Grace Hopper', date: '2024-02-20', days: 1, reason: 'Unauthorized absence', status: 'Approved' },
            { id: 2, employeeId: 'EMP003', employeeName: 'Charlie Chaplin', date: '2024-03-10', days: 0.5, reason: 'Late arrival without excuse', status: 'Approved' },
            { id: 3, employeeId: 'EMP005', employeeName: 'Ethan Hunt', date: '2024-04-15', days: 2, reason: 'Violation of company policy', status: 'Pending' }
        ];

        // Initialize salary records with default data
        // This will be overridden by localStorage if data exists
        let salaryRecords = [
            { id: 1, employeeId: 'EMP001', employeeName: 'Alice Wonderland', totalSalary: 5000, basicSalary: 4000, fixedAllowance: 1000, fixedDeduction: 200, bankName: 'First National Bank', accountNumber: '1234567890' },
            { id: 2, employeeId: 'EMP002', employeeName: 'Bob The Builder', totalSalary: 7500, basicSalary: 6000, fixedAllowance: 1500, fixedDeduction: 300, bankName: 'City Bank', accountNumber: '0987654321' },
            { id: 3, employeeId: 'EMP004', employeeName: 'Diana Prince', totalSalary: 8000, basicSalary: 6500, fixedAllowance: 1500, fixedDeduction: 350, bankName: 'Global Bank', accountNumber: '5678901234' }
        ];

        // Initialize payroll records
        let payrollRecords = [];

        // Handle excuse form submission
        function handleExcuseFormSubmit(event) {
            event.preventDefault();
            const employeeCode = document.getElementById('excuse-employee-code').value.trim();
            const employeeId = document.getElementById('excuse-employee').value;
            const excuseDate = document.getElementById('excuse-date').value;
            const excuseType = document.getElementById('excuse-type').value;
            const startTime = document.getElementById('excuse-start-time').value;
            const endTime = document.getElementById('excuse-end-time').value;
            const startTimeDisplay = document.getElementById('excuse-start-time-display').value;
            const endTimeDisplay = document.getElementById('excuse-end-time-display').value;
            const excuseReason = document.getElementById('excuse-reason').value;
            const editId = document.getElementById('excuse-edit-id')?.value;

            if (!employeeCode || !excuseDate) {
                showMessage('Please enter employee code and date.', 'error');
                return;
            }

            if (!startTime || !endTime) {
                showMessage('Please select both start and end times.', 'error');
                return;
            }

            if (!employeeId) {
                showMessage('Invalid employee code. Please enter a valid employee code.', 'error');
                return;
            }

            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                showMessage('Selected employee not found.', 'error');
                return;
            }

            // Validate that end time is after start time
            if (startTime && endTime) {
                const startHour = parseInt(startTime.split(':')[0]);
                const endHour = parseInt(endTime.split(':')[0]);

                if (endHour < startHour) {
                    showMessage('End time must be after start time.', 'error');
                    return;
                }

                if (startHour === endHour) {
                    showMessage('Start and end times cannot be the same.', 'error');
                    return;
                }
            }

            // Set status based on current user role
            const status = currentUserRole === 'admin' ? 'Approved' : 'Pending';

            // Check if we're editing an existing record
            if (editId) {
                // Find the existing record
                const recordIndex = excuseRecords.findIndex(r => r.id == editId);
                if (recordIndex === -1) {
                    showMessage('Record not found.', 'error');
                    return;
                }

                // Update the record
                excuseRecords[recordIndex] = {
                    ...excuseRecords[recordIndex],
                    employeeId: employeeId,
                    employeeName: employee.fullName,
                    date: excuseDate,
                    type: document.getElementById('excuse-type').options[document.getElementById('excuse-type').selectedIndex].text,
                    startTime: startTimeDisplay,
                    endTime: endTimeDisplay,
                    reason: excuseReason || 'No reason provided',
                    status: status
                };

                // Remove the edit ID field
                document.getElementById('excuse-edit-id').remove();

                // Change the submit button text back
                const submitBtn = document.querySelector('#excuse-form button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Submit Excuse Request';
                }

                // Remove the cancel button
                const cancelBtn = document.getElementById('excuse-cancel-edit');
                if (cancelBtn) {
                    cancelBtn.remove();
                }

                showMessage('Excuse record updated successfully!');
            } else {
                // Create new excuse record
                const newExcuse = {
                    id: Date.now(),
                    employeeId: employeeId,
                    employeeName: employee.fullName,
                    date: excuseDate,
                    type: document.getElementById('excuse-type').options[document.getElementById('excuse-type').selectedIndex].text,
                    startTime: startTimeDisplay,
                    endTime: endTimeDisplay,
                    reason: excuseReason || 'No reason provided',
                    status: status
                };

                // Add to records
                if (!excuseRecords) excuseRecords = [];
                excuseRecords.push(newExcuse);

                showMessage('Excuse request submitted successfully!');
            }

            // Save to localStorage
            localStorage.setItem('hrSystemExcuses', JSON.stringify(excuseRecords));

            // Update UI
            populateExcuseTable();
            updateExcuseSummary();

            // Reset form
            document.getElementById('excuse-form').reset();
            document.getElementById('excuse-employee-name').value = '';

            // Hide the form container
            document.getElementById('excuse-form-container').classList.add('hidden');
        }

        // Function to validate and auto-correct penalty days to nearest 0.25 increment
        function validatePenaltyDays(value) {
            // Parse the input value to a float
            let days = parseFloat(value);

            // Check if it's a valid number
            if (isNaN(days) || days < 0.25) {
                return 0.25; // Minimum value
            }

            // Round to nearest 0.25 increment
            return Math.round(days * 4) / 4;
        }

        // Handle penalty form submission
        function handlePenaltyFormSubmit(event) {
            event.preventDefault();
            const employeeCode = document.getElementById('penalty-employee-code').value.trim();
            const employeeId = document.getElementById('penalty-employee').value;
            const penaltyDate = document.getElementById('penalty-date').value;

            // Get the penalty days value and validate/auto-correct it
            const penaltyDaysInput = document.getElementById('penalty-days');
            const penaltyDays = validatePenaltyDays(penaltyDaysInput.value);

            // Update the input field with the corrected value
            penaltyDaysInput.value = penaltyDays;

            const penaltyReason = document.getElementById('penalty-reason').value;
            const editId = document.getElementById('penalty-edit-id')?.value;

            if (!employeeCode || !penaltyDate) {
                showMessage('Please enter employee code and date.', 'error');
                return;
            }

            if (!employeeId) {
                showMessage('Invalid employee code. Please enter a valid employee code.', 'error');
                return;
            }

            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                showMessage('Selected employee not found.', 'error');
                return;
            }

            // Set status based on current user role
            const status = currentUserRole === 'admin' ? 'Approved' : 'Pending';

            // Check if we're editing an existing record
            if (editId) {
                // Find the existing record
                const recordIndex = penaltyRecords.findIndex(r => r.id == editId);
                if (recordIndex === -1) {
                    showMessage('Record not found.', 'error');
                    return;
                }

                // Update the record
                penaltyRecords[recordIndex] = {
                    ...penaltyRecords[recordIndex],
                    employeeId: employeeId,
                    employeeName: employee.fullName,
                    date: penaltyDate,
                    days: penaltyDays,
                    reason: penaltyReason,
                    status: status
                };

                // Remove the edit ID field
                document.getElementById('penalty-edit-id').remove();

                // Change the submit button text back
                const submitBtn = document.querySelector('#penalty-form button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Submit Penalty';
                }

                // Remove the cancel button
                const cancelBtn = document.getElementById('penalty-cancel-edit');
                if (cancelBtn) {
                    cancelBtn.remove();
                }

                showMessage('Penalty record updated successfully!');
            } else {
                // Create new penalty record
                const newPenalty = {
                    id: Date.now(),
                    employeeId: employeeId,
                    employeeName: employee.fullName,
                    date: penaltyDate,
                    days: penaltyDays,
                    reason: penaltyReason,
                    status: status
                };

                // Add to records
                if (!penaltyRecords) penaltyRecords = [];
                penaltyRecords.push(newPenalty);

                showMessage('Penalty added successfully!');
            }

            // Save to localStorage
            localStorage.setItem('hrSystemPenalties', JSON.stringify(penaltyRecords));

            // Update UI
            populatePenaltyTable();
            updatePenaltySummary();

            // Reset form
            document.getElementById('penalty-form').reset();
            document.getElementById('penalty-employee-name').value = '';

            // Hide the form container
            document.getElementById('penalty-form-container').classList.add('hidden');
        }

        // Handle overtime form submission
        function handleOvertimeFormSubmit(event) {
            event.preventDefault();
            const employeeCode = document.getElementById('overtime-employee-code').value.trim();
            const employeeId = document.getElementById('overtime-employee').value;
            const overtimeDate = document.getElementById('overtime-date').value;
            const startTime = document.getElementById('overtime-start-time').value;
            const endTime = document.getElementById('overtime-end-time').value;
            const startTimeDisplay = document.getElementById('overtime-start-time-display').value;
            const endTimeDisplay = document.getElementById('overtime-end-time-display').value;
            const overtimeReason = document.getElementById('overtime-reason').value;
            const editId = document.getElementById('overtime-edit-id')?.value;

            if (!employeeCode || !overtimeDate) {
                showMessage('Please enter employee code and date.', 'error');
                return;
            }

            if (!startTime || !endTime) {
                showMessage('Please select both start and end times.', 'error');
                return;
            }

            if (!employeeId) {
                showMessage('Invalid employee code. Please enter a valid employee code.', 'error');
                return;
            }

            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                showMessage('Selected employee not found.', 'error');
                return;
            }

            // Validate that end time is after start time
            if (startTime && endTime) {
                const startHour = parseInt(startTime.split(':')[0]);
                const endHour = parseInt(endTime.split(':')[0]);

                if (endHour <= startHour) {
                    showMessage('End time must be after start time.', 'error');
                    return;
                }
            }

            // Calculate hours
            const startHour = parseInt(startTime.split(':')[0]);
            const endHour = parseInt(endTime.split(':')[0]);
            const hours = endHour - startHour;

            // Set status based on current user role
            const status = currentUserRole === 'admin' ? 'Approved' : 'Pending';

            // Check if we're editing an existing record
            if (editId) {
                // Find the existing record
                const recordIndex = overtimeRecords.findIndex(r => r.id == editId);
                if (recordIndex === -1) {
                    showMessage('Record not found.', 'error');
                    return;
                }

                // Update the record
                overtimeRecords[recordIndex] = {
                    ...overtimeRecords[recordIndex],
                    employeeId: employeeId,
                    employeeName: employee.fullName,
                    date: overtimeDate,
                    startTime: startTimeDisplay,
                    endTime: endTimeDisplay,
                    hours: hours,
                    reason: overtimeReason || 'No reason provided',
                    status: status
                };

                // Remove the edit ID field
                document.getElementById('overtime-edit-id').remove();

                // Change the submit button text back
                const submitBtn = document.querySelector('#overtime-form button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Submit Overtime Request';
                }

                // Remove the cancel button
                const cancelBtn = document.getElementById('overtime-cancel-edit');
                if (cancelBtn) {
                    cancelBtn.remove();
                }

                showMessage('Overtime record updated successfully!');
            } else {
                // Create new overtime record
                const newOvertime = {
                    id: Date.now(),
                    employeeId: employeeId,
                    employeeName: employee.fullName,
                    date: overtimeDate,
                    startTime: startTimeDisplay,
                    endTime: endTimeDisplay,
                    hours: hours,
                    reason: overtimeReason || 'No reason provided',
                    status: status
                };

                // Add to records
                if (!overtimeRecords) overtimeRecords = [];
                overtimeRecords.push(newOvertime);

                showMessage('Overtime request submitted successfully!');
            }

            // Save to localStorage
            localStorage.setItem('hrSystemOvertime', JSON.stringify(overtimeRecords));

            // Update UI
            populateOvertimeTable();
            updateOvertimeSummary();

            // Reset form
            document.getElementById('overtime-form').reset();
            document.getElementById('overtime-employee-name').value = '';

            // Hide the form container
            document.getElementById('overtime-form-container').classList.add('hidden');
        }

        // Edit overtime record
        function editOvertimeRecord(recordId) {
            // Find the record
            const record = overtimeRecords.find(r => r.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Populate the overtime form with the record data
            document.getElementById('overtime-employee-code').value = record.employeeId;
            document.getElementById('overtime-employee-name').value = record.employeeName;
            document.getElementById('overtime-employee').value = record.employeeId;

            // Set the date
            document.getElementById('overtime-date').value = record.date;

            // Set the time
            if (record.startTime) {
                document.getElementById('overtime-start-time-display').value = record.startTime;
            }
            if (record.endTime) {
                document.getElementById('overtime-end-time-display').value = record.endTime;
            }

            // Set the reason
            document.getElementById('overtime-reason').value = record.reason || '';

            // Show the overtime section and make the form visible
            showSection('overtime');
            document.getElementById('overtime-form-container').classList.remove('hidden');
            document.getElementById('overtime-form').scrollIntoView({ behavior: 'smooth' });

            // Add a hidden field to track that we're editing
            let editIdField = document.getElementById('overtime-edit-id');
            if (!editIdField) {
                editIdField = document.createElement('input');
                editIdField.type = 'hidden';
                editIdField.id = 'overtime-edit-id';
                document.getElementById('overtime-form').appendChild(editIdField);
            }
            editIdField.value = recordId;

            // Change the submit button text
            const submitBtn = document.querySelector('#overtime-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Update Overtime Record';
            }

            // Add a cancel button if it doesn't exist
            if (!document.getElementById('overtime-cancel-edit')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.id = 'overtime-cancel-edit';
                cancelBtn.type = 'button';
                cancelBtn.className = 'px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150';
                cancelBtn.textContent = 'Cancel';
                cancelBtn.onclick = cancelOvertimeEdit;
                submitBtn.parentNode.insertBefore(cancelBtn, submitBtn);
            }
        }

        // Cancel overtime edit
        function cancelOvertimeEdit() {
            // Reset the form
            document.getElementById('overtime-form').reset();
            document.getElementById('overtime-employee-name').value = '';

            // Remove the edit ID field
            const editIdField = document.getElementById('overtime-edit-id');
            if (editIdField) {
                editIdField.remove();
            }

            // Change the submit button text back
            const submitBtn = document.querySelector('#overtime-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Submit Overtime Request';
            }

            // Remove the cancel button
            const cancelBtn = document.getElementById('overtime-cancel-edit');
            if (cancelBtn) {
                cancelBtn.remove();
            }

            // Hide the form container
            document.getElementById('overtime-form-container').classList.add('hidden');
        }

        // Delete overtime record
        function deleteOvertimeRecord(recordId) {
            if (!confirm('Are you sure you want to delete this overtime record?')) {
                return;
            }

            // Find the record index
            const recordIndex = overtimeRecords.findIndex(r => r.id == recordId);
            if (recordIndex === -1) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Remove the record
            overtimeRecords.splice(recordIndex, 1);

            // Save to localStorage
            localStorage.setItem('hrSystemOvertime', JSON.stringify(overtimeRecords));

            // Update the UI
            populateOvertimeTable();

            // Show success message
            showMessage('Overtime record deleted successfully.');
        }

        // Approve overtime record
        function approveOvertimeRecord(recordId) {
            // Find the record
            const record = overtimeRecords.find(r => r.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Update the status
            record.status = 'Approved';

            // Save to localStorage
            localStorage.setItem('hrSystemOvertime', JSON.stringify(overtimeRecords));

            // Update the UI
            populateOvertimeTable();

            // Show success message
            showMessage(`Overtime request for ${record.employeeName} has been approved.`);
        }

        // Reject overtime record
        function rejectOvertimeRecord(recordId) {
            if (!confirm('Are you sure you want to reject this overtime request?')) {
                return;
            }

            // Find the record
            const record = overtimeRecords.find(r => r.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Update the status
            record.status = 'Rejected';

            // Save to localStorage
            localStorage.setItem('hrSystemOvertime', JSON.stringify(overtimeRecords));

            // Update the UI
            populateOvertimeTable();

            // Show success message
            showMessage(`Overtime request for ${record.employeeName} has been rejected.`);
        }

        // Populate overtime table
        function populateOvertimeTable() {
            const tableBody = document.getElementById('overtimeTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            if (!overtimeRecords || overtimeRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No overtime records found.</td></tr>';
                return;
            }

            // Get filter values
            const employeeFilter = document.getElementById('overtime-filter-employee').value;
            const monthFilter = document.getElementById('overtime-filter-month').value;

            // Get current year
            const currentYear = new Date().getFullYear();

            // Filter records
            let filteredRecords = [...overtimeRecords];

            // Apply employee filter
            if (employeeFilter !== 'all') {
                filteredRecords = filteredRecords.filter(record => record.employeeId === employeeFilter);
            }

            // Apply month filter
            if (monthFilter !== 'all') {
                const month = parseInt(monthFilter);
                console.log('Filtering overtime for month:', month);
                filteredRecords = filteredRecords.filter(record => {
                    const overtimeDate = new Date(record.date);
                    const recordMonth = overtimeDate.getMonth() + 1;
                    console.log(`Overtime record ${record.id} date: ${record.date}, month: ${recordMonth}`);
                    // Only filter by month, not by year
                    return recordMonth === month;
                });
                console.log('After month filter, overtime count:', filteredRecords.length);
            }

            filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

            filteredRecords.forEach(record => {
                const statusColor = record.status === 'Approved' ? 'bg-green-100 text-green-800' : (record.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800');

                // Handle both old and new time format
                let timeDisplay;
                if (record.startTime && record.endTime) {
                    timeDisplay = `${record.startTime} - ${record.endTime}`;
                } else if (record.time) {
                    timeDisplay = record.time;
                } else {
                    timeDisplay = 'N/A';
                }

                // Only show action buttons for admin users
                const actionButtons = currentUserRole === 'admin' ? `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="editOvertimeRecord('${record.id}')" class="text-indigo-600 hover:text-indigo-900" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteOvertimeRecord('${record.id}')" class="text-red-600 hover:text-red-900" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                        ${record.status === 'Pending' ? `
                        <button onclick="approveOvertimeRecord('${record.id}')" class="text-green-600 hover:text-green-900" title="Approve">
                            <i class="fas fa-check"></i>
                        </button>
                        <button onclick="rejectOvertimeRecord('${record.id}')" class="text-red-600 hover:text-red-900" title="Reject">
                            <i class="fas fa-times"></i>
                        </button>
                        ` : ''}
                    </td>
                ` : `<td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">-</td>`;

                const row = `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${record.employeeName}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${formatDate(record.date)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${timeDisplay}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${record.hours} hours</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${record.reason}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${record.status}
                            </span>
                        </td>
                        ${actionButtons}
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Update the overtime summary with the same filters
            // Note: We don't call updateOvertimeSummary here anymore as it's handled by the filter button
            // This prevents double-updating when the filter button is clicked
        }

        // Update overtime summary based on filters
        function updateOvertimeSummary(employeeId = 'all', month = 'all') {
            const currentYear = new Date().getFullYear();

            // Get the elements to update
            const totalMonthElement = document.getElementById('total-overtime-hours-month');
            const totalYearElement = document.getElementById('total-overtime-hours-year');

            if (!totalMonthElement || !totalYearElement) return;

            // Filter records for the current month
            const currentMonth = new Date().getMonth() + 1;
            let monthlyRecords = overtimeRecords.filter(record => {
                const recordDate = new Date(record.date);
                const recordMonth = recordDate.getMonth() + 1;
                console.log(`Overtime record ${record.id} date: ${record.date}, month: ${recordMonth}`);
                // Only filter by month, not by year
                return recordMonth === (month === 'all' ? currentMonth : parseInt(month)) &&
                       (employeeId === 'all' || record.employeeId === employeeId) &&
                       record.status === 'Approved';
            });
            console.log('Monthly overtime records count:', monthlyRecords.length);

            // Filter records for the current year
            let yearlyRecords = overtimeRecords.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate.getFullYear() === currentYear &&
                       (employeeId === 'all' || record.employeeId === employeeId) &&
                       record.status === 'Approved';
            });

            // Calculate total hours
            const totalMonthHours = monthlyRecords.reduce((total, record) => total + record.hours, 0);
            const totalYearHours = yearlyRecords.reduce((total, record) => total + record.hours, 0);

            // Update the UI
            totalMonthElement.textContent = totalMonthHours;
            totalYearElement.textContent = totalYearHours;
        }

        // Function to set up employee code validation for overtime filter
        function setupOvertimeFilterEmployeeCodeValidation() {
            const employeeCodeInput = document.getElementById('overtime-filter-employee-code');
            const employeeNameInput = document.getElementById('overtime-filter-employee-name');
            const employeeIdInput = document.getElementById('overtime-filter-employee');
            const applyFiltersButton = document.getElementById('overtime-filter-btn');

            if (!employeeCodeInput || !employeeNameInput || !employeeIdInput || !applyFiltersButton) return;

            employeeCodeInput.addEventListener('input', function() {
                const code = this.value.trim();

                // Reset fields if empty
                if (!code) {
                    employeeNameInput.value = '';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500', 'border-red-500');
                    return;
                }

                // Find employee by code
                const employee = employees.find(e => e.id.toLowerCase() === code.toLowerCase());

                if (employee) {
                    // Valid employee code
                    employeeNameInput.value = employee.fullName;
                    employeeIdInput.value = employee.id;
                    employeeNameInput.classList.remove('border-red-500');
                    employeeNameInput.classList.add('border-green-500');

                    // Update overtime summary immediately when a valid employee is selected
                    const monthFilter = document.getElementById('overtime-filter-month').value;
                    updateOvertimeSummary(employee.id, monthFilter);
                } else {
                    // Invalid employee code
                    employeeNameInput.value = 'Employee not found';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500');
                    employeeNameInput.classList.add('border-red-500');
                }
            });

            // Function to reset overtime filters
            function resetOvertimeFilters() {
                // Reset all filter dropdowns to default values
                document.getElementById('overtime-filter-employee-code').value = '';
                document.getElementById('overtime-filter-employee-name').value = '';
                document.getElementById('overtime-filter-employee').value = 'all';
                document.getElementById('overtime-filter-month').value = 'all';

                // Remove any styling from the employee name field
                document.getElementById('overtime-filter-employee-name').classList.remove('border-green-500', 'border-red-500');

                // Repopulate the table with all records
                populateOvertimeTable();
            }

            // Add click event listener to apply filters button
            applyFiltersButton.addEventListener('click', function() {
                // Toggle the button color and check if we need to reset
                const wasActive = toggleFilterButtonColor(this, resetOvertimeFilters);

                // Only apply filters if we're not resetting
                if (!wasActive) {
                    // Get the current filter values
                    const employeeId = document.getElementById('overtime-filter-employee').value;
                    const month = document.getElementById('overtime-filter-month').value;

                    // Update both the table and the summary with the same filters
                    populateOvertimeTable();
                    updateOvertimeSummary(employeeId, month);
                }
            });
        }

        // Validate employee code and update employee name for overtime form
        function setupOvertimeEmployeeCodeValidation() {
            const employeeCodeInput = document.getElementById('overtime-employee-code');
            const nameInput = document.getElementById('overtime-employee-name');
            const hiddenEmployeeInput = document.getElementById('overtime-employee');

            if (!employeeCodeInput || !nameInput || !hiddenEmployeeInput) return;

            employeeCodeInput.addEventListener('input', function() {
                const employeeCode = this.value.trim();

                // Reset fields
                nameInput.value = '';
                hiddenEmployeeInput.value = '';

                if (employeeCode) {
                    // Find employee by code
                    const employee = employees.find(e => e.id === employeeCode);

                    if (employee) {
                        // Valid employee code
                        nameInput.value = employee.fullName;
                        hiddenEmployeeInput.value = employee.id;

                        // Add success styling
                        nameInput.classList.remove('bg-red-50');
                        nameInput.classList.add('bg-green-50');
                    } else {
                        // Employee not found, show error styling
                        nameInput.value = 'Employee not found';
                        nameInput.classList.remove('bg-green-50');
                        nameInput.classList.add('bg-red-50');
                    }
                }
            });
        }

        // Set up filter buttons for excuse and penalty sections
        function addFilterButtonsToExcuseAndPenalty() {
            // Function to reset excuse filters
            function resetExcuseFilters() {
                // Reset all filter inputs to default values
                document.getElementById('excuse-filter-employee-code').value = '';
                document.getElementById('excuse-filter-employee-name').value = '';
                document.getElementById('excuse-filter-employee').value = 'all';
                document.getElementById('excuse-filter-month').value = 'all';

                // Remove any styling from the employee name field
                document.getElementById('excuse-filter-employee-name').classList.remove('border-green-500', 'border-red-500');

                // Repopulate the table with all records
                populateExcuseTable();

                // Update the summary with default values
                updateExcuseSummary('all', 'all');
            }

            // Function to reset penalty filters
            function resetPenaltyFilters() {
                // Reset all filter inputs to default values
                document.getElementById('penalty-filter-employee-code').value = '';
                document.getElementById('penalty-filter-employee-name').value = '';
                document.getElementById('penalty-filter-employee').value = 'all';
                document.getElementById('penalty-filter-month').value = 'all';

                // Remove any styling from the employee name field
                document.getElementById('penalty-filter-employee-name').classList.remove('border-green-500', 'border-red-500');

                // Repopulate the table with all records
                populatePenaltyTable();

                // Update the summary with default values
                updatePenaltySummary('all', 'all');
            }

            // Set up excuse filter button
            const excuseFilterBtn = document.getElementById('excuse-filter-btn');
            if (excuseFilterBtn) {
                // Remove any existing event listeners
                const newExcuseFilterBtn = excuseFilterBtn.cloneNode(true);
                excuseFilterBtn.parentNode.replaceChild(newExcuseFilterBtn, excuseFilterBtn);

                // Add event listener
                newExcuseFilterBtn.addEventListener('click', function() {
                    console.log('Excuse filter button clicked');
                    // Toggle the button color and check if we need to reset
                    const wasActive = toggleFilterButtonColor(this, resetExcuseFilters);
                    console.log('Was active:', wasActive);

                    // Only apply filters if we're not resetting
                    if (!wasActive) {
                        // Get the current filter values
                        const employeeId = document.getElementById('excuse-filter-employee').value;
                        const month = document.getElementById('excuse-filter-month').value;
                        console.log('Applying excuse filters:', { employeeId, month });

                        // Force the filter values to be applied
                        document.getElementById('excuse-filter-employee').value = employeeId;
                        document.getElementById('excuse-filter-month').value = month;

                        // Update both the table and the summary with the same filters
                        populateExcuseTable();
                        updateExcuseSummary(employeeId, month);
                    }
                });
            } else {
                console.error('Excuse filter button not found!');
            }

            // Set up penalty filter button
            const penaltyFilterBtn = document.getElementById('penalty-filter-btn');
            if (penaltyFilterBtn) {
                // Remove any existing event listeners
                const newPenaltyFilterBtn = penaltyFilterBtn.cloneNode(true);
                penaltyFilterBtn.parentNode.replaceChild(newPenaltyFilterBtn, penaltyFilterBtn);

                // Add event listener
                newPenaltyFilterBtn.addEventListener('click', function() {
                    console.log('Penalty filter button clicked');
                    // Toggle the button color and check if we need to reset
                    const wasActive = toggleFilterButtonColor(this, resetPenaltyFilters);
                    console.log('Was active:', wasActive);

                    // Only apply filters if we're not resetting
                    if (!wasActive) {
                        // Get the current filter values
                        const employeeId = document.getElementById('penalty-filter-employee').value;
                        const month = document.getElementById('penalty-filter-month').value;
                        console.log('Applying penalty filters:', { employeeId, month });

                        // Force the filter values to be applied
                        document.getElementById('penalty-filter-employee').value = employeeId;
                        document.getElementById('penalty-filter-month').value = month;

                        // Update both the table and the summary with the same filters
                        populatePenaltyTable();
                        updatePenaltySummary(employeeId, month);
                    }
                });
            } else {
                console.error('Penalty filter button not found!');
            }

            // Set up salary filter button
            const salaryFilterBtn = document.getElementById('salary-filter-btn');
            if (salaryFilterBtn) {
                // Remove any existing event listeners
                const newSalaryFilterBtn = salaryFilterBtn.cloneNode(true);
                salaryFilterBtn.parentNode.replaceChild(newSalaryFilterBtn, salaryFilterBtn);

                // Add event listener
                newSalaryFilterBtn.addEventListener('click', function() {
                    console.log('Salary filter button clicked');
                    // Toggle the button color and check if we need to reset
                    const wasActive = toggleFilterButtonColor(this, resetSalaryFilters);
                    console.log('Was active:', wasActive);

                    // Only apply filters if we're not resetting
                    if (!wasActive) {
                        // Get the current filter values
                        const employeeId = document.getElementById('salary-filter-employee').value;
                        console.log('Applying salary filters:', { employeeId });

                        // Force the filter values to be applied
                        document.getElementById('salary-filter-employee').value = employeeId;

                        // Update the table with the filters
                        populateSalaryTable();
                    }
                });
            } else {
                console.error('Salary filter button not found!');
            }

            // Remove onchange event listeners
            document.getElementById('excuse-filter-employee')?.removeAttribute('onchange');
            document.getElementById('excuse-filter-month')?.removeAttribute('onchange');
            document.getElementById('penalty-filter-employee')?.removeAttribute('onchange');
            document.getElementById('penalty-filter-month')?.removeAttribute('onchange');
        }

        // --- Salary Details Functions ---

        // Handle salary form submission
        function handleSalaryFormSubmit(event) {
            event.preventDefault();
            console.log('Salary form submitted');

            const employeeCode = document.getElementById('salary-employee-code').value.trim();
            const employeeId = document.getElementById('salary-employee').value;
            const totalSalary = parseFloat(document.getElementById('salary-total').value);
            const basicSalary = parseFloat(document.getElementById('salary-basic').value);
            const fixedAllowance = parseFloat(document.getElementById('salary-allowance').value) || 0;
            const fixedDeduction = parseFloat(document.getElementById('salary-deduction').value) || 0;
            const bankName = document.getElementById('salary-bank').value.trim();
            const accountNumber = document.getElementById('salary-account').value.trim();
            const editId = document.getElementById('salary-edit-id')?.value;

            console.log('Form data:', {
                employeeCode,
                employeeId,
                totalSalary,
                basicSalary,
                fixedAllowance,
                fixedDeduction,
                bankName,
                accountNumber,
                editId
            });

            if (!employeeCode) {
                showMessage('Please enter employee code.', 'error');
                return;
            }

            if (!employeeId) {
                showMessage('Invalid employee code. Please enter a valid employee code.', 'error');
                return;
            }

            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                showMessage('Selected employee not found.', 'error');
                return;
            }

            // Validate that the employee is active
            if (employee.status !== 'Active') {
                showMessage('Cannot add salary details for inactive employees.', 'error');
                return;
            }

            // Check if we're editing an existing record
            if (editId) {
                // Find the existing record
                const recordIndex = salaryRecords.findIndex(r => r.id == editId);
                if (recordIndex === -1) {
                    showMessage('Record not found.', 'error');
                    return;
                }

                // Update the record
                salaryRecords[recordIndex] = {
                    ...salaryRecords[recordIndex],
                    employeeId: employeeId,
                    employeeName: employee.fullName,
                    totalSalary: totalSalary,
                    basicSalary: basicSalary,
                    fixedAllowance: fixedAllowance,
                    fixedDeduction: fixedDeduction,
                    bankName: bankName,
                    accountNumber: accountNumber
                };

                // Remove the edit ID field
                document.getElementById('salary-edit-id').remove();

                // Change the submit button text back
                const submitBtn = document.querySelector('#salary-form button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'Save Salary Details';
                }

                // Remove the cancel button
                const cancelBtn = document.getElementById('salary-cancel-edit');
                if (cancelBtn) {
                    cancelBtn.remove();
                }

                showMessage('Salary details updated successfully!');
            } else {
                // Check if salary details already exist for this employee
                const existingSalary = salaryRecords.find(sr => sr.employeeId === employeeId);
                if (existingSalary) {
                    // Instead of showing an error, we'll update the existing record
                    existingSalary.totalSalary = totalSalary;
                    existingSalary.basicSalary = basicSalary;
                    existingSalary.fixedAllowance = fixedAllowance;
                    existingSalary.fixedDeduction = fixedDeduction;
                    existingSalary.bankName = bankName;
                    existingSalary.accountNumber = accountNumber;

                    showMessage('Existing salary details updated successfully!');
                } else {
                    // Create new salary record
                    const newSalary = {
                        id: Date.now(),
                        employeeId: employeeId,
                        employeeName: employee.fullName,
                        totalSalary: totalSalary,
                        basicSalary: basicSalary,
                        fixedAllowance: fixedAllowance,
                        fixedDeduction: fixedDeduction,
                        bankName: bankName,
                        accountNumber: accountNumber
                    };

                    console.log('Creating new salary record:', newSalary);

                    // Add to records
                    if (!salaryRecords) {
                        console.log('Initializing empty salary records array');
                        salaryRecords = [];
                    }
                    salaryRecords.push(newSalary);
                    console.log('Updated salary records:', salaryRecords);

                    showMessage('Salary details added successfully!');
                }
            }

            // Save to localStorage
            console.log('Saving salary records to localStorage:', salaryRecords);
            localStorage.setItem('hrSystemSalary', JSON.stringify(salaryRecords));

            // Verify the data was saved correctly
            const savedData = localStorage.getItem('hrSystemSalary');
            console.log('Saved salary data in localStorage:', savedData);

            // Update UI
            populateSalaryTable();

            // Reset form
            document.getElementById('salary-form').reset();
            document.getElementById('salary-employee-name').value = '';

            // Hide the form container
            document.getElementById('salary-form-container').classList.add('hidden');
        }

        // Populate salary table
        function populateSalaryTable() {
            const tableBody = document.getElementById('salaryTableBody');
            if (!tableBody) {
                console.error('Salary table body not found!');
                return;
            }
            tableBody.innerHTML = '';

            console.log('Populating salary table...');
            console.log('Total employees:', employees.length);

            // Get filter values
            const employeeFilter = document.getElementById('salary-filter-employee')?.value || 'all';
            console.log('Employee filter:', employeeFilter);

            // Get all active employees
            let activeEmployees = employees.filter(emp => emp.status === 'Active');
            console.log('Active employees:', activeEmployees.length, activeEmployees);

            // Apply employee filter if specified
            if (employeeFilter !== 'all') {
                activeEmployees = activeEmployees.filter(emp => emp.id === employeeFilter);
                console.log('After employee filter, active employees:', activeEmployees.length);
            }

            // Sort employees by name
            activeEmployees.sort((a, b) => a.fullName.localeCompare(b.fullName));

            if (activeEmployees.length === 0) {
                console.warn('No active employees found to display in salary table');
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-500">No active employees found.</td></tr>';
                return;
            }

            // Check salary records
            console.log('Salary records:', salaryRecords);

            // Populate table with all active employees
            activeEmployees.forEach(employee => {
                // Check if employee has salary record
                const salaryRecord = salaryRecords.find(sr => sr.employeeId === employee.id);
                console.log(`Checking salary for ${employee.id} (${employee.fullName}):`, salaryRecord);

                if (salaryRecord) {
                    // Employee has salary record - show full details
                    const row = `
                        <tr class="hover:bg-gray-50 transition duration-150">
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${employee.id}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${employee.fullName}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${salaryRecord.totalSalary.toFixed(2)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${salaryRecord.basicSalary.toFixed(2)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${salaryRecord.fixedAllowance.toFixed(2)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${(salaryRecord.fixedDeduction || 0).toFixed(2)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${salaryRecord.bankName || 'N/A'}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${salaryRecord.accountNumber || 'N/A'}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium space-x-2">
                                <button onclick="editSalaryRecord(${salaryRecord.id})" class="text-indigo-600 hover:text-indigo-900" title="Edit"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteSalaryRecord(${salaryRecord.id})" class="text-red-600 hover:text-red-900" title="Delete"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                } else {
                    // Employee has no salary record - show empty fields with Add button
                    const row = `
                        <tr class="hover:bg-gray-50 transition duration-150 bg-gray-50">
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${employee.id}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${employee.fullName}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-400 italic">Not set</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-400 italic">Not set</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-400 italic">Not set</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-400 italic">Not set</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-400 italic">Not set</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-400 italic">Not set</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium">
                                <button onclick="addSalaryForEmployee('${employee.id}')" class="text-green-600 hover:text-green-900" title="Add Salary Details">
                                    <i class="fas fa-plus-circle"></i> Add
                                </button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                }
            });
        }

        // Function to add salary for a specific employee
        function addSalaryForEmployee(employeeId) {
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) {
                showMessage('Employee not found.', 'error');
                return;
            }

            // Populate the form with employee details
            document.getElementById('salary-employee-code').value = employee.id;
            document.getElementById('salary-employee-name').value = employee.fullName;
            document.getElementById('salary-employee').value = employee.id;

            // Show the form
            document.getElementById('salary-form-container').classList.remove('hidden');
            document.getElementById('salary-form').scrollIntoView({ behavior: 'smooth' });
        }

        // Edit salary record
        function editSalaryRecord(recordId) {
            const record = salaryRecords.find(sr => sr.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Populate the salary form with the record data
            document.getElementById('salary-employee-code').value = record.employeeId;
            document.getElementById('salary-employee-name').value = record.employeeName;
            document.getElementById('salary-employee').value = record.employeeId;
            document.getElementById('salary-total').value = record.totalSalary;
            document.getElementById('salary-basic').value = record.basicSalary;
            document.getElementById('salary-allowance').value = record.fixedAllowance || '';
            document.getElementById('salary-deduction').value = record.fixedDeduction || '';
            document.getElementById('salary-bank').value = record.bankName || '';
            document.getElementById('salary-account').value = record.accountNumber || '';

            // Show the salary section and make the form visible
            showSection('salary');
            document.getElementById('salary-form-container').classList.remove('hidden');
            document.getElementById('salary-form').scrollIntoView({ behavior: 'smooth' });

            // Add a hidden field to track that we're editing
            let editIdField = document.getElementById('salary-edit-id');
            if (!editIdField) {
                editIdField = document.createElement('input');
                editIdField.type = 'hidden';
                editIdField.id = 'salary-edit-id';
                document.getElementById('salary-form').appendChild(editIdField);
            }
            editIdField.value = recordId;

            // Change the submit button text
            const submitBtn = document.querySelector('#salary-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Update Salary Details';
            }

            // Add a cancel button if it doesn't exist
            if (!document.getElementById('salary-cancel-edit')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.id = 'salary-cancel-edit';
                cancelBtn.className = 'mt-3 w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md shadow transition duration-150';
                cancelBtn.textContent = 'Cancel Edit';
                cancelBtn.onclick = function() {
                    document.getElementById('salary-form').reset();
                    document.getElementById('salary-employee-name').value = '';
                    document.getElementById('salary-edit-id').remove();
                    this.remove();

                    // Change the submit button text back
                    const submitBtn = document.querySelector('#salary-form button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.textContent = 'Save Salary Details';
                    }

                    // Hide the form
                    document.getElementById('salary-form-container').classList.add('hidden');
                };

                document.getElementById('salary-form').appendChild(cancelBtn);
            }
        }

        // Delete salary record
        function deleteSalaryRecord(recordId) {
            if (confirm('Are you sure you want to delete this salary record? This action cannot be undone.')) {
                const index = salaryRecords.findIndex(sr => sr.id == recordId);
                if (index !== -1) {
                    salaryRecords.splice(index, 1);
                    localStorage.setItem('hrSystemSalary', JSON.stringify(salaryRecords));
                    populateSalaryTable();
                    showMessage('Salary record deleted successfully!');
                } else {
                    showMessage('Record not found.', 'error');
                }
            }
        }

        // Setup salary filter employee code validation
        function setupSalaryFilterEmployeeCodeValidation() {
            const employeeCodeInput = document.getElementById('salary-filter-employee-code');
            const employeeNameInput = document.getElementById('salary-filter-employee-name');
            const employeeIdInput = document.getElementById('salary-filter-employee');

            if (!employeeCodeInput || !employeeNameInput || !employeeIdInput) return;

            // Add input event listener to validate employee code
            employeeCodeInput.addEventListener('input', function() {
                const code = this.value.trim();

                // Reset fields if empty
                if (code === '') {
                    employeeNameInput.value = '';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500', 'border-red-500');
                    return;
                }

                // Find employee by code
                const employee = employees.find(e => e.id.toLowerCase() === code.toLowerCase());

                if (employee) {
                    // Valid employee code
                    employeeNameInput.value = employee.fullName;
                    employeeIdInput.value = employee.id;
                    employeeNameInput.classList.remove('border-red-500');
                    employeeNameInput.classList.add('border-green-500');
                } else {
                    // Invalid employee code
                    employeeNameInput.value = 'Employee not found';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500');
                    employeeNameInput.classList.add('border-red-500');
                }
            });
        }

        // Validate employee code and update employee name for salary form
        function setupSalaryEmployeeCodeValidation() {
            const employeeCodeInput = document.getElementById('salary-employee-code');
            const nameInput = document.getElementById('salary-employee-name');
            const hiddenEmployeeInput = document.getElementById('salary-employee');

            if (!employeeCodeInput || !nameInput || !hiddenEmployeeInput) return;

            employeeCodeInput.addEventListener('input', function() {
                const employeeCode = this.value.trim();

                // Reset fields
                nameInput.value = '';
                hiddenEmployeeInput.value = '';

                if (!employeeCode) return;

                // Find employee by code
                const employee = employees.find(e => e.id.toLowerCase() === employeeCode.toLowerCase());

                if (employee) {
                    // Valid employee code
                    nameInput.value = employee.fullName;
                    hiddenEmployeeInput.value = employee.id;
                    nameInput.classList.remove('border-red-500');
                    nameInput.classList.add('border-green-500');

                    // Check if employee is active
                    if (employee.status !== 'Active') {
                        showMessage('Warning: This employee is not active.', 'error');
                    }
                } else {
                    // Invalid employee code
                    nameInput.value = 'Employee not found';
                    nameInput.classList.remove('border-green-500');
                    nameInput.classList.add('border-red-500');
                }
            });
        }

        // Function to reset salary filters
        function resetSalaryFilters() {
            // Reset all filter inputs to default values
            document.getElementById('salary-filter-employee-code').value = '';
            document.getElementById('salary-filter-employee-name').value = '';
            document.getElementById('salary-filter-employee').value = 'all';

            // Remove any styling from the employee name field
            document.getElementById('salary-filter-employee-name').classList.remove('border-green-500', 'border-red-500');

            // Repopulate the table with all records
            populateSalaryTable();
        }

        // Populate excuse table
        function populateExcuseTable() {
            const tableBody = document.getElementById('excuseTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            if (!excuseRecords || excuseRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No excuse records found.</td></tr>';
                return;
            }

            // Get filter values
            const employeeFilter = document.getElementById('excuse-filter-employee').value;
            const monthFilter = document.getElementById('excuse-filter-month').value;

            console.log('Populating excuse table with filters:', { employeeFilter, monthFilter });

            // Get current year
            const currentYear = new Date().getFullYear();

            // Filter records
            let filteredRecords = [...excuseRecords];
            console.log('Total excuse records before filtering:', filteredRecords.length);

            // Apply employee filter
            if (employeeFilter !== 'all') {
                console.log('Applying employee filter:', employeeFilter);
                filteredRecords = filteredRecords.filter(record => record.employeeId === employeeFilter);
                console.log('Records after employee filter:', filteredRecords.length);
            }

            // Filter for current year
            filteredRecords = filteredRecords.filter(record => {
                const excuseDate = new Date(record.date);
                return excuseDate.getFullYear() === currentYear;
            });
            console.log('After year filter, excuses count:', filteredRecords.length);

            // Apply month filter
            if (monthFilter !== 'all') {
                const month = parseInt(monthFilter);
                console.log('Filtering excuses for month:', month);
                filteredRecords = filteredRecords.filter(record => {
                    const excuseDate = new Date(record.date);
                    const recordMonth = excuseDate.getMonth() + 1;
                    console.log(`Excuse record ${record.id} date: ${record.date}, month: ${recordMonth}`);
                    return recordMonth === month;
                });
                console.log('After month filter, excuses count:', filteredRecords.length);
            }

            filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

            filteredRecords.forEach(record => {
                const statusColor = record.status === 'Approved' ? 'bg-green-100 text-green-800' : (record.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800');

                // Handle both old and new time format
                let timeDisplay;
                if (record.startTime && record.endTime) {
                    timeDisplay = `${record.startTime} - ${record.endTime}`;
                } else if (record.time) {
                    timeDisplay = record.time;
                } else {
                    timeDisplay = 'N/A';
                }

                // Only show action buttons for admin users
                const actionButtons = currentUserRole === 'admin' ? `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="editExcuseRecord('${record.id}')" class="text-indigo-600 hover:text-indigo-900" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteExcuseRecord('${record.id}')" class="text-red-600 hover:text-red-900" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                ` : `<td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">-</td>`;

                const row = `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${record.employeeName}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${formatDate(record.date)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${record.type}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${timeDisplay}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${record.reason}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${record.status}
                            </span>
                        </td>
                        ${actionButtons}
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Update the excuse summary with the same filters
            // Note: We don't call updateExcuseSummary here anymore as it's handled by the filter button
            // This prevents double-updating when the filter button is clicked
        }

        // Populate penalty table
        function populatePenaltyTable() {
            const tableBody = document.getElementById('penaltyTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = '';

            if (!penaltyRecords || penaltyRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No penalty records found.</td></tr>';
                return;
            }

            // Get filter values
            const employeeFilter = document.getElementById('penalty-filter-employee').value;
            const monthFilter = document.getElementById('penalty-filter-month').value;

            console.log('Populating penalty table with filters:', { employeeFilter, monthFilter });

            // Get current year
            const currentYear = new Date().getFullYear();

            // Filter records
            let filteredRecords = [...penaltyRecords];
            console.log('Total penalty records before filtering:', filteredRecords.length);

            // Apply employee filter
            if (employeeFilter !== 'all') {
                console.log('Applying employee filter:', employeeFilter);
                filteredRecords = filteredRecords.filter(record => record.employeeId === employeeFilter);
                console.log('Records after employee filter:', filteredRecords.length);
            }

            // Filter for current year
            filteredRecords = filteredRecords.filter(record => {
                const penaltyDate = new Date(record.date);
                return penaltyDate.getFullYear() === currentYear;
            });
            console.log('After year filter, penalties count:', filteredRecords.length);

            // Apply month filter
            if (monthFilter !== 'all') {
                const month = parseInt(monthFilter);
                console.log('Filtering penalties for month:', month);
                filteredRecords = filteredRecords.filter(record => {
                    const penaltyDate = new Date(record.date);
                    const recordMonth = penaltyDate.getMonth() + 1;
                    console.log(`Penalty record ${record.id} date: ${record.date}, month: ${recordMonth}`);
                    return recordMonth === month;
                });
                console.log('After month filter, penalties count:', filteredRecords.length);
            }

            filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

            filteredRecords.forEach(record => {
                // Format days display to show "0.5" as "Half Day"
                let daysDisplay = record.days;
                if (record.days === 0.5) {
                    daysDisplay = '<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">Half Day</span>';
                }

                // Determine status color
                const statusColor = record.status === 'Approved' ? 'bg-green-100 text-green-800' : (record.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800');

                // Only show action buttons for admin users
                const actionButtons = currentUserRole === 'admin' ? `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="editPenaltyRecord('${record.id}')" class="text-indigo-600 hover:text-indigo-900" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deletePenaltyRecord('${record.id}')" class="text-red-600 hover:text-red-900" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                ` : `<td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">-</td>`;

                const row = `
                    <tr class="hover:bg-gray-50 transition duration-150">
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${record.employeeName}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${formatDate(record.date)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${daysDisplay}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${record.reason}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                ${record.status || 'Pending'}
                            </span>
                        </td>
                        ${actionButtons}
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

            // Update the penalty summary with the same filters
            // Note: We don't call updatePenaltySummary here anymore as it's handled by the filter button
            // This prevents double-updating when the filter button is clicked
        }

        // Update excuse summary based on filters
        function updateExcuseSummary(employeeId = 'all', month = 'all') {
            console.log('Updating excuse summary with filters:', { employeeId, month });
            const currentYear = new Date().getFullYear();

            // Get the elements to update
            const totalMonthElement = document.getElementById('total-excuses-month');
            const totalYearElement = document.getElementById('total-excuses-year');

            if (!totalMonthElement || !totalYearElement) return;

            // Filter records based on parameters
            let filteredRecords = [...excuseRecords];
            console.log('Total excuse records:', filteredRecords.length);

            // Apply employee filter
            if (employeeId !== 'all') {
                console.log('Filtering for employee:', employeeId);
                filteredRecords = filteredRecords.filter(record => record.employeeId === employeeId);
                console.log('After employee filter, records count:', filteredRecords.length);
            }

            // Filter for current year only
            filteredRecords = filteredRecords.filter(record => {
                const date = new Date(record.date);
                return date.getFullYear() === currentYear;
            });
            console.log('After year filter, records count:', filteredRecords.length);

            // Calculate total for the selected month (or current month if none selected)
            let selectedMonth = month !== 'all' ? parseInt(month) : new Date().getMonth() + 1;
            console.log('Selected month for summary:', selectedMonth);

            // Calculate total excuses for the selected month (current year only)
            const totalMonthExcuses = filteredRecords
                .filter(er => {
                    const date = new Date(er.date);
                    const recordMonth = date.getMonth() + 1;
                    console.log(`Record ${er.id} date: ${er.date}, month: ${recordMonth}`);
                    return recordMonth === selectedMonth;
                }).length;
            console.log('Total month excuses:', totalMonthExcuses);

            // Calculate total excuses for the current year
            const totalYearExcuses = filteredRecords.length;
            console.log('Total year excuses:', totalYearExcuses);

            // Update the summary display
            totalMonthElement.textContent = totalMonthExcuses;
            totalYearElement.textContent = totalYearExcuses;

            // Update the month label to show which month is being displayed
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const monthLabel = document.querySelector('.bg-blue-50 h3');

            if (monthLabel) {
                if (month !== 'all') {
                    monthLabel.textContent = `${monthNames[selectedMonth - 1]} ${currentYear} Excuses`;
                } else {
                    monthLabel.textContent = 'Current Month Excuses';
                }
            }
        }

        // --- Record Management Functions ---

        // Edit leave record
        function editLeaveRecord(recordId) {
            // Find the record
            const record = leaveRecords.find(r => r.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Populate the leave form with the record data
            document.getElementById('leave-employee-code').value = record.employeeId;
            document.getElementById('leave-employee-name').value = record.employeeName;
            document.getElementById('leave-employee').value = record.employeeId;

            // Set the leave balance
            const employee = employees.find(e => e.id === record.employeeId);
            if (employee) {
                document.getElementById('leave-balance').value = employee.annualLeaveBalance || 0;
            }

            // Set the dates
            document.getElementById('leave-start-date').value = record.startDate;
            document.getElementById('leave-end-date').value = record.endDate;

            // Set the days
            const daysSelect = document.getElementById('leave-days');
            for (let i = 0; i < daysSelect.options.length; i++) {
                if (parseFloat(daysSelect.options[i].value) === record.days) {
                    daysSelect.selectedIndex = i;
                    break;
                }
            }

            // Set the type
            const typeSelect = document.getElementById('leave-type');
            for (let i = 0; i < typeSelect.options.length; i++) {
                if (typeSelect.options[i].text === record.type) {
                    typeSelect.selectedIndex = i;
                    break;
                }
            }

            // Show the leave section and make the form visible
            showSection('leaves');
            document.getElementById('leave-form-container').classList.remove('hidden');
            document.getElementById('leave-form').scrollIntoView({ behavior: 'smooth' });

            // Add a hidden field to track that we're editing
            let editIdField = document.getElementById('leave-edit-id');
            if (!editIdField) {
                editIdField = document.createElement('input');
                editIdField.type = 'hidden';
                editIdField.id = 'leave-edit-id';
                document.getElementById('leave-form').appendChild(editIdField);
            }
            editIdField.value = recordId;

            // Change the submit button text
            const submitBtn = document.querySelector('#leave-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Update Leave Record';
            }

            // Add a cancel button if it doesn't exist
            if (!document.getElementById('leave-cancel-edit')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.id = 'leave-cancel-edit';
                cancelBtn.type = 'button';
                cancelBtn.className = 'px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150';
                cancelBtn.textContent = 'Cancel';
                cancelBtn.onclick = cancelLeaveEdit;
                submitBtn.parentNode.insertBefore(cancelBtn, submitBtn);
            }
        }

        // Cancel leave edit
        function cancelLeaveEdit() {
            // Reset the form
            document.getElementById('leave-form').reset();
            document.getElementById('leave-employee-name').value = '';
            document.getElementById('leave-balance').value = '';

            // Remove the edit ID field
            const editIdField = document.getElementById('leave-edit-id');
            if (editIdField) {
                editIdField.remove();
            }

            // Change the submit button text back
            const submitBtn = document.querySelector('#leave-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Submit Leave Request';
            }

            // Remove the cancel button
            const cancelBtn = document.getElementById('leave-cancel-edit');
            if (cancelBtn) {
                cancelBtn.remove();
            }

            // Hide the form container
            document.getElementById('leave-form-container').classList.add('hidden');
        }

        // Approve leave record
        function approveLeaveRecord(recordId) {
            // Find the record
            const record = leaveRecords.find(r => r.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            console.log('Approving leave record:', record);

            // If it's an annual leave, deduct from the employee's balance
            // Make sure to check for both uppercase and lowercase variations
            const leaveType = record.type.toLowerCase();
            if (leaveType.includes('annual')) {
                console.log('This is an annual leave type:', leaveType);

                // Find the employee
                const employee = employees.find(e => e.id === record.employeeId);
                if (employee) {
                    console.log('Found employee:', employee);

                    // Check if employee has a leave balance set
                    if (employee.annualLeaveBalance === null || employee.annualLeaveBalance === undefined) {
                        showMessage(`Cannot approve leave: Employee has no leave balance set. Please set a leave balance first.`, 'error');
                        return;
                    }

                    // Parse the leave days as a float to ensure proper calculation
                    const leaveDays = parseFloat(record.days);
                    console.log('Leave days to deduct:', leaveDays);

                    // Check if employee has sufficient balance
                    if (employee.annualLeaveBalance < leaveDays) {
                        showMessage(`Cannot approve leave: Insufficient leave balance (${employee.annualLeaveBalance.toFixed(1)} days). Requested: ${leaveDays} days.`, 'error');
                        return;
                    }

                    // Deduct from leave balance
                    const oldBalance = employee.annualLeaveBalance;
                    employee.annualLeaveBalance = employee.annualLeaveBalance - leaveDays;
                    console.log(`Deducted ${leaveDays} days from balance. Old: ${oldBalance}, New: ${employee.annualLeaveBalance}`);

                    // Save updated employee data
                    localStorage.setItem('hrSystemEmployees', JSON.stringify(employees));

                    showMessage(`Leave request approved. ${leaveDays} day(s) deducted from ${employee.fullName}'s leave balance.`);
                } else {
                    showMessage('Employee not found. Cannot update leave balance.', 'warning');
                    return;
                }
            } else {
                console.log('This is NOT an annual or casual leave type:', leaveType);
                showMessage(`Leave request for ${record.employeeName} has been approved.`);
            }

            // Update the status
            record.status = 'Approved';

            // Save to localStorage
            localStorage.setItem('hrSystemLeaves', JSON.stringify(leaveRecords));

            // Update the UI
            populateLeaveTable();
            updateDashboard();
        }

        // Reject leave record
        function rejectLeaveRecord(recordId) {
            if (!confirm('Are you sure you want to reject this leave request?')) {
                return;
            }

            // Find the record
            const record = leaveRecords.find(r => r.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            console.log('Rejecting leave record:', record);

            // If it's an annual leave, restore the balance
            // Make sure to check for both uppercase and lowercase variations
            const leaveType = record.type.toLowerCase();
            if (leaveType.includes('annual')) {
                console.log('This is an annual leave type:', leaveType);

                // Find the employee
                const employee = employees.find(e => e.id === record.employeeId);
                if (employee) {
                    console.log('Found employee:', employee);

                    // Restore the leave balance
                    const currentBalance = employee.annualLeaveBalance || 0;
                    const leaveDays = parseFloat(record.days);
                    employee.annualLeaveBalance = currentBalance + leaveDays;
                    console.log(`Restored ${leaveDays} days to balance. Old: ${currentBalance}, New: ${employee.annualLeaveBalance}`);

                    // Save updated employee data
                    localStorage.setItem('hrSystemEmployees', JSON.stringify(employees));

                    // Show message about restored balance
                    showMessage(`Leave request rejected. ${leaveDays} day(s) restored to ${employee.fullName}'s leave balance.`);
                } else {
                    showMessage('Leave request rejected, but employee not found to restore balance.', 'warning');
                }
            } else {
                console.log('This is NOT an annual or casual leave type:', leaveType);
                showMessage(`Leave request for ${record.employeeName} has been rejected.`);
            }

            // Update the status
            record.status = 'Rejected';

            // Save to localStorage
            localStorage.setItem('hrSystemLeaves', JSON.stringify(leaveRecords));

            // Update the UI
            populateLeaveTable();
            updateDashboard();
        }

        // Delete leave record
        function deleteLeaveRecord(recordId) {
            if (!confirm('Are you sure you want to delete this leave record?')) {
                return;
            }

            // Find the record
            const record = leaveRecords.find(r => r.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            // If it's an annual or casual leave and it was approved, restore the balance
            if ((record.type.toLowerCase().includes('annual') || record.type.toLowerCase().includes('casual')) &&
                record.status === 'Approved') {

                // Find the employee
                const employee = employees.find(e => e.id === record.employeeId);
                if (employee) {
                    // Restore the leave balance
                    const currentBalance = employee.annualLeaveBalance || 0;
                    employee.annualLeaveBalance = currentBalance + record.days;

                    // Show message about restored balance
                    showMessage(`Leave record deleted. ${record.days} day(s) restored to ${employee.fullName}'s leave balance.`);

                    // Save updated employee data
                    localStorage.setItem('hrSystemEmployees', JSON.stringify(employees));
                } else {
                    showMessage('Leave record deleted, but employee not found to restore balance.', 'warning');
                }
            } else {
                showMessage('Leave record deleted successfully.');
            }

            // Find the record index and remove it
            const recordIndex = leaveRecords.findIndex(r => r.id == recordId);
            leaveRecords.splice(recordIndex, 1);

            // Save to localStorage
            localStorage.setItem('hrSystemLeaves', JSON.stringify(leaveRecords));

            // Update the UI
            populateLeaveTable();
            updateDashboard();
        }

        // Edit excuse record
        function editExcuseRecord(recordId) {
            // Find the record
            const record = excuseRecords.find(r => r.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Populate the excuse form with the record data
            document.getElementById('excuse-employee-code').value = record.employeeId;
            document.getElementById('excuse-employee-name').value = record.employeeName;
            document.getElementById('excuse-employee').value = record.employeeId;

            // Set the date
            document.getElementById('excuse-date').value = record.date;

            // Set the type
            const typeSelect = document.getElementById('excuse-type');
            for (let i = 0; i < typeSelect.options.length; i++) {
                if (typeSelect.options[i].text === record.type) {
                    typeSelect.selectedIndex = i;
                    break;
                }
            }

            // Set the time
            if (record.startTime) {
                document.getElementById('excuse-start-time').value = record.startTime;
            }
            if (record.endTime) {
                document.getElementById('excuse-end-time').value = record.endTime;
            }

            // Set the reason
            document.getElementById('excuse-reason').value = record.reason || '';

            // Show the excuse section and make the form visible
            showSection('excuses');
            document.getElementById('excuse-form-container').classList.remove('hidden');
            document.getElementById('excuse-form').scrollIntoView({ behavior: 'smooth' });

            // Add a hidden field to track that we're editing
            let editIdField = document.getElementById('excuse-edit-id');
            if (!editIdField) {
                editIdField = document.createElement('input');
                editIdField.type = 'hidden';
                editIdField.id = 'excuse-edit-id';
                document.getElementById('excuse-form').appendChild(editIdField);
            }
            editIdField.value = recordId;

            // Change the submit button text
            const submitBtn = document.querySelector('#excuse-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Update Excuse Record';
            }

            // Add a cancel button if it doesn't exist
            if (!document.getElementById('excuse-cancel-edit')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.id = 'excuse-cancel-edit';
                cancelBtn.type = 'button';
                cancelBtn.className = 'px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150';
                cancelBtn.textContent = 'Cancel';
                cancelBtn.onclick = cancelExcuseEdit;
                submitBtn.parentNode.insertBefore(cancelBtn, submitBtn);
            }
        }

        // Cancel excuse edit
        function cancelExcuseEdit() {
            // Reset the form
            document.getElementById('excuse-form').reset();
            document.getElementById('excuse-employee-name').value = '';

            // Remove the edit ID field
            const editIdField = document.getElementById('excuse-edit-id');
            if (editIdField) {
                editIdField.remove();
            }

            // Change the submit button text back
            const submitBtn = document.querySelector('#excuse-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Submit Excuse Request';
            }

            // Remove the cancel button
            const cancelBtn = document.getElementById('excuse-cancel-edit');
            if (cancelBtn) {
                cancelBtn.remove();
            }

            // Hide the form container
            document.getElementById('excuse-form-container').classList.add('hidden');
        }

        // Delete excuse record
        function deleteExcuseRecord(recordId) {
            if (!confirm('Are you sure you want to delete this excuse record?')) {
                return;
            }

            // Find the record index
            const recordIndex = excuseRecords.findIndex(r => r.id == recordId);
            if (recordIndex === -1) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Remove the record
            excuseRecords.splice(recordIndex, 1);

            // Save to localStorage
            localStorage.setItem('hrSystemExcuses', JSON.stringify(excuseRecords));

            // Update the UI
            populateExcuseTable();

            // Show success message
            showMessage('Excuse record deleted successfully.');
        }

        // Edit penalty record
        function editPenaltyRecord(recordId) {
            // Find the record
            const record = penaltyRecords.find(r => r.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Populate the penalty form with the record data
            document.getElementById('penalty-employee-code').value = record.employeeId;
            document.getElementById('penalty-employee-name').value = record.employeeName;
            document.getElementById('penalty-employee').value = record.employeeId;

            // Set the date
            document.getElementById('penalty-date').value = record.date;

            // Set the days
            document.getElementById('penalty-days').value = record.days;

            // Set the reason
            document.getElementById('penalty-reason').value = record.reason || '';

            // Show the penalty section and make the form visible
            showSection('penalties');
            document.getElementById('penalty-form-container').classList.remove('hidden');
            document.getElementById('penalty-form').scrollIntoView({ behavior: 'smooth' });

            // Add a hidden field to track that we're editing
            let editIdField = document.getElementById('penalty-edit-id');
            if (!editIdField) {
                editIdField = document.createElement('input');
                editIdField.type = 'hidden';
                editIdField.id = 'penalty-edit-id';
                document.getElementById('penalty-form').appendChild(editIdField);
            }
            editIdField.value = recordId;

            // Change the submit button text
            const submitBtn = document.querySelector('#penalty-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Update Penalty Record';
            }

            // Add a cancel button if it doesn't exist
            if (!document.getElementById('penalty-cancel-edit')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.id = 'penalty-cancel-edit';
                cancelBtn.type = 'button';
                cancelBtn.className = 'px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150';
                cancelBtn.textContent = 'Cancel';
                cancelBtn.onclick = cancelPenaltyEdit;
                submitBtn.parentNode.insertBefore(cancelBtn, submitBtn);
            }
        }

        // Cancel penalty edit
        function cancelPenaltyEdit() {
            // Reset the form
            document.getElementById('penalty-form').reset();
            document.getElementById('penalty-employee-name').value = '';

            // Remove the edit ID field
            const editIdField = document.getElementById('penalty-edit-id');
            if (editIdField) {
                editIdField.remove();
            }

            // Change the submit button text back
            const submitBtn = document.querySelector('#penalty-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.textContent = 'Submit Penalty';
            }

            // Remove the cancel button
            const cancelBtn = document.getElementById('penalty-cancel-edit');
            if (cancelBtn) {
                cancelBtn.remove();
            }

            // Hide the form container
            document.getElementById('penalty-form-container').classList.add('hidden');
        }

        // Delete penalty record
        function deletePenaltyRecord(recordId) {
            if (!confirm('Are you sure you want to delete this penalty record?')) {
                return;
            }

            // Find the record index
            const recordIndex = penaltyRecords.findIndex(r => r.id == recordId);
            if (recordIndex === -1) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Remove the record
            penaltyRecords.splice(recordIndex, 1);

            // Save to localStorage
            localStorage.setItem('hrSystemPenalties', JSON.stringify(penaltyRecords));

            // Update the UI
            populatePenaltyTable();

            // Show success message
            showMessage('Penalty record deleted successfully.');
        }

        // Update penalty summary based on filters
        function updatePenaltySummary(employeeId = 'all', month = 'all') {
            console.log('Updating penalty summary with filters:', { employeeId, month });
            const currentYear = new Date().getFullYear();

            // Get the elements to update
            const totalMonthElement = document.getElementById('total-penalty-days-month');
            const totalYearElement = document.getElementById('total-penalty-days-year');

            if (!totalMonthElement || !totalYearElement) return;

            // Filter records based on parameters
            let filteredRecords = [...penaltyRecords];
            console.log('Total penalty records:', filteredRecords.length);

            // Apply employee filter
            if (employeeId !== 'all') {
                console.log('Filtering for employee:', employeeId);
                filteredRecords = filteredRecords.filter(record => record.employeeId === employeeId);
                console.log('After employee filter, records count:', filteredRecords.length);
            }

            // Filter for current year only
            filteredRecords = filteredRecords.filter(record => {
                const date = new Date(record.date);
                return date.getFullYear() === currentYear;
            });
            console.log('After year filter, records count:', filteredRecords.length);

            // Calculate total for the selected month (or current month if none selected)
            let selectedMonth = month !== 'all' ? parseInt(month) : new Date().getMonth() + 1;
            console.log('Selected month for summary:', selectedMonth);

            // Calculate total penalty days for the selected month (current year only)
            const totalMonthPenaltyDays = filteredRecords
                .filter(pr => {
                    const date = new Date(pr.date);
                    const recordMonth = date.getMonth() + 1;
                    console.log(`Penalty record ${pr.id} date: ${pr.date}, month: ${recordMonth}`);
                    return recordMonth === selectedMonth;
                })
                .reduce((sum, pr) => sum + parseFloat(pr.days), 0);
            console.log('Total month penalty days:', totalMonthPenaltyDays);

            // Calculate total penalty days for the current year
            const totalYearPenaltyDays = filteredRecords
                .reduce((sum, pr) => sum + parseFloat(pr.days), 0);
            console.log('Total year penalty days:', totalYearPenaltyDays);

            // Update the summary display - use toFixed(2) to ensure we show exact fractions (0.25, 0.50, 0.75, etc.)
            totalMonthElement.textContent = totalMonthPenaltyDays.toFixed(2);
            totalYearElement.textContent = totalYearPenaltyDays.toFixed(2);

            // Update the month label to show which month is being displayed
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const monthLabel = document.querySelector('.bg-red-50 h3');

            if (monthLabel) {
                if (month !== 'all') {
                    monthLabel.textContent = `${monthNames[selectedMonth - 1]} ${currentYear} Penalties`;
                } else {
                    monthLabel.textContent = 'Current Month Penalties';
                }
            }
        }

        // This is a duplicate function that's not being used - removing it to avoid confusion

        // Validate employee code and update employee name and balance for leave form
        document.getElementById('leave-employee-code')?.addEventListener('input', function() {
            const employeeCode = this.value.trim();
            const nameInput = document.getElementById('leave-employee-name');
            const hiddenEmployeeInput = document.getElementById('leave-employee');
            const balanceInput = document.getElementById('leave-balance');

            // Reset fields
            nameInput.value = '';
            hiddenEmployeeInput.value = '';
            balanceInput.value = '';

            if (employeeCode) {
                // Find employee by code
                const employee = employees.find(e => e.id === employeeCode);

                if (employee) {
                    // Employee found, update name and balance
                    nameInput.value = employee.fullName;
                    hiddenEmployeeInput.value = employee.id;

                    // Get the employee's current leave balance
                    const currentBalance = employee.annualLeaveBalance;

                    // Update the balance input
                    if (currentBalance !== null && currentBalance !== undefined) {
                        balanceInput.value = currentBalance.toFixed(1);
                    } else {
                        balanceInput.value = 'No balance set';
                    }

                    // Add success styling
                    nameInput.classList.remove('bg-red-50');
                    nameInput.classList.add('bg-green-50');
                } else {
                    // Employee not found, show error styling
                    nameInput.value = 'Employee not found';
                    nameInput.classList.remove('bg-green-50');
                    nameInput.classList.add('bg-red-50');
                }
            }
        });

        // Validate employee code and update employee name for excuse form
        document.getElementById('excuse-employee-code')?.addEventListener('input', function() {
            const employeeCode = this.value.trim();
            const nameInput = document.getElementById('excuse-employee-name');
            const hiddenEmployeeInput = document.getElementById('excuse-employee');

            // Reset fields
            nameInput.value = '';
            hiddenEmployeeInput.value = '';

            if (employeeCode) {
                // Find employee by code
                const employee = employees.find(e => e.id === employeeCode);

                if (employee) {
                    // Employee found, update name
                    nameInput.value = employee.fullName;
                    hiddenEmployeeInput.value = employee.id;

                    // Add success styling
                    nameInput.classList.remove('bg-red-50');
                    nameInput.classList.add('bg-green-50');
                } else {
                    // Employee not found, show error styling
                    nameInput.value = 'Employee not found';
                    nameInput.classList.remove('bg-green-50');
                    nameInput.classList.add('bg-red-50');
                }
            }
        });

        // Validate employee code and update employee name for penalty form
        document.getElementById('penalty-employee-code')?.addEventListener('input', function() {
            const employeeCode = this.value.trim();
            const nameInput = document.getElementById('penalty-employee-name');
            const hiddenEmployeeInput = document.getElementById('penalty-employee');

            // Reset fields
            nameInput.value = '';
            hiddenEmployeeInput.value = '';

            if (employeeCode) {
                // Find employee by code
                const employee = employees.find(e => e.id === employeeCode);

                if (employee) {
                    // Employee found, update name
                    nameInput.value = employee.fullName;
                    hiddenEmployeeInput.value = employee.id;

                    // Add success styling
                    nameInput.classList.remove('bg-red-50');
                    nameInput.classList.add('bg-green-50');
                } else {
                    // Employee not found, show error styling
                    nameInput.value = 'Employee not found';
                    nameInput.classList.remove('bg-green-50');
                    nameInput.classList.add('bg-red-50');
                }
            }
        });

        // --- Simplified Time Selection Implementation ---
        let selectedHour = 9;
        let isAM = true;
        let currentTimeField = null; // Tracks which time field is being edited

        // Function to open the clock modal for a specific field
        function openClockModal(fieldPrefix) {
            const clockModal = document.getElementById('clockModal');
            const modalTitle = document.getElementById('clock-modal-title');
            const displayField = document.getElementById(`${fieldPrefix}-display`);

            if (!clockModal || !modalTitle || !displayField) return;

            // Set the current field being edited
            window.currentTimeField = fieldPrefix === 'excuse-start-time' || fieldPrefix === 'overtime-start-time' ? 'start' : 'end';

            // Set the modal title
            modalTitle.textContent = window.currentTimeField === 'start' ? 'Select Start Time' : 'Select End Time';

            // Show the modal
            clockModal.classList.remove('hidden');

            // Parse existing time if any
            const timeValue = displayField.value;
            let selectedHour = window.currentTimeField === 'start' ? 9 : 17; // Default to 9 AM for start, 5 PM for end
            let isAM = window.currentTimeField === 'start'; // Default AM for start, PM for end

            if (timeValue) {
                const timeParts = timeValue.match(/(\d+):\d+\s*(AM|PM)/i);
                if (timeParts) {
                    selectedHour = parseInt(timeParts[1]);
                    isAM = timeParts[2].toUpperCase() === 'AM';
                }
            }

            // Reset all buttons
            document.querySelectorAll('.hour-button').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Find and highlight the selected button
            const selectedBtn = document.querySelector(`.hour-button[data-hour="${selectedHour}"][data-ampm="${isAM ? 'AM' : 'PM'}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }

            // Store the current field prefix for use in the confirm button
            window.currentFieldPrefix = fieldPrefix;

            // Update the selected time text
            const hourDisplay = selectedHour === 0 ? 12 : selectedHour;
            const amPm = isAM ? 'AM' : 'PM';
            document.getElementById('selected-time-text').textContent = `${hourDisplay}:00 ${amPm}`;
        }

        // Initialize the simplified time selection
        function initializeAnalogClock() {
            const amHoursContainer = document.getElementById('am-hours-container');
            const pmHoursContainer = document.getElementById('pm-hours-container');
            const selectedTimeText = document.getElementById('selected-time-text');
            const confirmButton = document.getElementById('clock-confirm');
            const closeButton = document.getElementById('close-clock-modal');
            const clockModal = document.getElementById('clockModal');
            const modalTitle = document.getElementById('clock-modal-title');

            // Initialize global variables for time selection
            window.selectedHour = 9; // Default to 9 AM
            window.isAM = true;
            window.currentTimeField = 'start';
            window.currentFieldPrefix = 'excuse-start-time';

            // Create AM hour buttons
            for (let i = 1; i <= 12; i++) {
                const hourBtn = document.createElement('button');
                hourBtn.type = 'button';
                hourBtn.className = 'hour-button';
                hourBtn.textContent = i === 12 ? '12' : i;
                hourBtn.dataset.hour = i;
                hourBtn.dataset.ampm = 'AM';

                // Add click event to select hour
                hourBtn.addEventListener('click', function() {
                    selectHour(i, true);
                });

                amHoursContainer.appendChild(hourBtn);
            }

            // Create PM hour buttons
            for (let i = 1; i <= 12; i++) {
                const hourBtn = document.createElement('button');
                hourBtn.type = 'button';
                hourBtn.className = 'hour-button';
                hourBtn.textContent = i === 12 ? '12' : i;
                hourBtn.dataset.hour = i;
                hourBtn.dataset.ampm = 'PM';

                // Add click event to select hour
                hourBtn.addEventListener('click', function() {
                    selectHour(i, false);
                });

                pmHoursContainer.appendChild(hourBtn);
            }

            // Function to select an hour
            function selectHour(hour, am) {
                window.selectedHour = hour;
                window.isAM = am;

                // Update selected hour visual
                document.querySelectorAll('.hour-button').forEach(btn => {
                    btn.classList.remove('selected');
                });

                // Find and highlight the selected button
                const selectedBtn = document.querySelector(`.hour-button[data-hour="${hour}"][data-ampm="${window.isAM ? 'AM' : 'PM'}"]`);
                if (selectedBtn) {
                    selectedBtn.classList.add('selected');
                }

                // Update the selected time text
                const hourDisplay = window.selectedHour === 0 ? 12 : window.selectedHour;
                const amPm = window.isAM ? 'AM' : 'PM';
                selectedTimeText.textContent = `${hourDisplay}:00 ${amPm}`;
            }



            // Confirm time selection
            confirmButton.addEventListener('click', function() {
                const hourDisplay = window.selectedHour === 0 ? 12 : window.selectedHour;
                const amPm = window.isAM ? 'AM' : 'PM';
                const timeString = `${hourDisplay}:00 ${amPm}`;

                // Calculate 24-hour format for hidden input
                let hour24 = window.selectedHour;
                if (!window.isAM && window.selectedHour < 12) {
                    hour24 += 12;
                } else if (window.isAM && window.selectedHour === 12) {
                    hour24 = 0;
                }
                const timeValue = `${hour24 < 10 ? '0' + hour24 : hour24}:00`;

                // Get the current field prefix (excuse-start-time, excuse-end-time, overtime-start-time, overtime-end-time)
                const fieldPrefix = window.currentFieldPrefix;

                // Update the display field
                const displayField = document.getElementById(`${fieldPrefix}-display`);
                if (displayField) {
                    displayField.value = timeString;
                }

                // Update the hidden field
                const hiddenField = document.getElementById(fieldPrefix);
                if (hiddenField) {
                    hiddenField.value = timeValue;
                }

                // Hide the modal
                clockModal.classList.add('hidden');
            });

            // Close modal
            closeButton.addEventListener('click', function() {
                clockModal.classList.add('hidden');
            });

            // Add click event listeners to time input fields
            document.getElementById('excuse-start-time-display')?.addEventListener('click', function() {
                openClockModal('excuse-start-time');
            });

            document.getElementById('excuse-end-time-display')?.addEventListener('click', function() {
                openClockModal('excuse-end-time');
            });

            document.getElementById('overtime-start-time-display')?.addEventListener('click', function() {
                openClockModal('overtime-start-time');
            });

            document.getElementById('overtime-end-time-display')?.addEventListener('click', function() {
                openClockModal('overtime-end-time');
            });
        }

        // --- General Initialization ---
         function initializeDatePickers() {
            flatpickr("main .flatpickr-input", {
                altInput: true, altFormat: "F j, Y", dateFormat: "Y-m-d", allowInput: true
            });
        }

        function initializeModalDatePickers() {
             const dateInputs = document.querySelectorAll('#employeeModal .flatpickr-input');
             dateInputs.forEach(input => {
                if (input._flatpickr) input._flatpickr.destroy();
             });
            flatpickr("#employeeModal .flatpickr-input", {
                altInput: true, altFormat: "F j, Y", dateFormat: "Y-m-d", allowInput: true
            });
        }

        // Run on page load
        document.addEventListener('DOMContentLoaded', () => {
             initializeDatePickers();
             initializeModalDatePickers();
             console.log("Page loaded. Waiting for login.");
             // initializeAppUI is called after successful login

             // Mobile sidebar toggle
             const mobileMenuButton = document.getElementById('mobile-menu-button');
             const closeSidebarButton = document.getElementById('close-sidebar');
             const sidebar = document.getElementById('sidebar');
             const sidebarLinks = document.querySelectorAll('.sidebar-link');

             if (mobileMenuButton && sidebar) {
                 mobileMenuButton.addEventListener('click', () => {
                     sidebar.classList.remove('-translate-x-full');
                 });
             }

             if (closeSidebarButton && sidebar) {
                 closeSidebarButton.addEventListener('click', () => {
                     sidebar.classList.add('-translate-x-full');
                 });
             }

             // Close sidebar when clicking on a link (in mobile view)
             sidebarLinks.forEach(link => {
                 link.addEventListener('click', () => {
                     if (window.innerWidth < 768) { // Only in mobile view
                         sidebar.classList.add('-translate-x-full');
                     }
                 });
             });

             // Notification bell toggle
             const notificationBell = document.getElementById('notification-bell');
             const notificationDropdown = document.getElementById('notification-dropdown');
             const markAllReadBtn = document.getElementById('mark-all-read');

             if (notificationBell && notificationDropdown) {
                 notificationBell.addEventListener('click', (e) => {
                     e.stopPropagation();
                     notificationDropdown.classList.toggle('hidden');
                     populateNotificationDropdown();
                 });

                 // Close dropdown when clicking outside
                 document.addEventListener('click', (e) => {
                     if (!notificationDropdown.contains(e.target) && e.target !== notificationBell) {
                         notificationDropdown.classList.add('hidden');
                     }
                 });

                 // Prevent dropdown from closing when clicking inside it
                 notificationDropdown.addEventListener('click', (e) => {
                     e.stopPropagation();
                 });

                 // Mark all as read button
                 markAllReadBtn.addEventListener('click', (e) => {
                     e.stopPropagation();
                     notifications.forEach(notification => {
                         notification.read = true;
                     });
                     updateNotificationBadge();
                     populateNotificationDropdown();
                 });
             }

             // Handle date dropdowns
             populateDateDropdowns();
        });

        // Populate date dropdowns (days, months, years)
        function populateDateDropdowns() {
            // Days (1-31)
            const dayDropdowns = ['hiringDay', 'dobDay', 'resignDay'];
            dayDropdowns.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    for (let i = 1; i <= 31; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = i;
                        dropdown.appendChild(option);
                    }
                }
            });

            // Months
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            const monthDropdowns = ['hiringMonth', 'dobMonth', 'resignMonth'];
            monthDropdowns.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    months.forEach((month, index) => {
                        const option = document.createElement('option');
                        option.value = index + 1;
                        option.textContent = month;
                        dropdown.appendChild(option);
                    });
                }
            });

            // Years (current year - 100 to current year)
            const currentYear = new Date().getFullYear();
            const yearDropdowns = ['hiringYear', 'dobYear', 'resignYear'];
            yearDropdowns.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    for (let year = currentYear; year >= currentYear - 100; year--) {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        dropdown.appendChild(option);
                    }
                }
            });

            // Add event listeners to update hidden date fields
            setupDateFieldSync('hiringDay', 'hiringMonth', 'hiringYear', 'hiringDate');
            setupDateFieldSync('dobDay', 'dobMonth', 'dobYear', 'dob');
            setupDateFieldSync('resignDay', 'resignMonth', 'resignYear', 'resignDate');
        }

        // Sync dropdown selections to hidden date field
        function setupDateFieldSync(dayId, monthId, yearId, dateFieldId) {
            const dayDropdown = document.getElementById(dayId);
            const monthDropdown = document.getElementById(monthId);
            const yearDropdown = document.getElementById(yearId);
            const dateField = document.getElementById(dateFieldId);

            if (!dayDropdown || !monthDropdown || !yearDropdown || !dateField) return;

            const updateDateField = () => {
                const day = dayDropdown.value;
                const month = monthDropdown.value;
                const year = yearDropdown.value;

                if (day && month && year) {
                    // Format as YYYY-MM-DD
                    const formattedMonth = month.padStart(2, '0');
                    const formattedDay = day.padStart(2, '0');
                    dateField.value = `${year}-${formattedMonth}-${formattedDay}`;
                }
            };

            dayDropdown.addEventListener('change', updateDateField);
            monthDropdown.addEventListener('change', updateDateField);
            yearDropdown.addEventListener('change', updateDateField);
        }

        // Function to validate leave days match calendar selection
        function validateLeaveDays() {
            const startDate = document.getElementById('leave-start-date').value;
            const endDate = document.getElementById('leave-end-date').value;
            const selectedDays = parseFloat(document.getElementById('leave-days').value);

            if (!startDate || !endDate) return true; // Skip validation if dates not selected

            // Special handling for half-day requests
            if (selectedDays === 0.5) {
                // For half-day requests, start and end dates must be the same
                if (startDate !== endDate) {
                    showMessage('For half-day leave, start and end dates must be the same', 'error');
                    return false;
                }
                return true; // Valid half-day request
            }

            const calculatedDays = calculateLeaveDays(startDate, endDate);

            if (calculatedDays !== selectedDays) {
                showMessage(`Selected days (${selectedDays}) don't match calendar selection (${calculatedDays} days)`, 'error');
                return false;
            }

            return true;
        }

        // Global notifications array
        let notifications = [];

        // Add notifications for probation, birthdays, and anniversaries
        function updateDashboardNotifications() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentDay = today.getDate();
            const currentYear = today.getFullYear();

            // Clear previous notifications
            notifications = [];

            // Find employees with birthdays this month
            const birthdayEmployees = employees.filter(emp => {
                if (!emp.dob || emp.status !== 'Active') return false;
                const dob = new Date(emp.dob);
                return dob.getMonth() === currentMonth;
            });

            // Add birthday notifications
            birthdayEmployees.forEach(emp => {
                const dob = new Date(emp.dob);
                const birthdayDay = dob.getDate();
                const daysUntilBirthday = birthdayDay - currentDay;

                // Only add if birthday is today or in the future (this month)
                if (daysUntilBirthday >= 0 || (daysUntilBirthday < 0 && Math.abs(daysUntilBirthday) < 7)) {
                    const age = currentYear - dob.getFullYear();
                    let message = '';

                    if (daysUntilBirthday === 0) {
                        message = `${emp.fullName}'s birthday is today! They are turning ${age} years old.`;
                    } else if (daysUntilBirthday > 0) {
                        message = `${emp.fullName}'s birthday is in ${daysUntilBirthday} days. They will turn ${age} years old.`;
                    } else {
                        message = `${emp.fullName}'s birthday was ${Math.abs(daysUntilBirthday)} days ago. They turned ${age} years old.`;
                    }

                    notifications.push({
                        type: 'birthday',
                        icon: 'fa-birthday-cake',
                        color: 'text-pink-500',
                        message: message,
                        date: new Date(currentYear, dob.getMonth(), dob.getDate()),
                        employee: emp,
                        read: false
                    });
                }
            });

            // Find employees with work anniversaries this month
            const anniversaryEmployees = employees.filter(emp => {
                if (!emp.hiringDate || emp.status !== 'Active') return false;
                const hireDate = new Date(emp.hiringDate);
                return hireDate.getMonth() === currentMonth && hireDate.getFullYear() < currentYear;
            });

            // Add anniversary notifications
            anniversaryEmployees.forEach(emp => {
                const hireDate = new Date(emp.hiringDate);
                const anniversaryDay = hireDate.getDate();
                const daysUntilAnniversary = anniversaryDay - currentDay;

                // Only add if anniversary is today or in the future (this month)
                if (daysUntilAnniversary >= 0 || (daysUntilAnniversary < 0 && Math.abs(daysUntilAnniversary) < 7)) {
                    const years = currentYear - hireDate.getFullYear();
                    let message = '';

                    if (daysUntilAnniversary === 0) {
                        message = `${emp.fullName}'s work anniversary is today! They have been with the company for ${years} years.`;
                    } else if (daysUntilAnniversary > 0) {
                        message = `${emp.fullName}'s work anniversary is in ${daysUntilAnniversary} days. They will complete ${years} years with the company.`;
                    } else {
                        message = `${emp.fullName}'s work anniversary was ${Math.abs(daysUntilAnniversary)} days ago. They completed ${years} years with the company.`;
                    }

                    notifications.push({
                        type: 'anniversary',
                        icon: 'fa-glass-cheers',
                        color: 'text-blue-500',
                        message: message,
                        date: new Date(currentYear, hireDate.getMonth(), hireDate.getDate()),
                        employee: emp,
                        read: false
                    });
                }
            });

            // Find employees who will complete probation soon (assuming 3 months probation)
            const probationEmployees = employees.filter(emp => {
                if (!emp.hiringDate || emp.status !== 'Active') return false;
                const hireDate = new Date(emp.hiringDate);
                const probationEndDate = new Date(hireDate);
                probationEndDate.setMonth(probationEndDate.getMonth() + 3);

                // Check if probation ends within the next 30 days or ended in the last 7 days
                const timeDiff = probationEndDate - today;
                const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                return (daysDiff >= 0 && daysDiff <= 30) || (daysDiff < 0 && daysDiff >= -7);
            });

            // Add probation notifications
            probationEmployees.forEach(emp => {
                const hireDate = new Date(emp.hiringDate);
                const probationEndDate = new Date(hireDate);
                probationEndDate.setMonth(probationEndDate.getMonth() + 3);

                const timeDiff = probationEndDate - today;
                const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

                let message = '';
                if (daysDiff === 0) {
                    message = `${emp.fullName}'s probation period ends today!`;
                } else if (daysDiff > 0) {
                    message = `${emp.fullName}'s probation period will end in ${daysDiff} days.`;
                } else {
                    message = `${emp.fullName}'s probation period ended ${Math.abs(daysDiff)} days ago.`;
                }

                notifications.push({
                    type: 'probation',
                    icon: 'fa-user-check',
                    color: 'text-green-500',
                    message: message,
                    date: probationEndDate,
                    employee: emp,
                    read: false
                });
            });

            // Update notification badge
            updateNotificationBadge();
        }

        // Update notification badge count
        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notification-badge');

            if (unreadCount > 0) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // Populate notification dropdown
        function populateNotificationDropdown() {
            const notificationList = document.getElementById('notification-list');

            if (notifications.length === 0) {
                notificationList.innerHTML = `
                    <div class="py-8 text-center text-gray-500">
                        <i class="fas fa-bell-slash text-2xl mb-2"></i>
                        <p>No notifications</p>
                    </div>
                `;
                return;
            }

            // Sort notifications by date (newest first)
            notifications.sort((a, b) => b.date - a.date);

            let notificationHTML = '';

            notifications.forEach((notification, index) => {
                const dateString = formatDate(notification.date);

                notificationHTML += `
                    <div class="notification-item p-3 border-b hover:bg-gray-50 ${notification.read ? 'bg-gray-50' : ''}" data-index="${index}">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 mr-3">
                                <div class="h-8 w-8 rounded-full bg-${notification.color.replace('text-', 'bg-').replace('-500', '-100')} flex items-center justify-center">
                                    <i class="fas ${notification.icon} ${notification.color}"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-800">${notification.message}</p>
                                <p class="text-xs text-gray-500 mt-1">${dateString}</p>
                            </div>
                            ${!notification.read ? '<div class="ml-2 h-2 w-2 bg-blue-500 rounded-full"></div>' : ''}
                        </div>
                    </div>
                `;
            });

            notificationList.innerHTML = notificationHTML;

            // Add click event listeners to mark notifications as read
            document.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    notifications[index].read = true;
                    updateNotificationBadge();
                    populateNotificationDropdown();
                });
            });
        }

        // Function to set up employee code validation for leave filter
        function setupLeaveFilterEmployeeCodeValidation() {
            const employeeCodeInput = document.getElementById('leave-filter-employee-code');
            const employeeNameInput = document.getElementById('leave-filter-employee-name');
            const employeeIdInput = document.getElementById('leave-filter-employee');
            const applyFiltersButton = document.getElementById('apply-leave-filters');

            if (!employeeCodeInput || !employeeNameInput || !employeeIdInput || !applyFiltersButton) return;

            // Add input event listener to validate employee code
            employeeCodeInput.addEventListener('input', function() {
                const code = this.value.trim();

                if (code === '') {
                    // Reset fields if empty
                    employeeNameInput.value = '';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500', 'border-red-500');
                    return;
                }

                // Find employee by code
                const employee = employees.find(e => e.id.toLowerCase() === code.toLowerCase());

                if (employee) {
                    // Valid employee code
                    employeeNameInput.value = employee.fullName;
                    employeeIdInput.value = employee.id;
                    employeeNameInput.classList.remove('border-red-500');
                    employeeNameInput.classList.add('border-green-500');

                    // Update leave summary immediately when a valid employee is selected
                    const monthFilter = document.getElementById('leave-filter-month').value;
                    updateLeaveSummary(employee.id, monthFilter);
                } else {
                    // Invalid employee code
                    employeeNameInput.value = 'Employee not found';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500');
                    employeeNameInput.classList.add('border-red-500');
                }
            });

            // Add change event listener to month filter
            const monthFilterSelect = document.getElementById('leave-filter-month');
            if (monthFilterSelect) {
                monthFilterSelect.addEventListener('change', function() {
                    const employeeId = document.getElementById('leave-filter-employee').value;
                    updateLeaveSummary(employeeId, this.value);
                });
            }

            // Set up excuse filter employee code validation
            setupExcuseFilterEmployeeCodeValidation();

            // Set up penalty filter employee code validation
            setupPenaltyFilterEmployeeCodeValidation();

            // Function to reset leave filters
            function resetLeaveFilters() {
                // Reset all filter dropdowns to default values
                document.getElementById('leave-filter-employee-code').value = '';
                document.getElementById('leave-filter-employee-name').value = '';
                document.getElementById('leave-filter-employee').value = 'all';
                document.getElementById('leave-filter-month').value = 'all';

                // Remove any styling from the employee name field
                document.getElementById('leave-filter-employee-name').classList.remove('border-green-500', 'border-red-500');

                // Repopulate the table with all records and update the summary
                populateLeaveTable();
                updateLeaveSummary('all', 'all');
            }

            // Add click event listener to apply filters button
            applyFiltersButton.addEventListener('click', function() {
                // Toggle the button color and check if we need to reset
                const wasActive = toggleFilterButtonColor(this, resetLeaveFilters);

                // Only apply filters if we're not resetting
                if (!wasActive) {
                    // Get the current filter values
                    const employeeId = document.getElementById('leave-filter-employee').value;
                    const month = document.getElementById('leave-filter-month').value;

                    // Update both the table and the summary with the same filters
                    populateLeaveTable();
                    updateLeaveSummary(employeeId, month);
                }
            });

            // Set current year in the filter label
            updateMonthFilterLabels();
        }

        // Function to update month filter labels to show current year
        function updateMonthFilterLabels() {
            const currentYear = new Date().getFullYear();

            // Update leave filter month label
            const leaveMonthFilterLabel = document.querySelector('label[for="leave-filter-month"]');
            if (leaveMonthFilterLabel) {
                leaveMonthFilterLabel.textContent = `Filter by Month (${currentYear})`;
            }

            // Update excuse filter month label
            const excuseMonthFilterLabel = document.querySelector('label[for="excuse-filter-month"]');
            if (excuseMonthFilterLabel) {
                excuseMonthFilterLabel.textContent = `Filter by Month (${currentYear})`;
            }

            // Update penalty filter month label
            const penaltyMonthFilterLabel = document.querySelector('label[for="penalty-filter-month"]');
            if (penaltyMonthFilterLabel) {
                penaltyMonthFilterLabel.textContent = `Filter by Month (${currentYear})`;
            }

            // Update overtime filter month label
            const overtimeMonthFilterLabel = document.querySelector('label[for="overtime-filter-month"]');
            if (overtimeMonthFilterLabel) {
                overtimeMonthFilterLabel.textContent = `Filter by Month (${currentYear})`;
            }
        }

        // Function to set up employee code validation for excuse filter
        function setupExcuseFilterEmployeeCodeValidation() {
            const employeeCodeInput = document.getElementById('excuse-filter-employee-code');
            const employeeNameInput = document.getElementById('excuse-filter-employee-name');
            const employeeIdInput = document.getElementById('excuse-filter-employee');
            const applyFiltersButton = document.getElementById('excuse-filter-btn');

            if (!employeeCodeInput || !employeeNameInput || !employeeIdInput || !applyFiltersButton) return;

            // Add input event listener to validate employee code
            employeeCodeInput.addEventListener('input', function() {
                const code = this.value.trim();

                // Reset fields if empty
                if (code === '') {
                    employeeNameInput.value = '';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500', 'border-red-500');
                    return;
                }

                // Find employee by code
                const employee = employees.find(e => e.id.toLowerCase() === code.toLowerCase());

                if (employee) {
                    // Valid employee code
                    employeeNameInput.value = employee.fullName;
                    employeeIdInput.value = employee.id;
                    employeeNameInput.classList.remove('border-red-500');
                    employeeNameInput.classList.add('border-green-500');

                    // Update excuse summary immediately when a valid employee is selected
                    const monthFilter = document.getElementById('excuse-filter-month').value;
                    updateExcuseSummary(employee.id, monthFilter);
                } else {
                    // Invalid employee code
                    employeeNameInput.value = 'Employee not found';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500');
                    employeeNameInput.classList.add('border-red-500');
                }
            });

            // Add change event listener to month filter
            const monthFilterSelect = document.getElementById('excuse-filter-month');
            if (monthFilterSelect) {
                monthFilterSelect.addEventListener('change', function() {
                    const employeeId = document.getElementById('excuse-filter-employee').value;
                    updateExcuseSummary(employeeId, this.value);
                });
            }
        }

        // Function to set up employee code validation for penalty filter
        function setupPenaltyFilterEmployeeCodeValidation() {
            const employeeCodeInput = document.getElementById('penalty-filter-employee-code');
            const employeeNameInput = document.getElementById('penalty-filter-employee-name');
            const employeeIdInput = document.getElementById('penalty-filter-employee');
            const applyFiltersButton = document.getElementById('penalty-filter-btn');

            if (!employeeCodeInput || !employeeNameInput || !employeeIdInput || !applyFiltersButton) return;

            // Add input event listener to validate employee code
            employeeCodeInput.addEventListener('input', function() {
                const code = this.value.trim();

                // Reset fields if empty
                if (code === '') {
                    employeeNameInput.value = '';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500', 'border-red-500');
                    return;
                }

                // Find employee by code
                const employee = employees.find(e => e.id.toLowerCase() === code.toLowerCase());

                if (employee) {
                    // Valid employee code
                    employeeNameInput.value = employee.fullName;
                    employeeIdInput.value = employee.id;
                    employeeNameInput.classList.remove('border-red-500');
                    employeeNameInput.classList.add('border-green-500');

                    // Update penalty summary immediately when a valid employee is selected
                    const monthFilter = document.getElementById('penalty-filter-month').value;
                    updatePenaltySummary(employee.id, monthFilter);
                } else {
                    // Invalid employee code
                    employeeNameInput.value = 'Employee not found';
                    employeeIdInput.value = 'all';
                    employeeNameInput.classList.remove('border-green-500');
                    employeeNameInput.classList.add('border-red-500');
                }
            });

            // Add change event listener to month filter
            const monthFilterSelect = document.getElementById('penalty-filter-month');
            if (monthFilterSelect) {
                monthFilterSelect.addEventListener('change', function() {
                    const employeeId = document.getElementById('penalty-filter-employee').value;
                    updatePenaltySummary(employeeId, this.value);
                });
            }
        }

        // Function to update all employee leave balances based on year-to-date usage
        function updateAllEmployeeLeaveBalances() {
            // We no longer automatically update all employee leave balances
            // Leave balances are now manually set by admin and updated when leave requests are processed

            // Save updated employee data to localStorage
            localStorage.setItem('hrSystemEmployees', JSON.stringify(employees));
        }

        // Helper function to format dates
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);

            // Format as DD/MM/YYYY
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();

            return `${day}/${month}/${year}`;
        }

        // Payroll Functions

        // Function to populate the year dropdowns for payroll
        function populatePayrollYearDropdowns() {
            const currentYear = new Date().getFullYear();
            const payrollYear = document.getElementById('payroll-year');
            const payrollHistoryYear = document.getElementById('payroll-history-year');

            if (payrollYear) {
                payrollYear.innerHTML = '';
                for (let year = currentYear; year >= currentYear - 5; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    payrollYear.appendChild(option);
                }
            }

            if (payrollHistoryYear) {
                // Keep the "All Years" option
                payrollHistoryYear.innerHTML = '<option value="all">All Years</option>';
                for (let year = currentYear; year >= currentYear - 5; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    payrollHistoryYear.appendChild(option);
                }
            }
        }

        // Function to run payroll for the selected month
        function runPayroll() {
            // Get the selected month and year
            const selectedMonth = parseInt(document.getElementById('payroll-month').value);
            const selectedYear = parseInt(document.getElementById('payroll-year').value);

            // Show the payroll form container
            document.getElementById('payroll-form-container').classList.remove('hidden');

            // Populate the payroll calculation table
            populatePayrollCalculationTable(selectedMonth, selectedYear);
        }

        // Function to populate the payroll calculation table
        function populatePayrollCalculationTable(month, year) {
            const tableBody = document.getElementById('payrollCalculationTableBody');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            // Get active employees with salary records
            const activeEmployees = employees.filter(emp => emp.status === 'Active');
            const employeesWithSalary = activeEmployees.filter(emp => {
                return salaryRecords.some(sr => sr.employeeId === emp.id);
            });

            if (employeesWithSalary.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="12" class="text-center py-4 text-gray-500">No active employees with salary records found.</td></tr>';
                return;
            }

            // For each employee, create a row in the table
            employeesWithSalary.forEach(employee => {
                const salaryRecord = salaryRecords.find(sr => sr.employeeId === employee.id);

                // Create the row
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150';
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${employee.id}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${employee.fullName}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${salaryRecord.basicSalary.toFixed(2)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${salaryRecord.fixedAllowance.toFixed(2)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">
                        <input type="number" class="fuel-allowance w-24 border border-gray-300 rounded-md px-2 py-1 text-sm"
                               value="0" min="0" step="0.01" data-employee-id="${employee.id}">
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">
                        <input type="number" class="reward w-24 border border-gray-300 rounded-md px-2 py-1 text-sm"
                               value="0" min="0" step="0.01" data-employee-id="${employee.id}">
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 overtime-value" data-employee-id="${employee.id}">0.00</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${salaryRecord.fixedDeduction.toFixed(2)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700 penalties-days" data-employee-id="${employee.id}">0.00</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">
                        <input type="number" class="penalties-egp w-24 border border-gray-300 rounded-md px-2 py-1 text-sm bg-gray-100"
                               value="0" min="0" step="0.01" data-employee-id="${employee.id}" readonly>
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">
                        <input type="number" class="other-deductions w-24 border border-gray-300 rounded-md px-2 py-1 text-sm"
                               value="0" min="0" step="0.01" data-employee-id="${employee.id}">
                    </td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900 net-salary" data-employee-id="${employee.id}">0.00</td>
                `;

                tableBody.appendChild(row);
            });

            // Calculate overtime and penalties for each employee
            calculateOvertimeForMonth(month, year);
            calculatePenaltiesForMonth(month, year);

            // Add event listeners to recalculate net salary when inputs change
            addPayrollInputEventListeners();
        }

        // Function to calculate overtime for the selected month
        function calculateOvertimeForMonth(month, year) {
            // For each employee, calculate overtime
            const overtimeElements = document.querySelectorAll('.overtime-value');

            overtimeElements.forEach(element => {
                const employeeId = element.getAttribute('data-employee-id');
                const employee = employees.find(emp => emp.id === employeeId);
                const salaryRecord = salaryRecords.find(sr => sr.employeeId === employeeId);

                if (!employee || !salaryRecord) return;

                // Get overtime records for this employee in the selected month
                const employeeOvertimeRecords = overtimeRecords.filter(record => {
                    const recordDate = new Date(record.date);
                    return record.employeeId === employeeId &&
                           recordDate.getMonth() + 1 === month &&
                           recordDate.getFullYear() === year &&
                           record.status === 'Approved';
                });

                // Calculate total overtime hours
                const totalOvertimeHours = employeeOvertimeRecords.reduce((sum, record) => sum + record.hours, 0);

                // Calculate overtime pay: (total overtime hours  1.5  8)  (basic salary  30)
                const overtimePay = (totalOvertimeHours * 1.5 / 8) * (salaryRecord.basicSalary / 30);

                // Update the element
                element.textContent = overtimePay.toFixed(2);

                // Recalculate net salary
                calculateNetSalary(employeeId);
            });
        }

        // Function to calculate penalties for the selected month
        function calculatePenaltiesForMonth(month, year) {
            // For each employee, calculate penalties
            const penaltyElements = document.querySelectorAll('.penalties-days');

            penaltyElements.forEach(element => {
                const employeeId = element.getAttribute('data-employee-id');
                const employee = employees.find(emp => emp.id === employeeId);
                const salaryRecord = salaryRecords.find(sr => sr.employeeId === employeeId);

                if (!employee || !salaryRecord) return;

                // Get penalty records for this employee in the selected month
                const employeePenaltyRecords = penaltyRecords.filter(record => {
                    const recordDate = new Date(record.date);
                    return record.employeeId === employeeId &&
                           recordDate.getMonth() + 1 === month &&
                           recordDate.getFullYear() === year &&
                           record.status === 'Approved';
                });

                // Calculate total penalty days
                const totalPenaltyDays = employeePenaltyRecords.reduce((sum, record) => sum + parseFloat(record.days), 0);

                // Calculate penalty deduction: total penalties  (basic salary  30)
                const penaltyDeduction = totalPenaltyDays * (salaryRecord.basicSalary / 30);

                // Update the penalties/days element - use toFixed(2) to ensure we show exact fractions (0.25, 0.50, 0.75, etc.)
                element.textContent = totalPenaltyDays.toFixed(2);
                element.setAttribute('data-penalty-value', penaltyDeduction.toFixed(2));

                // Update the penalties (EGP) input field with the calculated value
                const penaltiesEgpInput = document.querySelector(`.penalties-egp[data-employee-id="${employeeId}"]`);
                if (penaltiesEgpInput) {
                    penaltiesEgpInput.value = penaltyDeduction.toFixed(2);
                }

                // Recalculate net salary
                calculateNetSalary(employeeId);
            });
        }

        // Function to add event listeners to payroll inputs
        function addPayrollInputEventListeners() {
            // Add event listeners to all input fields
            document.querySelectorAll('.fuel-allowance, .reward, .other-deductions').forEach(input => {
                input.addEventListener('input', function() {
                    const employeeId = this.getAttribute('data-employee-id');
                    calculateNetSalary(employeeId);
                    updatePayrollTotals();
                });
            });

            // Initial calculation
            updatePayrollTotals();
        }

        // Function to calculate net salary for an employee
        function calculateNetSalary(employeeId) {
            const salaryRecord = salaryRecords.find(sr => sr.employeeId === employeeId);
            if (!salaryRecord) return;

            // Get all the values
            const basicSalary = salaryRecord.basicSalary;
            const fixedAllowance = salaryRecord.fixedAllowance;
            const fixedDeduction = salaryRecord.fixedDeduction;

            // Get the input values
            const fuelAllowance = parseFloat(document.querySelector(`.fuel-allowance[data-employee-id="${employeeId}"]`).value) || 0;
            const reward = parseFloat(document.querySelector(`.reward[data-employee-id="${employeeId}"]`).value) || 0;
            const penaltiesEgp = parseFloat(document.querySelector(`.penalties-egp[data-employee-id="${employeeId}"]`).value) || 0;
            const otherDeductions = parseFloat(document.querySelector(`.other-deductions[data-employee-id="${employeeId}"]`).value) || 0;

            // Get the calculated values
            const overtime = parseFloat(document.querySelector(`.overtime-value[data-employee-id="${employeeId}"]`).textContent) || 0;

            // Calculate net salary
            const totalAllowances = fixedAllowance + fuelAllowance + reward + overtime;
            const totalDeductions = fixedDeduction + penaltiesEgp + otherDeductions;
            const netSalary = basicSalary + totalAllowances - totalDeductions;

            // Update the net salary element
            const netSalaryElement = document.querySelector(`.net-salary[data-employee-id="${employeeId}"]`);
            if (netSalaryElement) {
                netSalaryElement.textContent = netSalary.toFixed(2);
            }
        }

        // Function to update payroll totals
        function updatePayrollTotals() {
            // Get all the values
            let totalBasicSalary = 0;
            let totalFixedAllowance = 0;
            let totalFuelAllowance = 0;
            let totalReward = 0;
            let totalOvertime = 0;
            let totalFixedDeduction = 0;
            let totalPenaltiesDays = 0;
            let totalPenaltiesEgp = 0;
            let totalOtherDeductions = 0;
            let totalNetSalary = 0;

            // Get all employee rows
            const employeeRows = document.querySelectorAll('#payrollCalculationTableBody tr');

            employeeRows.forEach(row => {
                // Skip if it's a message row
                if (row.querySelector('td[colspan]')) return;

                // Get the values from the row
                totalBasicSalary += parseFloat(row.cells[2].textContent) || 0;
                totalFixedAllowance += parseFloat(row.cells[3].textContent) || 0;
                totalFuelAllowance += parseFloat(row.querySelector('.fuel-allowance')?.value) || 0;
                totalReward += parseFloat(row.querySelector('.reward')?.value) || 0;
                totalOvertime += parseFloat(row.querySelector('.overtime-value')?.textContent) || 0;
                totalFixedDeduction += parseFloat(row.cells[7].textContent) || 0;

                const penaltiesDaysElement = row.querySelector('.penalties-days');
                if (penaltiesDaysElement) {
                    totalPenaltiesDays += parseFloat(penaltiesDaysElement.textContent) || 0;
                }

                totalPenaltiesEgp += parseFloat(row.querySelector('.penalties-egp')?.value) || 0;
                totalOtherDeductions += parseFloat(row.querySelector('.other-deductions')?.value) || 0;
                totalNetSalary += parseFloat(row.querySelector('.net-salary')?.textContent) || 0;
            });

            // Update the totals row
            document.getElementById('total-basic-salary').textContent = totalBasicSalary.toFixed(2);
            document.getElementById('total-fixed-allowance').textContent = totalFixedAllowance.toFixed(2);
            document.getElementById('total-fuel-allowance').textContent = totalFuelAllowance.toFixed(2);
            document.getElementById('total-reward').textContent = totalReward.toFixed(2);
            document.getElementById('total-overtime').textContent = totalOvertime.toFixed(2);
            document.getElementById('total-fixed-deduction').textContent = totalFixedDeduction.toFixed(2);
            document.getElementById('total-penalties-days').textContent = totalPenaltiesDays.toFixed(2);
            document.getElementById('total-penalties-egp').textContent = totalPenaltiesEgp.toFixed(2);
            document.getElementById('total-other-deductions').textContent = totalOtherDeductions.toFixed(2);
            document.getElementById('total-net-salary').textContent = totalNetSalary.toFixed(2);
        }

        // Function to save payroll
        function savePayroll() {
            // Get the selected month and year
            const selectedMonth = parseInt(document.getElementById('payroll-month').value);
            const selectedYear = parseInt(document.getElementById('payroll-year').value);

            // Get all employee rows
            const employeeRows = document.querySelectorAll('#payrollCalculationTableBody tr');

            // Create payroll records
            const newPayrollRecords = [];

            employeeRows.forEach(row => {
                // Skip if it's a message row
                if (row.querySelector('td[colspan]')) return;

                // Get the employee ID
                const employeeId = row.cells[0].textContent;
                const employeeName = row.cells[1].textContent;

                // Get all the values
                const basicSalary = parseFloat(row.cells[2].textContent) || 0;
                const fixedAllowance = parseFloat(row.cells[3].textContent) || 0;
                const fuelAllowance = parseFloat(row.querySelector('.fuel-allowance')?.value) || 0;
                const reward = parseFloat(row.querySelector('.reward')?.value) || 0;
                const overtime = parseFloat(row.querySelector('.overtime-value')?.textContent) || 0;
                const fixedDeduction = parseFloat(row.cells[7].textContent) || 0;

                const penaltiesDaysElement = row.querySelector('.penalties-days');
                const penaltiesDays = parseFloat(penaltiesDaysElement?.textContent) || 0;

                const penaltiesEgp = parseFloat(row.querySelector('.penalties-egp')?.value) || 0;
                const otherDeductions = parseFloat(row.querySelector('.other-deductions')?.value) || 0;
                const netSalary = parseFloat(row.querySelector('.net-salary')?.textContent) || 0;

                // Create a payroll record
                const payrollRecord = {
                    id: Date.now() + Math.floor(Math.random() * 1000), // Generate a unique ID
                    month: selectedMonth,
                    year: selectedYear,
                    employeeId: employeeId,
                    employeeName: employeeName,
                    basicSalary: basicSalary,
                    fixedAllowance: fixedAllowance,
                    fuelAllowance: fuelAllowance,
                    reward: reward,
                    overtime: overtime,
                    fixedDeduction: fixedDeduction,
                    penaltiesDays: penaltiesDays,
                    penaltiesEgp: penaltiesEgp,
                    otherDeductions: otherDeductions,
                    netSalary: netSalary,
                    date: new Date().toISOString()
                };

                newPayrollRecords.push(payrollRecord);
            });

            // Add the new records to the payroll records
            payrollRecords = [...payrollRecords, ...newPayrollRecords];

            // Save to localStorage
            localStorage.setItem('hrSystemPayroll', JSON.stringify(payrollRecords));

            // Hide the payroll form container
            document.getElementById('payroll-form-container').classList.add('hidden');

            // Show success message
            showMessage('Payroll saved successfully!');

            // Populate the payroll history table
            populatePayrollHistoryTable();
        }

        // Function to populate the payroll history table
        function populatePayrollHistoryTable(monthFilter = 'all', yearFilter = 'all') {
            const tableBody = document.getElementById('payrollHistoryTableBody');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            // Check if filter is active and update button state
            const isFilterActive = monthFilter !== 'all' || yearFilter !== 'all';
            const filterBtn = document.getElementById('payroll-history-filter-btn');
            const filterBtnText = document.getElementById('filter-btn-text');

            if (filterBtn) {
                if (isFilterActive) {
                    filterBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    filterBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    if (filterBtnText) filterBtnText.textContent = 'Clear Filters';
                } else {
                    filterBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    filterBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    if (filterBtnText) filterBtnText.textContent = 'Apply Filters';
                }
            }

            // Filter records based on month and year
            let filteredRecords = [...payrollRecords];

            if (monthFilter !== 'all') {
                filteredRecords = filteredRecords.filter(record => record.month === parseInt(monthFilter));
            }

            if (yearFilter !== 'all') {
                filteredRecords = filteredRecords.filter(record => record.year === parseInt(yearFilter));
            }

            // Sort by date (newest first)
            filteredRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filteredRecords.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-gray-500">No payroll records found.</td></tr>';
                return;
            }

            // Populate the table
            filteredRecords.forEach(record => {
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                const monthName = monthNames[record.month - 1];

                const totalAllowances = record.fixedAllowance + record.fuelAllowance + record.reward + record.overtime;
                const totalDeductions = record.fixedDeduction + record.penaltiesEgp + record.otherDeductions;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150';
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${monthName} ${record.year}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${record.employeeId}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${record.employeeName}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${record.basicSalary.toFixed(2)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${totalAllowances.toFixed(2)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${totalDeductions.toFixed(2)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${record.netSalary.toFixed(2)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="viewPayrollDetails('${record.id}')" class="text-indigo-600 hover:text-indigo-900" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="deletePayrollRecord('${record.id}')" class="text-red-600 hover:text-red-900" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

        // Function to export payroll data to Excel
        function exportPayrollToExcel() {
            // Get the selected month and year
            const selectedMonth = parseInt(document.getElementById('payroll-month').value);
            const selectedYear = parseInt(document.getElementById('payroll-year').value);

            // Get active employees with salary records
            const activeEmployees = employees.filter(emp => emp.status === 'Active');
            const employeesWithSalary = activeEmployees.filter(emp => {
                return salaryRecords.some(sr => sr.employeeId === emp.id);
            });

            if (employeesWithSalary.length === 0) {
                showMessage('No active employees with salary records found.', 'error');
                return;
            }

            // Create data array for Excel
            const data = [];

            // Add header row
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const monthName = monthNames[selectedMonth - 1];
            data.push([`Payroll for ${monthName} ${selectedYear}`]);
            data.push([]);  // Empty row
            data.push([
                'Code',
                'Name',
                'Basic Salary',
                'Fixed Allowance',
                'Fuel Allowance',
                'Reward (EGP)',
                'Overtime',
                'Fixed Deduction',
                'Penalties/Days',
                'Penalties (EGP)',
                'Other Deductions',
                'Net Salary'
            ]);

            // Process each employee
            employeesWithSalary.forEach(employee => {
                const salaryRecord = salaryRecords.find(sr => sr.employeeId === employee.id);
                if (!salaryRecord) return;

                // Calculate overtime
                const employeeOvertimeRecords = overtimeRecords.filter(record => {
                    const recordDate = new Date(record.date);
                    return record.employeeId === employee.id &&
                           recordDate.getMonth() + 1 === selectedMonth &&
                           recordDate.getFullYear() === selectedYear &&
                           record.status === 'Approved';
                });

                const totalOvertimeHours = employeeOvertimeRecords.reduce((sum, record) => sum + record.hours, 0);
                const overtimePay = (totalOvertimeHours * 1.5 / 8) * (salaryRecord.basicSalary / 30);

                // Calculate penalties
                const employeePenaltyRecords = penaltyRecords.filter(record => {
                    const recordDate = new Date(record.date);
                    return record.employeeId === employee.id &&
                           recordDate.getMonth() + 1 === selectedMonth &&
                           recordDate.getFullYear() === selectedYear &&
                           record.status === 'Approved';
                });

                const totalPenaltyDays = employeePenaltyRecords.reduce((sum, record) => sum + parseFloat(record.days), 0);
                const penaltyDeduction = totalPenaltyDays * (salaryRecord.basicSalary / 30);

                // Default values for manual entries
                const fuelAllowance = 0;
                const reward = 0;
                const otherDeductions = 0;

                // Calculate net salary
                const totalAllowances = salaryRecord.fixedAllowance + fuelAllowance + reward + overtimePay;
                const totalDeductions = salaryRecord.fixedDeduction + penaltyDeduction + otherDeductions;
                const netSalary = salaryRecord.basicSalary + totalAllowances - totalDeductions;

                // Add employee row
                data.push([
                    employee.id,
                    employee.fullName,
                    salaryRecord.basicSalary.toFixed(2),
                    salaryRecord.fixedAllowance.toFixed(2),
                    fuelAllowance.toFixed(2),
                    reward.toFixed(2),
                    overtimePay.toFixed(2),
                    salaryRecord.fixedDeduction.toFixed(2),
                    totalPenaltyDays.toFixed(2), // Ensure we show exact fractions (0.25, 0.50, 0.75, etc.)
                    penaltyDeduction.toFixed(2),
                    otherDeductions.toFixed(2),
                    netSalary.toFixed(2)
                ]);
            });

            // Calculate totals
            const totals = [
                'TOTALS',
                '',
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[2]), 0).toFixed(2),
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[3]), 0).toFixed(2),
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[4]), 0).toFixed(2),
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[5]), 0).toFixed(2),
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[6]), 0).toFixed(2),
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[7]), 0).toFixed(2),
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[8]), 0).toFixed(2),
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[9]), 0).toFixed(2),
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[10]), 0).toFixed(2),
                data.slice(3).reduce((sum, row) => sum + parseFloat(row[11]), 0).toFixed(2)
            ];

            data.push(totals);

            // Convert data to CSV
            let csvContent = "data:text/csv;charset=utf-8,";

            data.forEach(row => {
                const csvRow = row.join(',');
                csvContent += csvRow + '\r\n';
            });

            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Payroll_${monthName}_${selectedYear}.csv`);
            document.body.appendChild(link);

            // Trigger download
            link.click();
            document.body.removeChild(link);

            showMessage(`Payroll data for ${monthName} ${selectedYear} exported successfully!`);
        }

        // Function to view payroll details
        function viewPayrollDetails(recordId) {
            // Find the record
            const record = payrollRecords.find(r => r.id == recordId);
            if (!record) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Show the details in a modal or alert for now
            alert(`Payroll Details for ${record.employeeName} (${record.employeeId})
Month/Year: ${record.month}/${record.year}
Basic Salary: ${record.basicSalary.toFixed(2)}
Fixed Allowance: ${record.fixedAllowance.toFixed(2)}
Fuel Allowance: ${record.fuelAllowance.toFixed(2)}
Reward: ${record.reward.toFixed(2)}
Overtime: ${record.overtime.toFixed(2)}
Fixed Deduction: ${record.fixedDeduction.toFixed(2)}
Penalties (Days): ${record.penaltiesDays.toFixed(2)} // Ensure we show exact fractions (0.25, 0.50, 0.75, etc.)
Penalties (EGP): ${record.penaltiesEgp.toFixed(2)}
Other Deductions: ${record.otherDeductions.toFixed(2)}
Net Salary: ${record.netSalary.toFixed(2)}`);
        }

        // Function to delete payroll record
        function deletePayrollRecord(recordId) {
            if (!confirm('Are you sure you want to delete this payroll record?')) {
                return;
            }

            // Find the record index
            const recordIndex = payrollRecords.findIndex(r => r.id == recordId);
            if (recordIndex === -1) {
                showMessage('Record not found.', 'error');
                return;
            }

            // Remove the record
            payrollRecords.splice(recordIndex, 1);

            // Save to localStorage
            localStorage.setItem('hrSystemPayroll', JSON.stringify(payrollRecords));

            // Update the UI
            populatePayrollHistoryTable();

            // Show success message
            showMessage('Payroll record deleted successfully.');
        }

        // Add event listeners for payroll functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Populate year dropdowns
            populatePayrollYearDropdowns();

            // Set current month in the dropdown
            const currentMonth = new Date().getMonth() + 1; // 1-12
            const payrollMonthDropdown = document.getElementById('payroll-month');
            if (payrollMonthDropdown) {
                payrollMonthDropdown.value = currentMonth;
            }

            // Add event listener to run payroll button
            const runPayrollBtn = document.getElementById('run-payroll-btn');
            if (runPayrollBtn) {
                runPayrollBtn.addEventListener('click', runPayroll);
            }

            // Add event listener to export payroll button
            const exportPayrollBtn = document.getElementById('export-payroll-btn');
            if (exportPayrollBtn) {
                exportPayrollBtn.addEventListener('click', exportPayrollToExcel);
            }

            // Add event listener to save payroll button
            const savePayrollBtn = document.getElementById('save-payroll-btn');
            if (savePayrollBtn) {
                savePayrollBtn.addEventListener('click', savePayroll);
            }

            // Add event listener to cancel payroll button
            const cancelPayrollBtn = document.getElementById('cancel-payroll-btn');
            if (cancelPayrollBtn) {
                cancelPayrollBtn.addEventListener('click', function() {
                    document.getElementById('payroll-form-container').classList.add('hidden');
                });
            }

            // Add event listener to payroll history filter button
            const payrollHistoryFilterBtn = document.getElementById('payroll-history-filter-btn');
            if (payrollHistoryFilterBtn) {
                // Track filter state
                let filterActive = false;

                payrollHistoryFilterBtn.addEventListener('click', function() {
                    const monthFilter = document.getElementById('payroll-history-month').value;
                    const yearFilter = document.getElementById('payroll-history-year').value;
                    const filterBtnText = document.getElementById('filter-btn-text');

                    // Toggle filter state
                    filterActive = !filterActive;

                    if (filterActive) {
                        // Apply filter
                        populatePayrollHistoryTable(monthFilter, yearFilter);

                        // Change button color to red and update text
                        this.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                        this.classList.add('bg-red-600', 'hover:bg-red-700');
                        filterBtnText.textContent = 'Clear Filters';
                    } else {
                        // Clear filter
                        document.getElementById('payroll-history-month').value = 'all';
                        document.getElementById('payroll-history-year').value = 'all';
                        populatePayrollHistoryTable('all', 'all');

                        // Restore original button color and text
                        this.classList.remove('bg-red-600', 'hover:bg-red-700');
                        this.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                        filterBtnText.textContent = 'Apply Filters';
                    }
                });
            }

            // Load payroll records from localStorage
            const savedPayrollRecords = localStorage.getItem('hrSystemPayroll');
            if (savedPayrollRecords) {
                payrollRecords = JSON.parse(savedPayrollRecords);
            }

            // Populate the payroll history table
            populatePayrollHistoryTable();
        });
    </script>

</body>
</html>
